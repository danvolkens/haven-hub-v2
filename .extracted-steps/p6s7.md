## Step 8.4: Create Design Templates System

- **Task**: Create templates for pre-designed quote layouts.

- **Files**:

### `supabase/migrations/006a_templates.sql`
```sql
-- ============================================================================
-- Migration: 006a_templates
-- Description: Design templates for pre-built layouts
-- Feature: 7.4 (Templates Schema)
-- ============================================================================

CREATE TABLE design_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- Template Info
  name TEXT NOT NULL,
  description TEXT,
  preview_url TEXT,
  
  -- Template Type
  type TEXT NOT NULL DEFAULT 'quote' CHECK (type IN ('quote', 'product', 'announcement')),
  category TEXT, -- 'minimal', 'bold', 'elegant', 'playful'
  
  -- Design Configuration
  layout JSONB NOT NULL DEFAULT '{}',
  -- {
  --   text_position: 'center' | 'top' | 'bottom' | 'left' | 'right',
  --   text_alignment: 'center' | 'left' | 'right',
  --   padding: { top, right, bottom, left },
  --   attribution_position: 'below' | 'inline' | 'hidden'
  -- }
  
  typography JSONB NOT NULL DEFAULT '{}',
  -- {
  --   font_family: string,
  --   font_size_scale: number (0.5 - 2.0),
  --   line_height: number,
  --   letter_spacing: number,
  --   text_transform: 'none' | 'uppercase' | 'lowercase'
  -- }
  
  colors JSONB NOT NULL DEFAULT '{}',
  -- {
  --   background: string,
  --   text: string,
  --   accent: string,
  --   gradient: { from, to, direction }
  -- }
  
  decorations JSONB NOT NULL DEFAULT '{}',
  -- {
  --   border: { width, color, radius },
  --   shadow: { x, y, blur, color },
  --   overlay: { color, opacity }
  -- }
  
  -- Compatibility
  compatible_formats TEXT[] DEFAULT '{}',
  compatible_moods TEXT[] DEFAULT '{}',
  
  -- Status
  is_system BOOLEAN NOT NULL DEFAULT false,
  is_active BOOLEAN NOT NULL DEFAULT true,
  
  -- Usage Stats
  usage_count INTEGER NOT NULL DEFAULT 0,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_templates_user ON design_templates(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_templates_type ON design_templates(type, category);
CREATE INDEX idx_templates_system ON design_templates(is_system) WHERE is_system = true;

-- RLS
ALTER TABLE design_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY templates_select ON design_templates FOR SELECT 
  USING (is_system = true OR user_id = auth.uid());

CREATE POLICY templates_insert ON design_templates FOR INSERT 
  WITH CHECK (user_id = auth.uid());

CREATE POLICY templates_update ON design_templates FOR UPDATE 
  USING (user_id = auth.uid() AND is_system = false);

CREATE POLICY templates_delete ON design_templates FOR DELETE 
  USING (user_id = auth.uid() AND is_system = false);

-- Trigger
CREATE TRIGGER templates_updated_at BEFORE UPDATE ON design_templates
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Seed system templates
INSERT INTO design_templates (is_system, name, description, type, category, layout, typography, colors, compatible_formats, compatible_moods) VALUES
(true, 'Minimal Center', 'Clean centered text on solid background', 'quote', 'minimal', 
  '{"text_position": "center", "text_alignment": "center", "padding": {"top": 80, "right": 60, "bottom": 80, "left": 60}}',
  '{"font_family": "Playfair Display", "font_size_scale": 1.0, "line_height": 1.4}',
  '{"background": "#ffffff", "text": "#1a1a1a"}',
  ARRAY['instagram_square', 'pinterest_pin'], ARRAY['calm', 'thoughtful', 'elegant']),

(true, 'Bold Impact', 'Large bold text with high contrast', 'quote', 'bold',
  '{"text_position": "center", "text_alignment": "center", "padding": {"top": 60, "right": 40, "bottom": 60, "left": 40}}',
  '{"font_family": "Montserrat", "font_size_scale": 1.3, "text_transform": "uppercase", "letter_spacing": 2}',
  '{"background": "#1a1a1a", "text": "#ffffff"}',
  ARRAY['instagram_square', 'instagram_story'], ARRAY['bold', 'powerful', 'motivational']),

(true, 'Elegant Script', 'Sophisticated script font styling', 'quote', 'elegant',
  '{"text_position": "center", "text_alignment": "center", "padding": {"top": 100, "right": 80, "bottom": 100, "left": 80}}',
  '{"font_family": "Dancing Script", "font_size_scale": 1.1, "line_height": 1.6}',
  '{"background": "#f5f0eb", "text": "#2d2d2d", "accent": "#b8860b"}',
  ARRAY['pinterest_pin', 'instagram_square'], ARRAY['romantic', 'elegant', 'soft']),

(true, 'Nature Overlay', 'Text with semi-transparent overlay', 'quote', 'playful',
  '{"text_position": "bottom", "text_alignment": "left", "padding": {"top": 40, "right": 40, "bottom": 60, "left": 40}}',
  '{"font_family": "Lora", "font_size_scale": 0.9}',
  '{"background": "#4a5568", "text": "#ffffff"}',
  ARRAY['instagram_square', 'facebook_post'], ARRAY['nature', 'peaceful', 'thoughtful']);
```

### `types/templates.ts`
```typescript
export interface DesignTemplate {
  id: string;
  user_id?: string;
  name: string;
  description?: string;
  preview_url?: string;
  type: 'quote' | 'product' | 'announcement';
  category?: string;
  layout: TemplateLayout;
  typography: TemplateTypography;
  colors: TemplateColors;
  decorations: TemplateDecorations;
  compatible_formats: string[];
  compatible_moods: string[];
  is_system: boolean;
  is_active: boolean;
  usage_count: number;
  created_at: string;
  updated_at: string;
}

export interface TemplateLayout {
  text_position: 'center' | 'top' | 'bottom' | 'left' | 'right';
  text_alignment: 'center' | 'left' | 'right';
  padding: { top: number; right: number; bottom: number; left: number };
  attribution_position?: 'below' | 'inline' | 'hidden';
}

export interface TemplateTypography {
  font_family: string;
  font_size_scale: number;
  line_height?: number;
  letter_spacing?: number;
  text_transform?: 'none' | 'uppercase' | 'lowercase';
}

export interface TemplateColors {
  background: string;
  text: string;
  accent?: string;
  gradient?: { from: string; to: string; direction: string };
}

export interface TemplateDecorations {
  border?: { width: number; color: string; radius: number };
  shadow?: { x: number; y: number; blur: number; color: string };
  overlay?: { color: string; opacity: number };
}
```

### `app/api/templates/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function GET(request: NextRequest) {
  const supabase = createClient();
  
  const { data: { user } } = await supabase.auth.getUser();

  const searchParams = request.nextUrl.searchParams;
  const type = searchParams.get('type');
  const category = searchParams.get('category');

  let query = supabase
    .from('design_templates')
    .select('*')
    .eq('is_active', true)
    .order('is_system', { ascending: false })
    .order('usage_count', { ascending: false });

  // Include system templates + user's templates
  if (user) {
    query = query.or(`is_system.eq.true,user_id.eq.${user.id}`);
  } else {
    query = query.eq('is_system', true);
  }

  if (type) query = query.eq('type', type);
  if (category) query = query.eq('category', category);

  const { data: templates, error } = await query;

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ templates });
}

export async function POST(request: NextRequest) {
  const supabase = createClient();
  
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const body = await request.json();

  const { data: template, error } = await supabase
    .from('design_templates')
    .insert({
      user_id: user.id,
      name: body.name,
      description: body.description,
      type: body.type || 'quote',
      category: body.category,
      layout: body.layout || {},
      typography: body.typography || {},
      colors: body.colors || {},
      decorations: body.decorations || {},
      compatible_formats: body.compatible_formats || [],
      compatible_moods: body.compatible_moods || [],
    })
    .select()
    .single();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ template }, { status: 201 });
}
```

- **Step Dependencies**: Step 8.3
- **User Instructions**: Run migration `006a_templates.sql`

---

