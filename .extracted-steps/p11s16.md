## Step 24.6: Create Integration Tests & Documentation

- **Task**: Set up testing infrastructure and API documentation.

- **Files**:

### `tests/setup.ts`
```typescript
import { beforeAll, afterAll, afterEach } from 'vitest';
import { createClient } from '@supabase/supabase-js';

// Test database client
export const testSupabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

// Test user
export const TEST_USER_ID = 'test-user-id';
export const TEST_USER_EMAIL = 'test@example.com';

beforeAll(async () => {
  // Set up test data
  await testSupabase.from('user_settings').upsert({
    user_id: TEST_USER_ID,
    email: TEST_USER_EMAIL,
    first_name: 'Test',
    last_name: 'User',
  });
});

afterAll(async () => {
  // Clean up test data
  await testSupabase.from('user_settings').delete().eq('user_id', TEST_USER_ID);
});

afterEach(() => {
  // Reset mocks
});
```

### `tests/integration/api/coupons.test.ts`
```typescript
import { describe, it, expect, vi } from 'vitest';
import { createMocks } from 'node-mocks-http';
import { GET, POST } from '@/app/api/coupons/route';
import { TEST_USER_ID } from '../../setup';

// Mock Supabase auth
vi.mock('@/lib/supabase/server', () => ({
  createClient: () => ({
    auth: {
      getUser: () => Promise.resolve({
        data: { user: { id: TEST_USER_ID } },
        error: null,
      }),
    },
    from: (table: string) => ({
      select: () => ({
        eq: () => ({
          order: () => Promise.resolve({ data: [], error: null }),
        }),
      }),
      insert: (data: any) => ({
        select: () => ({
          single: () => Promise.resolve({
            data: { id: 'new-id', ...data },
            error: null,
          }),
        }),
      }),
    }),
  }),
}));

describe('Coupons API', () => {
  describe('GET /api/coupons', () => {
    it('returns list of coupons', async () => {
      const { req } = createMocks({
        method: 'GET',
      });

      const response = await GET(req as any);
      const data = await response.json();

      expect(response.status).toBe(200);
      expect(data).toHaveProperty('coupons');
      expect(Array.isArray(data.coupons)).toBe(true);
    });
  });

  describe('POST /api/coupons', () => {
    it('creates a new coupon', async () => {
      const { req } = createMocks({
        method: 'POST',
        body: {
          code: 'TEST20',
          discount_type: 'percentage',
          discount_value: 20,
        },
      });

      // Mock request.json()
      req.json = () => Promise.resolve({
        code: 'TEST20',
        discount_type: 'percentage',
        discount_value: 20,
      });

      const response = await POST(req as any);
      const data = await response.json();

      expect(response.status).toBe(201);
      expect(data.coupon).toBeDefined();
      expect(data.coupon.code).toBe('TEST20');
    });

    it('validates coupon code format', async () => {
      const { req } = createMocks({
        method: 'POST',
        body: {
          code: 'invalid code!',
          discount_type: 'percentage',
        },
      });

      req.json = () => Promise.resolve({
        code: 'invalid code!',
        discount_type: 'percentage',
      });

      const response = await POST(req as any);
      
      expect(response.status).toBe(400);
    });
  });
});
```

### `tests/integration/api/leads.test.ts`
```typescript
import { describe, it, expect, vi } from 'vitest';
import { createMocks } from 'node-mocks-http';
import { validateInput, createLeadSchema } from '@/lib/validation/schemas';

describe('Lead Validation', () => {
  it('validates correct lead data', () => {
    const result = validateInput(createLeadSchema, {
      email: 'test@example.com',
      firstName: 'Test',
    });

    expect(result.success).toBe(true);
  });

  it('rejects invalid email', () => {
    const result = validateInput(createLeadSchema, {
      email: 'not-an-email',
    });

    expect(result.success).toBe(false);
    if (!result.success) {
      expect(result.errors).toContain('email: Invalid email address');
    }
  });

  it('accepts optional fields', () => {
    const result = validateInput(createLeadSchema, {
      email: 'test@example.com',
      utmSource: 'google',
      utmMedium: 'cpc',
      utmCampaign: 'spring-sale',
    });

    expect(result.success).toBe(true);
  });
});
```

### `docs/API.md`
```markdown
# Haven Hub API Documentation

## Authentication

All API endpoints require authentication via Supabase Auth. Include the session cookie or Authorization header with your requests.

## Rate Limits

- General API: 100 requests per 10 seconds
- Authentication: 5 attempts per minute
- Webhooks: 1000 per minute
- Public forms: 10 per minute per IP

Rate limit headers are included in all responses:
- `X-RateLimit-Limit`: Maximum requests allowed
- `X-RateLimit-Remaining`: Requests remaining
- `X-RateLimit-Reset`: Unix timestamp when limit resets

## Endpoints

### Leads

#### GET /api/leads
List all leads with optional filtering.

**Query Parameters:**
- `page` (number): Page number (default: 1)
- `limit` (number): Items per page (default: 20, max: 100)
- `segment` (string): Filter by segment
- `source` (string): Filter by source
- `startDate` (ISO date): Filter by created date
- `endDate` (ISO date): Filter by created date

**Response:**
```json
{
  "leads": [...],
  "total": 100,
  "page": 1,
  "limit": 20
}
```

#### POST /api/leads
Create a new lead.

**Body:**
```json
{
  "email": "user@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "source": "quiz",
  "utmSource": "google",
  "utmMedium": "cpc",
  "utmCampaign": "spring"
}
```

### Coupons

#### GET /api/coupons
List all coupons.

**Query Parameters:**
- `status` (string): Filter by status (active, draft, paused, expired, depleted)
- `stats` (boolean): Include aggregate statistics

#### POST /api/coupons
Create a new coupon.

**Body:**
```json
{
  "code": "SUMMER20",
  "discountType": "percentage",
  "discountValue": 20,
  "usageLimit": 100,
  "perCustomerLimit": 1,
  "minimumPurchase": 50,
  "expiresAt": "2024-12-31T23:59:59Z"
}
```

### Popups

#### GET /api/popups
List all popups.

#### POST /api/popups
Create a new popup.

**Body:**
```json
{
  "name": "Exit Intent Popup",
  "triggerType": "exit_intent",
  "content": {
    "type": "email_capture",
    "headline": "Wait! Don't go!",
    "body": "Get 10% off your first order",
    "ctaText": "Get My Discount"
  },
  "position": "center"
}
```

### Webhooks

#### POST /api/webhooks/shopify
Handle Shopify webhooks. Requires HMAC verification.

#### POST /api/webhooks/klaviyo
Handle Klaviyo webhooks.

## Error Responses

All errors follow this format:
```json
{
  "error": "Error message",
  "code": "ERROR_CODE",
  "details": {}
}
```

Common error codes:
- `UNAUTHORIZED`: Missing or invalid authentication
- `FORBIDDEN`: Insufficient permissions
- `NOT_FOUND`: Resource not found
- `VALIDATION_ERROR`: Invalid input data
- `RATE_LIMITED`: Too many requests
- `INTERNAL_ERROR`: Server error
```

### `vitest.config.ts`
```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./tests/setup.ts'],
    include: ['tests/**/*.test.ts', 'tests/**/*.test.tsx'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'tests/',
        '**/*.d.ts',
        '**/*.config.*',
      ],
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './'),
    },
  },
});
```

### `package.json` (add test scripts)
```json
{
  "scripts": {
    "test": "vitest",
    "test:coverage": "vitest run --coverage",
    "test:ui": "vitest --ui"
  },
  "devDependencies": {
    "vitest": "^1.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "node-mocks-http": "^1.13.0",
    "@vitest/coverage-v8": "^1.0.0",
    "@vitest/ui": "^1.0.0"
  }
}
```

- **Step Dependencies**: Step 24.5
- **User Instructions**: Run `npm install -D vitest @vitejs/plugin-react node-mocks-http @vitest/coverage-v8 @vitest/ui`

---

**Part 11 Summary**

This part covers:

**Phase 20 (Attribution Tracking):**
- Attribution events table for tracking all customer touchpoints
- Content performance aggregation by day/week/month
- Multiple attribution models (first-touch, last-touch, linear, time-decay, position-based)
- Revenue attribution split across touchpoints
- Attribution service for event tracking and revenue calculation
- Top performing content identification

**Phase 21 (Seasonal Campaigns):**
- Campaigns table with full lifecycle management
- Campaign tasks for scheduled activities
- Seasonal templates with pre-configured holiday campaigns
- Campaign scheduling with automatic task creation
- Task execution service for pins, emails, and ads
- Campaign performance tracking with goal progress
- **Content Calendar UI** with unified view of all scheduled content
- **Link-in-Bio System** with branded pages and click tracking
- **Cross-Platform Winners** for tracking and adapting content from other platforms

**Phase 22 (AI Intelligence Engine):**
- Insights table for AI-generated observations
- Recommendations table with actionable suggestions
- Analysis jobs tracking for background processing
- Intelligence service using pattern analysis
- Performance insights (top pins, collection analysis)
- Customer insights (at-risk detection)
- Posting time and content recommendations

**Phase 23 (Daily Digest):**
- Digest preferences with delivery customization
- Digest history for engagement tracking
- Digest content generation aggregating all metrics
- Email delivery integration
- Scheduled digest processing
- Daily analysis Trigger.dev task

**Phase 24 (Polish & Optimization):**
- **Command Palette (âŒ˜K)** for quick navigation
- **Dashboard Home Page** with stats, quick actions, and widgets
- **Rate Limiting** using Upstash Redis
- **Security Headers** and input validation with Zod
- **Performance Caching** with Redis cache layer
- **Accessibility** features (skip links, focus traps, ARIA)
- **Integration Tests** with Vitest
- **API Documentation**

---

**Implementation 100% Complete!**

All 24 phases are now documented with:
- Database migrations (20+ tables)
- TypeScript types for all entities
- Service implementations
- API endpoints
- UI components (React with TanStack Query)
- Trigger.dev tasks for background processing
- Rate limiting and caching
- Accessibility compliance
- Testing infrastructure

**Total Migrations:** 24
**Total Features:** 96+ steps (per original spec)
