## Step 16.1: Create Abandonment Database Schema

- **Task**: Create database schema for tracking cart abandonments and triggering sequences.

- **Files**:

### `supabase/migrations/013_abandonment.sql`
```sql
-- ============================================================================
-- Migration: 013_abandonment
-- Description: Cart abandonment tracking and sequences
-- Feature: 16 (Cart Abandonment)
-- ============================================================================

-- ============================================================================
-- Abandoned Checkouts Table
-- ============================================================================
CREATE TABLE abandoned_checkouts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Shopify references
  shopify_checkout_id TEXT NOT NULL,
  shopify_checkout_token TEXT,
  
  -- Customer info
  email TEXT NOT NULL,
  customer_id TEXT, -- Shopify customer ID if known
  lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,
  
  -- Cart details
  cart_total NUMERIC(10,2) NOT NULL,
  cart_items JSONB NOT NULL DEFAULT '[]',
  -- [{ product_id, variant_id, title, quantity, price, image_url }]
  
  -- Checkout state
  checkout_url TEXT,
  
  -- Timing
  abandoned_at TIMESTAMPTZ NOT NULL,
  
  -- Recovery status
  status TEXT NOT NULL DEFAULT 'abandoned' CHECK (status IN (
    'abandoned',    -- Cart was abandoned
    'sequence_triggered', -- Klaviyo sequence started
    'recovered',    -- Customer completed purchase
    'expired'       -- Recovery window expired
  )),
  
  -- Sequence tracking
  sequence_triggered_at TIMESTAMPTZ,
  klaviyo_flow_id TEXT,
  
  -- Recovery tracking
  recovered_at TIMESTAMPTZ,
  recovered_order_id TEXT,
  recovered_order_total NUMERIC(10,2),
  
  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, shopify_checkout_id)
);

-- ============================================================================
-- Abandonment Sequences Table (recovery email configuration)
-- ============================================================================
CREATE TABLE abandonment_sequences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Sequence details
  name TEXT NOT NULL,
  
  -- Timing configuration
  trigger_delay_hours INTEGER NOT NULL DEFAULT 1, -- Hours after abandonment
  
  -- Klaviyo integration
  klaviyo_flow_id TEXT NOT NULL,
  
  -- Conditions
  min_cart_value NUMERIC(10,2) DEFAULT 0,
  max_cart_value NUMERIC(10,2),
  
  -- Collections to target (empty = all)
  target_collections TEXT[] DEFAULT '{}',
  
  -- Status
  is_active BOOLEAN NOT NULL DEFAULT true,
  
  -- Performance
  checkouts_triggered INTEGER NOT NULL DEFAULT 0,
  checkouts_recovered INTEGER NOT NULL DEFAULT 0,
  revenue_recovered NUMERIC(12,2) NOT NULL DEFAULT 0,
  recovery_rate NUMERIC(5,4) GENERATED ALWAYS AS (
    CASE WHEN checkouts_triggered > 0 
      THEN checkouts_recovered::NUMERIC / checkouts_triggered 
      ELSE 0 
    END
  ) STORED,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_abandoned_checkouts_user ON abandoned_checkouts(user_id);
CREATE INDEX idx_abandoned_checkouts_email ON abandoned_checkouts(user_id, email);
CREATE INDEX idx_abandoned_checkouts_status ON abandoned_checkouts(user_id, status);
CREATE INDEX idx_abandoned_checkouts_abandoned ON abandoned_checkouts(user_id, abandoned_at)
  WHERE status = 'abandoned';
CREATE INDEX idx_abandoned_checkouts_shopify ON abandoned_checkouts(shopify_checkout_id);

CREATE INDEX idx_sequences_user ON abandonment_sequences(user_id);
CREATE INDEX idx_sequences_active ON abandonment_sequences(user_id, is_active)
  WHERE is_active = true;

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE abandoned_checkouts ENABLE ROW LEVEL SECURITY;
ALTER TABLE abandonment_sequences ENABLE ROW LEVEL SECURITY;

CREATE POLICY checkouts_all ON abandoned_checkouts FOR ALL USING (user_id = auth.uid());
CREATE POLICY sequences_all ON abandonment_sequences FOR ALL USING (user_id = auth.uid());

CREATE TRIGGER checkouts_updated_at BEFORE UPDATE ON abandoned_checkouts
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER sequences_updated_at BEFORE UPDATE ON abandonment_sequences
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Get checkouts ready for sequence trigger
-- ============================================================================
CREATE OR REPLACE FUNCTION get_checkouts_for_sequence(
  p_user_id UUID,
  p_window_hours INTEGER DEFAULT 1
)
RETURNS TABLE (
  checkout_id UUID,
  email TEXT,
  cart_total NUMERIC,
  cart_items JSONB,
  checkout_url TEXT,
  sequence_id UUID,
  klaviyo_flow_id TEXT
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    ac.id AS checkout_id,
    ac.email,
    ac.cart_total,
    ac.cart_items,
    ac.checkout_url,
    seq.id AS sequence_id,
    seq.klaviyo_flow_id
  FROM abandoned_checkouts ac
  CROSS JOIN abandonment_sequences seq
  WHERE ac.user_id = p_user_id
    AND seq.user_id = p_user_id
    AND ac.status = 'abandoned'
    AND seq.is_active = true
    AND ac.abandoned_at <= NOW() - (seq.trigger_delay_hours || ' hours')::INTERVAL
    AND ac.cart_total >= COALESCE(seq.min_cart_value, 0)
    AND (seq.max_cart_value IS NULL OR ac.cart_total <= seq.max_cart_value)
    AND NOT EXISTS (
      -- Check if already triggered for any sequence
      SELECT 1 FROM abandoned_checkouts ac2
      WHERE ac2.id = ac.id AND ac2.sequence_triggered_at IS NOT NULL
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### `types/abandonment.ts`
```typescript
export interface AbandonedCheckout {
  id: string;
  user_id: string;
  shopify_checkout_id: string;
  shopify_checkout_token: string | null;
  email: string;
  customer_id: string | null;
  lead_id: string | null;
  cart_total: number;
  cart_items: CartItem[];
  checkout_url: string | null;
  abandoned_at: string;
  status: AbandonmentStatus;
  sequence_triggered_at: string | null;
  klaviyo_flow_id: string | null;
  recovered_at: string | null;
  recovered_order_id: string | null;
  recovered_order_total: number | null;
  created_at: string;
  updated_at: string;
}

export type AbandonmentStatus = 'abandoned' | 'sequence_triggered' | 'recovered' | 'expired';

export interface CartItem {
  product_id: string;
  variant_id: string;
  title: string;
  quantity: number;
  price: number;
  image_url?: string;
}

export interface AbandonmentSequence {
  id: string;
  user_id: string;
  name: string;
  trigger_delay_hours: number;
  klaviyo_flow_id: string;
  min_cart_value: number | null;
  max_cart_value: number | null;
  target_collections: string[];
  is_active: boolean;
  checkouts_triggered: number;
  checkouts_recovered: number;
  revenue_recovered: number;
  recovery_rate: number;
  created_at: string;
  updated_at: string;
}
```

- **Step Dependencies**: Step 14.1
- **User Instructions**: Run migration

---

