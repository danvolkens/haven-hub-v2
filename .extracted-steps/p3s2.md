## Step 2.5: Set Up Trigger.dev Client and Configuration

- **Task**: Configure Trigger.dev for background job processing with client setup and job definitions.

- **Files**:

### `trigger.config.ts`
```typescript
import { defineConfig } from '@trigger.dev/sdk/v3';

export default defineConfig({
  project: 'haven-hub',
  runtime: 'node',
  logLevel: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
  
  // Default retry configuration
  retries: {
    enabledInDev: false,
    default: {
      maxAttempts: 3,
      minTimeoutInMs: 1000,
      maxTimeoutInMs: 30000,
      factor: 2,
    },
  },
  
  // Task directories
  dirs: ['./trigger'],
  
  // Machine configuration
  machine: 'small-1x',
  
  // Max duration for tasks
  maxDuration: 300, // 5 minutes
});
```

### `lib/trigger/client.ts`
```typescript
import { tasks } from '@trigger.dev/sdk/v3';

// Type-safe task trigger functions

export interface DesignEnginePayload {
  quoteId: string;
  userId: string;
  outputFormats: string[];
  generateMockups: boolean;
}

export interface MockupGeneratorPayload {
  quoteId: string;
  userId: string;
  assetIds: string[];
  scenes: string[];
}

export interface WinnerRefreshPayload {
  userId: string;
  pinIds?: string[];
}

export interface WebhookProcessorPayload {
  webhookId: string;
  provider: string;
}

export interface DigestEmailPayload {
  userId: string;
  date: string;
}

export interface ExportGeneratorPayload {
  userId: string;
  exportType: string;
  format: 'csv' | 'json';
  dateRange?: {
    start: string;
    end: string;
  };
  fields?: string[];
}

/**
 * Trigger the design engine pipeline
 */
export async function triggerDesignEngine(payload: DesignEnginePayload) {
  return tasks.trigger('design-engine', payload);
}

/**
 * Trigger mockup generation
 */
export async function triggerMockupGeneration(payload: MockupGeneratorPayload) {
  return tasks.trigger('mockup-generator', payload);
}

/**
 * Trigger winner refresh (weekly top performers)
 */
export async function triggerWinnerRefresh(payload: WinnerRefreshPayload) {
  return tasks.trigger('winner-refresh', payload);
}

/**
 * Trigger webhook processing
 */
export async function triggerWebhookProcessor(payload: WebhookProcessorPayload) {
  return tasks.trigger('webhook-processor', payload);
}

/**
 * Trigger digest email generation
 */
export async function triggerDigestEmail(payload: DigestEmailPayload) {
  return tasks.trigger('digest-email', payload);
}

/**
 * Trigger data export generation
 */
export async function triggerExportGenerator(payload: ExportGeneratorPayload) {
  return tasks.trigger('export-generator', payload);
}

/**
 * Get task run status
 */
export async function getTaskRunStatus(runId: string) {
  return tasks.retrieve(runId);
}

/**
 * Cancel a task run
 */
export async function cancelTaskRun(runId: string) {
  return tasks.cancel(runId);
}
```

### `trigger/design-engine.ts`
```typescript
import { task, logger } from '@trigger.dev/sdk/v3';
import type { DesignEnginePayload } from '@/lib/trigger/client';

export const designEngineTask = task({
  id: 'design-engine',
  
  // Retry configuration specific to design engine
  retry: {
    maxAttempts: 2,
    minTimeoutInMs: 5000,
    maxTimeoutInMs: 60000,
    factor: 2,
  },
  
  // Machine requirements
  machine: 'medium-1x',
  
  // Max duration: 15 minutes for full pipeline
  maxDuration: 900,
  
  run: async (payload: DesignEnginePayload, { ctx }) => {
    logger.info('Starting design engine pipeline', { quoteId: payload.quoteId });
    
    // Step 1: Generate master design
    logger.info('Step 1: Generating master design');
    // Implementation will be added in Phase 8
    
    // Step 2: Generate print sizes
    logger.info('Step 2: Generating print sizes');
    // Implementation will be added in Phase 8
    
    // Step 3: Generate social formats
    logger.info('Step 3: Generating social formats');
    // Implementation will be added in Phase 8
    
    // Step 4: Quality check
    logger.info('Step 4: Running quality checks');
    // Implementation will be added in Phase 8
    
    // Step 5: Route to approval or auto-approve
    logger.info('Step 5: Routing based on quality and mode');
    // Implementation will be added in Phase 8
    
    // Step 6: Generate mockups if enabled
    if (payload.generateMockups) {
      logger.info('Step 6: Triggering mockup generation');
      // Implementation will be added in Phase 9
    }
    
    return {
      success: true,
      quoteId: payload.quoteId,
      assetsGenerated: 0, // Will be populated
      mockupsQueued: payload.generateMockups,
    };
  },
});
```

### `trigger/index.ts`
```typescript
// Barrel export for all trigger tasks
// Tasks are auto-discovered from the trigger directory

export { designEngineTask } from './design-engine';
// Additional tasks will be exported as they're created:
// export { mockupGeneratorTask } from './mockup-generator';
// export { winnerRefreshTask } from './winner-refresh';
// export { webhookProcessorTask } from './webhook-processor';
// export { digestEmailTask } from './digest-email';
// export { exportGeneratorTask } from './export-generator';
```

- **Step Dependencies**: Step 1.1
- **User Instructions**:
  1. Create Trigger.dev account at trigger.dev
  2. Create a new project
  3. Copy the secret key to `.env.local` as `TRIGGER_SECRET_KEY`
  4. Run `npx trigger.dev@latest dev` during development

---

