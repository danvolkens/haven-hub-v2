## Step 4.1: Create Approval Queue Database Schema

- **Task**: Create the database migration for the polymorphic approval queue with all required fields.

- **Files**:

### `supabase/migrations/003_approval_queue.sql`
```sql
-- ============================================================================
-- Migration: 003_approval_queue
-- Description: Polymorphic approval queue for all item types
-- Feature: 2 (Approval Queue System)
-- ============================================================================

-- ============================================================================
-- Approval Items Table
-- ============================================================================
CREATE TABLE approval_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Item classification
  type TEXT NOT NULL CHECK (type IN ('asset', 'mockup', 'pin', 'ugc', 'product')),
  status TEXT NOT NULL DEFAULT 'pending' 
    CHECK (status IN ('pending', 'approved', 'rejected', 'skipped', 'processing')),
  
  -- Reference to actual item
  reference_id UUID NOT NULL,
  reference_table TEXT NOT NULL,
  
  -- Cached payload for quick display (preview data)
  payload JSONB NOT NULL DEFAULT '{}',
  
  -- Quality/confidence metrics
  confidence_score NUMERIC(4,3) CHECK (confidence_score >= 0 AND confidence_score <= 1),
  
  -- Flags that require attention
  flags TEXT[] NOT NULL DEFAULT '{}',
  flag_reasons JSONB NOT NULL DEFAULT '{}',
  
  -- Sorting/filtering
  priority INTEGER NOT NULL DEFAULT 0,
  collection TEXT CHECK (collection IN ('grounding', 'wholeness', 'growth')),
  
  -- Processing metadata
  processed_at TIMESTAMPTZ,
  processed_by TEXT, -- 'user', 'system', 'auto'
  rejection_reason TEXT,
  
  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================

-- Primary query: user's pending items ordered by priority/date
CREATE INDEX idx_approval_items_pending 
  ON approval_items(user_id, status, priority DESC, created_at ASC)
  WHERE status = 'pending';

-- Filter by type
CREATE INDEX idx_approval_items_type
  ON approval_items(user_id, type, status, created_at DESC);

-- Filter by collection
CREATE INDEX idx_approval_items_collection
  ON approval_items(user_id, collection, status)
  WHERE collection IS NOT NULL;

-- Find by reference
CREATE INDEX idx_approval_items_reference
  ON approval_items(reference_id, reference_table);

-- Flagged items
CREATE INDEX idx_approval_items_flagged
  ON approval_items(user_id, status)
  WHERE array_length(flags, 1) > 0;

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE approval_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY approval_items_select ON approval_items
  FOR SELECT USING (user_id = auth.uid());

CREATE POLICY approval_items_insert ON approval_items
  FOR INSERT WITH CHECK (user_id = auth.uid());

CREATE POLICY approval_items_update ON approval_items
  FOR UPDATE USING (user_id = auth.uid());

CREATE POLICY approval_items_delete ON approval_items
  FOR DELETE USING (user_id = auth.uid());

-- ============================================================================
-- Trigger for updated_at
-- ============================================================================
CREATE TRIGGER approval_items_updated_at
  BEFORE UPDATE ON approval_items
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Get approval queue counts by type
-- ============================================================================
CREATE OR REPLACE FUNCTION get_approval_counts(p_user_id UUID)
RETURNS TABLE (
  type TEXT,
  count BIGINT
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    ai.type,
    COUNT(*)::BIGINT
  FROM approval_items ai
  WHERE ai.user_id = p_user_id
    AND ai.status = 'pending'
  GROUP BY ai.type
  
  UNION ALL
  
  SELECT 
    'total'::TEXT,
    COUNT(*)::BIGINT
  FROM approval_items ai
  WHERE ai.user_id = p_user_id
    AND ai.status = 'pending';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- Function: Bulk approve items
-- ============================================================================
CREATE OR REPLACE FUNCTION bulk_approve_items(
  p_user_id UUID,
  p_item_ids UUID[]
)
RETURNS INTEGER AS $$
DECLARE
  v_count INTEGER;
BEGIN
  UPDATE approval_items
  SET 
    status = 'approved',
    processed_at = NOW(),
    processed_by = 'user'
  WHERE id = ANY(p_item_ids)
    AND user_id = p_user_id
    AND status = 'pending';
  
  GET DIAGNOSTICS v_count = ROW_COUNT;
  RETURN v_count;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- Function: Bulk reject items
-- ============================================================================
CREATE OR REPLACE FUNCTION bulk_reject_items(
  p_user_id UUID,
  p_item_ids UUID[],
  p_reason TEXT DEFAULT NULL
)
RETURNS INTEGER AS $$
DECLARE
  v_count INTEGER;
BEGIN
  UPDATE approval_items
  SET 
    status = 'rejected',
    processed_at = NOW(),
    processed_by = 'user',
    rejection_reason = p_reason
  WHERE id = ANY(p_item_ids)
    AND user_id = p_user_id
    AND status = 'pending';
  
  GET DIAGNOSTICS v_count = ROW_COUNT;
  RETURN v_count;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- Function: Auto-approve items based on confidence score
-- ============================================================================
CREATE OR REPLACE FUNCTION auto_approve_high_confidence(
  p_user_id UUID,
  p_threshold NUMERIC DEFAULT 0.85
)
RETURNS INTEGER AS $$
DECLARE
  v_count INTEGER;
BEGIN
  UPDATE approval_items
  SET 
    status = 'approved',
    processed_at = NOW(),
    processed_by = 'system'
  WHERE user_id = p_user_id
    AND status = 'pending'
    AND confidence_score >= p_threshold
    AND array_length(flags, 1) IS NULL;
  
  GET DIAGNOSTICS v_count = ROW_COUNT;
  RETURN v_count;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### `types/approval.ts`
```typescript
import type { ApprovalItemType, ApprovalStatus } from '@/lib/constants';
import type { Collection } from '@/lib/constants';

export interface ApprovalItem {
  id: string;
  user_id: string;
  type: ApprovalItemType;
  status: ApprovalStatus;
  reference_id: string;
  reference_table: string;
  payload: ApprovalPayload;
  confidence_score: number | null;
  flags: string[];
  flag_reasons: Record<string, string>;
  priority: number;
  collection: Collection | null;
  processed_at: string | null;
  processed_by: 'user' | 'system' | 'auto' | null;
  rejection_reason: string | null;
  created_at: string;
  updated_at: string;
}

export type ApprovalPayload =
  | AssetApprovalPayload
  | MockupApprovalPayload
  | PinApprovalPayload
  | UgcApprovalPayload
  | ProductApprovalPayload;

export interface AssetApprovalPayload {
  type: 'asset';
  quoteId: string;
  quoteText: string;
  assetUrl: string;
  thumbnailUrl: string;
  format: string;
  size: string;
  collection: Collection;
  mood: string;
  qualityScores: {
    readability: number;
    contrast: number;
    composition: number;
    overall: number;
  };
}

export interface MockupApprovalPayload {
  type: 'mockup';
  quoteId: string;
  assetId: string;
  mockupUrl: string;
  thumbnailUrl: string;
  scene: string;
  creditsUsed: number;
}

export interface PinApprovalPayload {
  type: 'pin';
  assetUrl: string;
  thumbnailUrl: string;
  title: string;
  description: string;
  boardName: string;
  scheduledTime: string | null;
  copyVariant: string | null;
}

export interface UgcApprovalPayload {
  type: 'ugc';
  photoUrl: string;
  thumbnailUrl: string;
  customerName: string;
  customerEmail: string;
  orderId: string;
  productName: string;
  submittedAt: string;
  moderationScore: number | null;
}

export interface ProductApprovalPayload {
  type: 'product';
  title: string;
  description: string;
  price: number;
  images: string[];
  collection: Collection;
  variants: Array<{
    title: string;
    price: number;
    sku: string;
  }>;
}

export interface ApprovalCounts {
  total: number;
  asset: number;
  mockup: number;
  pin: number;
  ugc: number;
  product: number;
}

export type ApprovalAction = 'approve' | 'reject' | 'skip';

export interface ApprovalFilters {
  type?: ApprovalItemType;
  collection?: Collection;
  flagged?: boolean;
}
```

- **Step Dependencies**: Step 2.1
- **User Instructions**: Run migration via Supabase Dashboard or CLI

---

