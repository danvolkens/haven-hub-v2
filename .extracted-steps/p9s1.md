## Step 14.1: Create Leads Database Schema

- **Task**: Create database schema for lead capture, landing pages, and form submissions.

- **Files**:

### `supabase/migrations/011_leads.sql`
```sql
-- ============================================================================
-- Migration: 011_leads
-- Description: Lead capture, landing pages, and form submissions
-- Feature: 14 (Lead Capture), 15 (Quiz System)
-- ============================================================================

-- ============================================================================
-- Landing Pages Table
-- ============================================================================
CREATE TABLE landing_pages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Page identification
  slug TEXT NOT NULL,
  name TEXT NOT NULL,
  
  -- Page type
  type TEXT NOT NULL CHECK (type IN ('lead_magnet', 'quiz', 'newsletter', 'product')),
  
  -- Content
  headline TEXT NOT NULL,
  subheadline TEXT,
  body_content TEXT,
  
  -- Lead magnet details
  lead_magnet_type TEXT CHECK (lead_magnet_type IN (
    'ebook', 'wallpaper', 'printable', 'guide', 'checklist', 'video'
  )),
  lead_magnet_title TEXT,
  lead_magnet_file_url TEXT,
  lead_magnet_file_key TEXT,
  
  -- Design
  collection TEXT CHECK (collection IN ('grounding', 'wholeness', 'growth')),
  featured_image_url TEXT,
  custom_css TEXT,
  
  -- SEO
  meta_title TEXT,
  meta_description TEXT,
  
  -- Form configuration
  form_fields JSONB NOT NULL DEFAULT '[
    {"name": "email", "type": "email", "label": "Email", "required": true},
    {"name": "first_name", "type": "text", "label": "First Name", "required": false}
  ]',
  
  -- Klaviyo integration
  klaviyo_list_id TEXT,
  klaviyo_tags TEXT[] DEFAULT '{}',
  
  -- Status
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'archived')),
  published_at TIMESTAMPTZ,
  
  -- Analytics
  views INTEGER NOT NULL DEFAULT 0,
  submissions INTEGER NOT NULL DEFAULT 0,
  conversion_rate NUMERIC(5,4) GENERATED ALWAYS AS (
    CASE WHEN views > 0 THEN submissions::NUMERIC / views ELSE 0 END
  ) STORED,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, slug)
);

-- ============================================================================
-- Leads Table
-- ============================================================================
CREATE TABLE leads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  landing_page_id UUID REFERENCES landing_pages(id) ON DELETE SET NULL,
  
  -- Contact info
  email TEXT NOT NULL,
  first_name TEXT,
  last_name TEXT,
  phone TEXT,
  
  -- Source tracking
  source TEXT NOT NULL DEFAULT 'landing_page',
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  utm_content TEXT,
  referrer TEXT,
  
  -- Quiz results (if from quiz)
  quiz_id UUID,
  quiz_results JSONB,
  recommended_collection TEXT,
  
  -- Status
  status TEXT NOT NULL DEFAULT 'new' CHECK (status IN (
    'new', 'subscribed', 'customer', 'unsubscribed'
  )),
  
  -- Customer conversion
  shopify_customer_id TEXT,
  converted_at TIMESTAMPTZ,
  first_order_id TEXT,
  lifetime_value NUMERIC(10,2) NOT NULL DEFAULT 0,
  
  -- Klaviyo sync
  klaviyo_profile_id TEXT,
  synced_to_klaviyo_at TIMESTAMPTZ,
  
  -- Engagement
  emails_sent INTEGER NOT NULL DEFAULT 0,
  emails_opened INTEGER NOT NULL DEFAULT 0,
  emails_clicked INTEGER NOT NULL DEFAULT 0,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, email)
);

-- ============================================================================
-- Form Submissions Table (raw submission data)
-- ============================================================================
CREATE TABLE form_submissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  landing_page_id UUID REFERENCES landing_pages(id) ON DELETE CASCADE NOT NULL,
  lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,
  
  -- Submission data
  data JSONB NOT NULL,
  
  -- Client info
  ip_address TEXT,
  user_agent TEXT,
  
  -- Processing
  processed BOOLEAN NOT NULL DEFAULT false,
  processed_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_landing_pages_user ON landing_pages(user_id);
CREATE INDEX idx_landing_pages_slug ON landing_pages(user_id, slug) WHERE status = 'active';
CREATE INDEX idx_landing_pages_type ON landing_pages(user_id, type);

CREATE INDEX idx_leads_user ON leads(user_id);
CREATE INDEX idx_leads_email ON leads(user_id, email);
CREATE INDEX idx_leads_status ON leads(user_id, status);
CREATE INDEX idx_leads_source ON leads(user_id, source);
CREATE INDEX idx_leads_landing_page ON leads(landing_page_id);
CREATE INDEX idx_leads_converted ON leads(user_id, converted_at) WHERE converted_at IS NOT NULL;

CREATE INDEX idx_submissions_landing_page ON form_submissions(landing_page_id);
CREATE INDEX idx_submissions_unprocessed ON form_submissions(user_id, processed) WHERE processed = false;

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE landing_pages ENABLE ROW LEVEL SECURITY;
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;
ALTER TABLE form_submissions ENABLE ROW LEVEL SECURITY;

CREATE POLICY landing_pages_all ON landing_pages FOR ALL USING (user_id = auth.uid());
CREATE POLICY leads_all ON leads FOR ALL USING (user_id = auth.uid());
CREATE POLICY submissions_all ON form_submissions FOR ALL USING (user_id = auth.uid());

-- Allow public to view active landing pages (for public URLs)
CREATE POLICY landing_pages_public_read ON landing_pages 
  FOR SELECT USING (status = 'active');

-- Allow public form submissions
CREATE POLICY submissions_public_insert ON form_submissions 
  FOR INSERT WITH CHECK (true);

CREATE TRIGGER landing_pages_updated_at BEFORE UPDATE ON landing_pages
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER leads_updated_at BEFORE UPDATE ON leads
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Track landing page view
-- ============================================================================
CREATE OR REPLACE FUNCTION track_page_view(p_page_id UUID)
RETURNS void AS $$
BEGIN
  UPDATE landing_pages
  SET views = views + 1
  WHERE id = p_page_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- Function: Process form submission
-- ============================================================================
CREATE OR REPLACE FUNCTION process_form_submission(
  p_submission_id UUID
)
RETURNS UUID AS $$
DECLARE
  v_submission RECORD;
  v_lead_id UUID;
  v_email TEXT;
BEGIN
  SELECT * INTO v_submission
  FROM form_submissions
  WHERE id = p_submission_id;
  
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Submission not found';
  END IF;
  
  -- Extract email from submission data
  v_email := v_submission.data->>'email';
  
  IF v_email IS NULL THEN
    RAISE EXCEPTION 'Email is required';
  END IF;
  
  -- Upsert lead
  INSERT INTO leads (user_id, email, first_name, landing_page_id, source)
  VALUES (
    v_submission.user_id,
    v_email,
    v_submission.data->>'first_name',
    v_submission.landing_page_id,
    'landing_page'
  )
  ON CONFLICT (user_id, email) DO UPDATE SET
    first_name = COALESCE(EXCLUDED.first_name, leads.first_name),
    updated_at = NOW()
  RETURNING id INTO v_lead_id;
  
  -- Update submission
  UPDATE form_submissions
  SET 
    lead_id = v_lead_id,
    processed = true,
    processed_at = NOW()
  WHERE id = p_submission_id;
  
  -- Update landing page submission count
  UPDATE landing_pages
  SET submissions = submissions + 1
  WHERE id = v_submission.landing_page_id;
  
  RETURN v_lead_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### `types/leads.ts`
```typescript
export interface LandingPage {
  id: string;
  user_id: string;
  slug: string;
  name: string;
  type: LandingPageType;
  headline: string;
  subheadline: string | null;
  body_content: string | null;
  lead_magnet_type: LeadMagnetType | null;
  lead_magnet_title: string | null;
  lead_magnet_file_url: string | null;
  lead_magnet_file_key: string | null;
  collection: 'grounding' | 'wholeness' | 'growth' | null;
  featured_image_url: string | null;
  custom_css: string | null;
  meta_title: string | null;
  meta_description: string | null;
  form_fields: FormField[];
  klaviyo_list_id: string | null;
  klaviyo_tags: string[];
  status: 'draft' | 'active' | 'archived';
  published_at: string | null;
  views: number;
  submissions: number;
  conversion_rate: number;
  created_at: string;
  updated_at: string;
}

export type LandingPageType = 'lead_magnet' | 'quiz' | 'newsletter' | 'product';
export type LeadMagnetType = 'ebook' | 'wallpaper' | 'printable' | 'guide' | 'checklist' | 'video';

export interface FormField {
  name: string;
  type: 'text' | 'email' | 'tel' | 'select' | 'checkbox' | 'textarea';
  label: string;
  required: boolean;
  placeholder?: string;
  options?: string[];
}

export interface Lead {
  id: string;
  user_id: string;
  landing_page_id: string | null;
  email: string;
  first_name: string | null;
  last_name: string | null;
  phone: string | null;
  source: string;
  utm_source: string | null;
  utm_medium: string | null;
  utm_campaign: string | null;
  utm_content: string | null;
  referrer: string | null;
  quiz_id: string | null;
  quiz_results: QuizResults | null;
  recommended_collection: string | null;
  status: LeadStatus;
  shopify_customer_id: string | null;
  converted_at: string | null;
  first_order_id: string | null;
  lifetime_value: number;
  klaviyo_profile_id: string | null;
  synced_to_klaviyo_at: string | null;
  emails_sent: number;
  emails_opened: number;
  emails_clicked: number;
  created_at: string;
  updated_at: string;
}

export type LeadStatus = 'new' | 'subscribed' | 'customer' | 'unsubscribed';

export interface QuizResults {
  answers: Record<string, string | string[]>;
  scores: Record<string, number>;
  recommendation: string;
}

export interface FormSubmission {
  id: string;
  user_id: string;
  landing_page_id: string;
  lead_id: string | null;
  data: Record<string, string>;
  ip_address: string | null;
  user_agent: string | null;
  processed: boolean;
  processed_at: string | null;
  created_at: string;
}

export interface CreateLandingPageRequest {
  slug: string;
  name: string;
  type: LandingPageType;
  headline: string;
  subheadline?: string;
  bodyContent?: string;
  leadMagnetType?: LeadMagnetType;
  leadMagnetTitle?: string;
  collection?: 'grounding' | 'wholeness' | 'growth';
  formFields?: FormField[];
  klaviyoListId?: string;
  klaviyoTags?: string[];
}
```

- **Step Dependencies**: Step 5.3 (Klaviyo integration)
- **User Instructions**: Run migration

---

