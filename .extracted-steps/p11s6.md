## Step 21.4: Create Link-in-Bio System

- **Task**: Build the branded link page for social media bios.

- **Files**:

### `supabase/migrations/018a_link_in_bio.sql`
```sql
-- ============================================================================
-- Migration: 018a_link_in_bio
-- Description: Link-in-bio system for social profiles
-- Feature: 21.3 (Link-in-Bio)
-- ============================================================================

-- ============================================================================
-- Link-in-Bio Configuration
-- ============================================================================
CREATE TABLE link_in_bio_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
  
  -- Profile
  title TEXT NOT NULL DEFAULT 'My Links',
  bio TEXT,
  avatar_url TEXT,
  
  -- Styling
  theme TEXT NOT NULL DEFAULT 'light' CHECK (theme IN ('light', 'dark', 'custom')),
  background_color TEXT DEFAULT '#ffffff',
  text_color TEXT DEFAULT '#000000',
  accent_color TEXT DEFAULT '#4f7c5f',
  button_style TEXT NOT NULL DEFAULT 'rounded' CHECK (button_style IN (
    'rounded', 'pill', 'square', 'outline'
  )),
  
  -- Custom slug
  slug TEXT UNIQUE,
  
  -- Analytics
  total_views INTEGER NOT NULL DEFAULT 0,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Links Table
-- ============================================================================
CREATE TABLE link_in_bio_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Link details
  url TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  icon TEXT, -- Lucide icon name
  thumbnail_url TEXT,
  
  -- Display
  position INTEGER NOT NULL DEFAULT 0,
  is_active BOOLEAN NOT NULL DEFAULT true,
  is_featured BOOLEAN NOT NULL DEFAULT false,
  
  -- Analytics
  click_count INTEGER NOT NULL DEFAULT 0,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Link Click Analytics
-- ============================================================================
CREATE TABLE link_clicks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  link_id UUID REFERENCES link_in_bio_links(id) ON DELETE CASCADE NOT NULL,
  
  -- Source info
  referrer TEXT,
  user_agent TEXT,
  country TEXT,
  
  clicked_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_lib_config_user ON link_in_bio_config(user_id);
CREATE INDEX idx_lib_config_slug ON link_in_bio_config(slug) WHERE slug IS NOT NULL;

CREATE INDEX idx_lib_links_user ON link_in_bio_links(user_id);
CREATE INDEX idx_lib_links_position ON link_in_bio_links(user_id, position);
CREATE INDEX idx_lib_links_active ON link_in_bio_links(user_id, is_active, position);

CREATE INDEX idx_link_clicks_link ON link_clicks(link_id);
CREATE INDEX idx_link_clicks_date ON link_clicks(link_id, clicked_at DESC);

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE link_in_bio_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE link_in_bio_links ENABLE ROW LEVEL SECURITY;
ALTER TABLE link_clicks ENABLE ROW LEVEL SECURITY;

CREATE POLICY lib_config_all ON link_in_bio_config FOR ALL USING (user_id = auth.uid());
CREATE POLICY lib_links_all ON link_in_bio_links FOR ALL USING (user_id = auth.uid());
CREATE POLICY link_clicks_all ON link_clicks FOR ALL 
  USING (link_id IN (SELECT id FROM link_in_bio_links WHERE user_id = auth.uid()));

-- Public read for link pages
CREATE POLICY lib_config_public ON link_in_bio_config FOR SELECT USING (true);
CREATE POLICY lib_links_public ON link_in_bio_links FOR SELECT USING (is_active = true);

-- ============================================================================
-- Triggers
-- ============================================================================
CREATE TRIGGER lib_config_updated_at BEFORE UPDATE ON link_in_bio_config
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER lib_links_updated_at BEFORE UPDATE ON link_in_bio_links
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### `types/link-in-bio.ts`
```typescript
export type ButtonStyle = 'rounded' | 'pill' | 'square' | 'outline';
export type Theme = 'light' | 'dark' | 'custom';

export interface LinkInBioConfig {
  id: string;
  user_id: string;
  title: string;
  bio?: string;
  avatar_url?: string;
  theme: Theme;
  background_color: string;
  text_color: string;
  accent_color: string;
  button_style: ButtonStyle;
  slug?: string;
  total_views: number;
  created_at: string;
  updated_at: string;
}

export interface LinkInBioLink {
  id: string;
  user_id: string;
  url: string;
  title: string;
  description?: string;
  icon?: string;
  thumbnail_url?: string;
  position: number;
  is_active: boolean;
  is_featured: boolean;
  click_count: number;
  created_at: string;
  updated_at: string;
}
```

### `lib/link-in-bio/link-service.ts`
```typescript
import { createClient } from '@/lib/supabase/server';
import { LinkInBioConfig, LinkInBioLink } from '@/types/link-in-bio';

export async function getOrCreateConfig(userId: string): Promise<LinkInBioConfig> {
  const supabase = createClient();

  const { data: existing } = await supabase
    .from('link_in_bio_config')
    .select('*')
    .eq('user_id', userId)
    .single();

  if (existing) return existing;

  const { data: config, error } = await supabase
    .from('link_in_bio_config')
    .insert({ user_id: userId })
    .select()
    .single();

  if (error) throw new Error(`Failed to create config: ${error.message}`);
  return config;
}

export async function updateConfig(
  userId: string,
  updates: Partial<LinkInBioConfig>
): Promise<LinkInBioConfig> {
  const supabase = createClient();

  const { data: config, error } = await supabase
    .from('link_in_bio_config')
    .update(updates)
    .eq('user_id', userId)
    .select()
    .single();

  if (error) throw new Error(`Failed to update config: ${error.message}`);
  return config;
}

export async function getLinks(userId: string): Promise<LinkInBioLink[]> {
  const supabase = createClient();

  const { data: links } = await supabase
    .from('link_in_bio_links')
    .select('*')
    .eq('user_id', userId)
    .order('position', { ascending: true });

  return links || [];
}

export async function createLink(
  userId: string,
  link: Partial<LinkInBioLink>
): Promise<LinkInBioLink> {
  const supabase = createClient();

  // Get max position
  const { data: maxLink } = await supabase
    .from('link_in_bio_links')
    .select('position')
    .eq('user_id', userId)
    .order('position', { ascending: false })
    .limit(1)
    .single();

  const position = (maxLink?.position ?? -1) + 1;

  const { data: newLink, error } = await supabase
    .from('link_in_bio_links')
    .insert({
      user_id: userId,
      url: link.url,
      title: link.title,
      description: link.description,
      icon: link.icon,
      position,
    })
    .select()
    .single();

  if (error) throw new Error(`Failed to create link: ${error.message}`);
  return newLink;
}

export async function updateLinkPositions(
  userId: string,
  linkIds: string[]
): Promise<void> {
  const supabase = createClient();

  for (let i = 0; i < linkIds.length; i++) {
    await supabase
      .from('link_in_bio_links')
      .update({ position: i })
      .eq('id', linkIds[i])
      .eq('user_id', userId);
  }
}

export async function trackClick(
  linkId: string,
  referrer?: string,
  userAgent?: string
): Promise<void> {
  const supabase = createClient();

  // Insert click record
  await supabase.from('link_clicks').insert({
    link_id: linkId,
    referrer,
    user_agent: userAgent,
  });

  // Increment click count
  await supabase.rpc('increment_link_clicks', { link_id: linkId });
}

export async function trackPageView(userId: string): Promise<void> {
  const supabase = createClient();
  
  await supabase.rpc('increment_lib_views', { p_user_id: userId });
}
```

### `app/api/links/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { getOrCreateConfig, getLinks, createLink } from '@/lib/link-in-bio/link-service';

export async function GET(request: NextRequest) {
  const supabase = createClient();
  
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const config = await getOrCreateConfig(user.id);
  const links = await getLinks(user.id);

  return NextResponse.json({ config, links });
}

export async function POST(request: NextRequest) {
  const supabase = createClient();
  
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const body = await request.json();

  try {
    const link = await createLink(user.id, body);
    return NextResponse.json({ link }, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to create link' },
      { status: 500 }
    );
  }
}
```

### `app/(public)/links/[slug]/page.tsx`
```tsx
import { notFound } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import { LinkInBioConfig, LinkInBioLink } from '@/types/link-in-bio';
import * as Icons from 'lucide-react';

interface PageProps {
  params: { slug: string };
}

async function getPageData(slug: string) {
  const supabase = createClient();

  const { data: config } = await supabase
    .from('link_in_bio_config')
    .select('*')
    .eq('slug', slug)
    .single();

  if (!config) return null;

  const { data: links } = await supabase
    .from('link_in_bio_links')
    .select('*')
    .eq('user_id', config.user_id)
    .eq('is_active', true)
    .order('position', { ascending: true });

  return { config, links: links || [] };
}

export default async function LinkInBioPage({ params }: PageProps) {
  const data = await getPageData(params.slug);

  if (!data) {
    notFound();
  }

  const { config, links } = data;

  const buttonStyles: Record<string, string> = {
    rounded: 'rounded-lg',
    pill: 'rounded-full',
    square: 'rounded-none',
    outline: 'rounded-lg border-2 bg-transparent',
  };

  return (
    <div
      className="min-h-screen py-12 px-4"
      style={{
        backgroundColor: config.background_color,
        color: config.text_color,
      }}
    >
      <div className="max-w-md mx-auto">
        {/* Profile */}
        <div className="text-center mb-8">
          {config.avatar_url && (
            <img
              src={config.avatar_url}
              alt={config.title}
              className="w-24 h-24 rounded-full mx-auto mb-4 object-cover"
            />
          )}
          <h1 className="text-2xl font-bold mb-2">{config.title}</h1>
          {config.bio && (
            <p className="text-sm opacity-80">{config.bio}</p>
          )}
        </div>

        {/* Links */}
        <div className="space-y-3">
          {links.map((link) => {
            const IconComponent = link.icon 
              ? (Icons as any)[link.icon] || Icons.Link
              : Icons.Link;

            return (
              <a
                key={link.id}
                href={`/api/links/click/${link.id}?url=${encodeURIComponent(link.url)}`}
                className={`block w-full p-4 text-center font-medium transition-transform hover:scale-[1.02] ${
                  buttonStyles[config.button_style]
                } ${link.is_featured ? 'ring-2 ring-offset-2' : ''}`}
                style={{
                  backgroundColor: config.button_style === 'outline' 
                    ? 'transparent' 
                    : config.accent_color,
                  color: config.button_style === 'outline' 
                    ? config.accent_color 
                    : '#ffffff',
                  borderColor: config.accent_color,
                }}
              >
                <span className="flex items-center justify-center gap-2">
                  <IconComponent className="h-5 w-5" />
                  {link.title}
                </span>
              </a>
            );
          })}
        </div>

        {/* Powered by */}
        <div className="text-center mt-12 text-sm opacity-50">
          Powered by Haven Hub
        </div>
      </div>
    </div>
  );
}
```

### `app/(dashboard)/dashboard/links/page.tsx`
```tsx
'use client';

import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { PageContainer } from '@/components/layout/page-container';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Modal } from '@/components/ui/modal';
import { Switch } from '@/components/ui/switch';
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  useSortable,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { Plus, GripVertical, ExternalLink, Trash2, Eye, BarChart } from 'lucide-react';

function SortableLink({ link, onToggle, onDelete }: any) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
  } = useSortable({ id: link.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  return (
    <div ref={setNodeRef} style={style} className="bg-white border rounded-lg p-4">
      <div className="flex items-center gap-3">
        <button {...attributes} {...listeners} className="cursor-grab">
          <GripVertical className="h-5 w-5 text-gray-400" />
        </button>

        <div className="flex-1 min-w-0">
          <div className="font-medium truncate">{link.title}</div>
          <div className="text-sm text-muted-foreground truncate">{link.url}</div>
        </div>

        <div className="flex items-center gap-3">
          <div className="text-sm text-muted-foreground">
            {link.click_count} clicks
          </div>
          <Switch
            checked={link.is_active}
            onCheckedChange={() => onToggle(link.id)}
          />
          <Button variant="ghost" size="sm" onClick={() => onDelete(link.id)}>
            <Trash2 className="h-4 w-4 text-red-500" />
          </Button>
        </div>
      </div>
    </div>
  );
}

export default function LinksPage() {
  const queryClient = useQueryClient();
  const [isAddOpen, setIsAddOpen] = useState(false);
  const [newLink, setNewLink] = useState({ title: '', url: '' });

  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
  );

  const { data, isLoading } = useQuery({
    queryKey: ['link-in-bio'],
    queryFn: async () => {
      const response = await fetch('/api/links');
      if (!response.ok) throw new Error('Failed to fetch');
      return response.json();
    },
  });

  const addMutation = useMutation({
    mutationFn: async (link: { title: string; url: string }) => {
      const response = await fetch('/api/links', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(link),
      });
      if (!response.ok) throw new Error('Failed to add link');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['link-in-bio'] });
      setIsAddOpen(false);
      setNewLink({ title: '', url: '' });
    },
  });

  const config = data?.config;
  const links = data?.links || [];

  const handleDragEnd = async (event: any) => {
    const { active, over } = event;
    if (!over || active.id === over.id) return;

    const oldIndex = links.findIndex((l: any) => l.id === active.id);
    const newIndex = links.findIndex((l: any) => l.id === over.id);
    const newOrder = arrayMove(links, oldIndex, newIndex);

    // Update positions
    await fetch('/api/links/reorder', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ linkIds: newOrder.map((l: any) => l.id) }),
    });

    queryClient.invalidateQueries({ queryKey: ['link-in-bio'] });
  };

  return (
    <PageContainer
      title="Link in Bio"
      description="Manage your branded link page"
      actions={
        <div className="flex gap-2">
          {config?.slug && (
            <Button variant="outline" asChild>
              <a href={`/links/${config.slug}`} target="_blank">
                <Eye className="h-4 w-4 mr-2" />
                Preview
              </a>
            </Button>
          )}
          <Button onClick={() => setIsAddOpen(true)}>
            <Plus className="h-4 w-4 mr-2" />
            Add Link
          </Button>
        </div>
      }
    >
      {/* Stats */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        <Card className="p-4">
          <div className="text-sm text-muted-foreground">Total Views</div>
          <div className="text-2xl font-bold">{config?.total_views || 0}</div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-muted-foreground">Total Clicks</div>
          <div className="text-2xl font-bold">
            {links.reduce((sum: number, l: any) => sum + l.click_count, 0)}
          </div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-muted-foreground">Active Links</div>
          <div className="text-2xl font-bold">
            {links.filter((l: any) => l.is_active).length}
          </div>
        </Card>
      </div>

      {/* Links List */}
      {isLoading ? (
        <div className="text-center py-12">Loading...</div>
      ) : links.length === 0 ? (
        <Card className="p-12 text-center">
          <p className="text-muted-foreground mb-4">No links yet</p>
          <Button onClick={() => setIsAddOpen(true)}>
            <Plus className="h-4 w-4 mr-2" />
            Add Your First Link
          </Button>
        </Card>
      ) : (
        <DndContext
          sensors={sensors}
          collisionDetection={closestCenter}
          onDragEnd={handleDragEnd}
        >
          <SortableContext
            items={links.map((l: any) => l.id)}
            strategy={verticalListSortingStrategy}
          >
            <div className="space-y-2">
              {links.map((link: any) => (
                <SortableLink
                  key={link.id}
                  link={link}
                  onToggle={() => {}}
                  onDelete={() => {}}
                />
              ))}
            </div>
          </SortableContext>
        </DndContext>
      )}

      {/* Add Link Modal */}
      <Modal
        isOpen={isAddOpen}
        onClose={() => setIsAddOpen(false)}
        title="Add Link"
      >
        <div className="space-y-4">
          <div>
            <Label>Title</Label>
            <Input
              value={newLink.title}
              onChange={(e) => setNewLink({ ...newLink, title: e.target.value })}
              placeholder="My Website"
            />
          </div>
          <div>
            <Label>URL</Label>
            <Input
              value={newLink.url}
              onChange={(e) => setNewLink({ ...newLink, url: e.target.value })}
              placeholder="https://..."
            />
          </div>
          <div className="flex justify-end gap-2">
            <Button variant="outline" onClick={() => setIsAddOpen(false)}>
              Cancel
            </Button>
            <Button
              onClick={() => addMutation.mutate(newLink)}
              disabled={!newLink.title || !newLink.url || addMutation.isPending}
            >
              Add Link
            </Button>
          </div>
        </div>
      </Modal>
    </PageContainer>
  );
}
```

- **Step Dependencies**: Step 21.3
- **User Instructions**: Run migration `018a_link_in_bio.sql`

---

