## Step 1.8: Set Up Supabase Client Configuration

- **Task**: Configure Supabase client for both server and browser contexts, including middleware for session management.

- **Files**:

### `lib/supabase/client.ts`
```typescript
import { createBrowserClient } from '@supabase/ssr';
import type { Database } from '@/types/supabase';

export function createClient() {
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}

// Singleton for client-side usage
let browserClient: ReturnType<typeof createClient> | null = null;

export function getSupabaseBrowserClient() {
  if (!browserClient) {
    browserClient = createClient();
  }
  return browserClient;
}
```

### `lib/supabase/server.ts`
```typescript
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { cookies } from 'next/headers';
import type { Database } from '@/types/supabase';

export function createServerSupabaseClient() {
  const cookieStore = cookies();

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value, ...options });
          } catch (error) {
            // Handle cookies in Server Components
          }
        },
        remove(name: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value: '', ...options });
          } catch (error) {
            // Handle cookies in Server Components
          }
        },
      },
    }
  );
}

// Alias for cleaner imports
export const createServerClient = createServerSupabaseClient;
```

### `lib/supabase/admin.ts`
```typescript
import { createClient } from '@supabase/supabase-js';
import type { Database } from '@/types/supabase';

// Admin client bypasses RLS - use with caution
export function createAdminClient() {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

  if (!supabaseUrl || !serviceRoleKey) {
    throw new Error('Missing Supabase admin credentials');
  }

  return createClient<Database>(supabaseUrl, serviceRoleKey, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  });
}

// Singleton for server-side admin operations
let adminClient: ReturnType<typeof createAdminClient> | null = null;

export function getAdminClient() {
  if (!adminClient) {
    adminClient = createAdminClient();
  }
  return adminClient;
}
```

### `lib/supabase/middleware.ts`
```typescript
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';
import type { Database } from '@/types/supabase';

export async function updateSession(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  const supabase = createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value,
            ...options,
          });
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          });
          response.cookies.set({
            name,
            value,
            ...options,
          });
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value: '',
            ...options,
          });
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          });
          response.cookies.set({
            name,
            value: '',
            ...options,
          });
        },
      },
    }
  );

  // Refresh session if expired
  const { data: { session } } = await supabase.auth.getSession();

  return { response, session, supabase };
}
```

### `middleware.ts`
```typescript
import { type NextRequest, NextResponse } from 'next/server';
import { updateSession } from '@/lib/supabase/middleware';

// Routes that don't require authentication
const publicRoutes = [
  '/login',
  '/signup',
  '/forgot-password',
  '/reset-password',
  '/auth/callback',
  '/auth/confirm',
  '/quiz',
  '/landing',
  '/links',
  '/photos/submit',
];

// API routes that don't require authentication
const publicApiRoutes = [
  '/api/webhooks',
  '/api/cron',
  '/api/quiz',
  '/api/public',
];

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // Check if route is public
  const isPublicRoute = publicRoutes.some(
    (route) => pathname === route || pathname.startsWith(`${route}/`)
  );

  const isPublicApiRoute = publicApiRoutes.some((route) =>
    pathname.startsWith(route)
  );

  // Allow public routes and API webhooks
  if (isPublicRoute || isPublicApiRoute) {
    return NextResponse.next();
  }

  // Update session and check authentication
  const { response, session } = await updateSession(request);

  // Redirect to login if no session on protected routes
  if (!session && pathname.startsWith('/dashboard')) {
    const redirectUrl = new URL('/login', request.url);
    redirectUrl.searchParams.set('redirect', pathname);
    return NextResponse.redirect(redirectUrl);
  }

  // Redirect to dashboard if authenticated user visits auth pages
  if (session && (pathname === '/login' || pathname === '/signup')) {
    return NextResponse.redirect(new URL('/dashboard', request.url));
  }

  return response;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
```

### `types/supabase.ts`
```typescript
// This file will be auto-generated by Supabase CLI
// Run: npx supabase gen types typescript --project-id YOUR_PROJECT_ID > types/supabase.ts
// For now, we provide base types that will be extended

export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[];

export interface Database {
  public: {
    Tables: {
      user_settings: {
        Row: {
          id: string;
          user_id: string;
          global_mode: 'supervised' | 'assisted' | 'autopilot';
          module_overrides: Json;
          transitioning_to: 'supervised' | 'assisted' | 'autopilot' | null;
          transition_started_at: string | null;
          guardrails: Json;
          timezone: string;
          setup_progress: Json;
          setup_completed_at: string | null;
          digest_preferences: Json;
          notification_preferences: Json;
          created_at: string;
          updated_at: string;
        };
        Insert: {
          id?: string;
          user_id: string;
          global_mode?: 'supervised' | 'assisted' | 'autopilot';
          module_overrides?: Json;
          transitioning_to?: 'supervised' | 'assisted' | 'autopilot' | null;
          transition_started_at?: string | null;
          guardrails?: Json;
          timezone?: string;
          setup_progress?: Json;
          setup_completed_at?: string | null;
          digest_preferences?: Json;
          notification_preferences?: Json;
          created_at?: string;
          updated_at?: string;
        };
        Update: {
          id?: string;
          user_id?: string;
          global_mode?: 'supervised' | 'assisted' | 'autopilot';
          module_overrides?: Json;
          transitioning_to?: 'supervised' | 'assisted' | 'autopilot' | null;
          transition_started_at?: string | null;
          guardrails?: Json;
          timezone?: string;
          setup_progress?: Json;
          setup_completed_at?: string | null;
          digest_preferences?: Json;
          notification_preferences?: Json;
          created_at?: string;
          updated_at?: string;
        };
      };
      activity_log: {
        Row: {
          id: string;
          user_id: string;
          action_type: string;
          module: string | null;
          details: Json;
          executed: boolean;
          operator_mode: string;
          previous_value: Json | null;
          new_value: Json | null;
          created_at: string;
        };
        Insert: {
          id?: string;
          user_id: string;
          action_type: string;
          module?: string | null;
          details?: Json;
          executed?: boolean;
          operator_mode: string;
          previous_value?: Json | null;
          new_value?: Json | null;
          created_at?: string;
        };
        Update: {
          id?: string;
          user_id?: string;
          action_type?: string;
          module?: string | null;
          details?: Json;
          executed?: boolean;
          operator_mode?: string;
          previous_value?: Json | null;
          new_value?: Json | null;
          created_at?: string;
        };
      };
      approval_items: {
        Row: {
          id: string;
          user_id: string;
          type: 'asset' | 'mockup' | 'pin' | 'ugc' | 'product';
          status: 'pending' | 'approved' | 'rejected' | 'skipped' | 'processing';
          reference_id: string;
          reference_table: string;
          payload: Json;
          confidence_score: number | null;
          flags: string[];
          flag_reasons: Json;
          priority: number;
          processed_at: string | null;
          processed_by: string | null;
          rejection_reason: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: {
          id?: string;
          user_id: string;
          type: 'asset' | 'mockup' | 'pin' | 'ugc' | 'product';
          status?: 'pending' | 'approved' | 'rejected' | 'skipped' | 'processing';
          reference_id: string;
          reference_table: string;
          payload: Json;
          confidence_score?: number | null;
          flags?: string[];
          flag_reasons?: Json;
          priority?: number;
          processed_at?: string | null;
          processed_by?: string | null;
          rejection_reason?: string | null;
          created_at?: string;
          updated_at?: string;
        };
        Update: {
          id?: string;
          user_id?: string;
          type?: 'asset' | 'mockup' | 'pin' | 'ugc' | 'product';
          status?: 'pending' | 'approved' | 'rejected' | 'skipped' | 'processing';
          reference_id?: string;
          reference_table?: string;
          payload?: Json;
          confidence_score?: number | null;
          flags?: string[];
          flag_reasons?: Json;
          priority?: number;
          processed_at?: string | null;
          processed_by?: string | null;
          rejection_reason?: string | null;
          created_at?: string;
          updated_at?: string;
        };
      };
    };
    Views: {
      [_ in never]: never;
    };
    Functions: {
      [_ in never]: never;
    };
    Enums: {
      [_ in never]: never;
    };
  };
}
```

- **Step Dependencies**: Step 1.1
- **User Instructions**: 
  1. Create a Supabase project at supabase.com
  2. Copy `.env.local.example` to `.env.local`
  3. Add Supabase URL and keys from project settings â†’ API
  4. After creating tables, run: `npx supabase gen types typescript --project-id YOUR_PROJECT_ID > types/supabase.ts`

---

