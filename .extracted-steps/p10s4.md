## Step 18.1: Create Win-Back Database Schema

- **Task**: Create database schema for win-back campaign configuration and tracking.

- **Files**:

### `supabase/migrations/015_winback.sql`
```sql
-- ============================================================================
-- Migration: 015_winback
-- Description: Win-back campaigns for at-risk and churned customers
-- Feature: 18 (Win-Back Campaigns)
-- ============================================================================

-- ============================================================================
-- Win-Back Campaigns Table
-- ============================================================================
CREATE TABLE winback_campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Campaign details
  name TEXT NOT NULL,
  description TEXT,
  
  -- Targeting
  target_stages TEXT[] NOT NULL DEFAULT ARRAY['at_risk', 'churned'],
  min_days_inactive INTEGER NOT NULL DEFAULT 60,
  max_days_inactive INTEGER,
  min_lifetime_value NUMERIC(10,2) DEFAULT 0,
  target_collections TEXT[] DEFAULT '{}', -- Empty = all
  
  -- Incentive
  incentive_type TEXT CHECK (incentive_type IN (
    'percentage_discount',
    'fixed_discount',
    'free_shipping',
    'gift_with_purchase',
    'exclusive_product'
  )),
  incentive_value NUMERIC(10,2),
  discount_code TEXT,
  
  -- Klaviyo integration
  klaviyo_flow_id TEXT NOT NULL,
  
  -- Timing
  send_delay_days INTEGER NOT NULL DEFAULT 0, -- Days after becoming at-risk
  
  -- Status
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'paused', 'completed')),
  starts_at TIMESTAMPTZ,
  ends_at TIMESTAMPTZ,
  
  -- Performance
  customers_targeted INTEGER NOT NULL DEFAULT 0,
  emails_sent INTEGER NOT NULL DEFAULT 0,
  emails_opened INTEGER NOT NULL DEFAULT 0,
  emails_clicked INTEGER NOT NULL DEFAULT 0,
  customers_recovered INTEGER NOT NULL DEFAULT 0,
  revenue_recovered NUMERIC(12,2) NOT NULL DEFAULT 0,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Win-Back Recipients Table
-- ============================================================================
CREATE TABLE winback_recipients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES winback_campaigns(id) ON DELETE CASCADE NOT NULL,
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Status
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN (
    'pending',      -- Waiting to be sent
    'sent',         -- Email sent
    'opened',       -- Email opened
    'clicked',      -- Link clicked
    'recovered',    -- Made a purchase
    'unsubscribed', -- Opted out
    'expired'       -- Campaign ended without action
  )),
  
  -- Tracking
  sent_at TIMESTAMPTZ,
  opened_at TIMESTAMPTZ,
  clicked_at TIMESTAMPTZ,
  recovered_at TIMESTAMPTZ,
  recovery_order_id TEXT,
  recovery_order_value NUMERIC(10,2),
  
  -- Discount tracking
  discount_code_used TEXT,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(campaign_id, customer_id)
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_winback_campaigns_user ON winback_campaigns(user_id);
CREATE INDEX idx_winback_campaigns_status ON winback_campaigns(user_id, status);
CREATE INDEX idx_winback_campaigns_active ON winback_campaigns(user_id, starts_at, ends_at)
  WHERE status = 'active';

CREATE INDEX idx_winback_recipients_campaign ON winback_recipients(campaign_id);
CREATE INDEX idx_winback_recipients_customer ON winback_recipients(customer_id);
CREATE INDEX idx_winback_recipients_status ON winback_recipients(campaign_id, status);
CREATE INDEX idx_winback_recipients_pending ON winback_recipients(campaign_id, created_at)
  WHERE status = 'pending';

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE winback_campaigns ENABLE ROW LEVEL SECURITY;
ALTER TABLE winback_recipients ENABLE ROW LEVEL SECURITY;

CREATE POLICY winback_campaigns_all ON winback_campaigns FOR ALL USING (user_id = auth.uid());
CREATE POLICY winback_recipients_all ON winback_recipients FOR ALL USING (user_id = auth.uid());

CREATE TRIGGER winback_campaigns_updated_at BEFORE UPDATE ON winback_campaigns
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER winback_recipients_updated_at BEFORE UPDATE ON winback_recipients
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Get customers eligible for win-back
-- ============================================================================
CREATE OR REPLACE FUNCTION get_winback_eligible_customers(
  p_campaign_id UUID
)
RETURNS TABLE (
  customer_id UUID,
  email TEXT,
  first_name TEXT,
  stage TEXT,
  lifetime_value NUMERIC,
  primary_collection TEXT,
  days_inactive INTEGER
) AS $$
DECLARE
  v_campaign RECORD;
BEGIN
  SELECT * INTO v_campaign FROM winback_campaigns WHERE id = p_campaign_id;
  
  IF NOT FOUND THEN
    RETURN;
  END IF;
  
  RETURN QUERY
  SELECT 
    c.id AS customer_id,
    c.email,
    c.first_name,
    c.stage,
    c.lifetime_value,
    c.primary_collection,
    EXTRACT(DAY FROM NOW() - GREATEST(
      COALESCE(c.last_purchase_at, c.created_at),
      COALESCE(c.last_email_click_at, c.created_at)
    ))::INTEGER AS days_inactive
  FROM customers c
  WHERE c.user_id = v_campaign.user_id
    AND c.stage = ANY(v_campaign.target_stages)
    AND c.email_subscribed = true
    AND c.lifetime_value >= COALESCE(v_campaign.min_lifetime_value, 0)
    AND (
      array_length(v_campaign.target_collections, 1) IS NULL 
      OR c.primary_collection = ANY(v_campaign.target_collections)
    )
    AND EXTRACT(DAY FROM NOW() - GREATEST(
      COALESCE(c.last_purchase_at, c.created_at),
      COALESCE(c.last_email_click_at, c.created_at)
    )) >= v_campaign.min_days_inactive
    AND (
      v_campaign.max_days_inactive IS NULL 
      OR EXTRACT(DAY FROM NOW() - GREATEST(
        COALESCE(c.last_purchase_at, c.created_at),
        COALESCE(c.last_email_click_at, c.created_at)
      )) <= v_campaign.max_days_inactive
    )
    AND NOT EXISTS (
      SELECT 1 FROM winback_recipients wr
      WHERE wr.customer_id = c.id 
        AND wr.campaign_id = p_campaign_id
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### `types/winback.ts`
```typescript
export interface WinbackCampaign {
  id: string;
  user_id: string;
  name: string;
  description: string | null;
  target_stages: string[];
  min_days_inactive: number;
  max_days_inactive: number | null;
  min_lifetime_value: number | null;
  target_collections: string[];
  incentive_type: IncentiveType | null;
  incentive_value: number | null;
  discount_code: string | null;
  klaviyo_flow_id: string;
  send_delay_days: number;
  status: CampaignStatus;
  starts_at: string | null;
  ends_at: string | null;
  customers_targeted: number;
  emails_sent: number;
  emails_opened: number;
  emails_clicked: number;
  customers_recovered: number;
  revenue_recovered: number;
  created_at: string;
  updated_at: string;
}

export type IncentiveType = 
  | 'percentage_discount'
  | 'fixed_discount'
  | 'free_shipping'
  | 'gift_with_purchase'
  | 'exclusive_product';

export type CampaignStatus = 'draft' | 'active' | 'paused' | 'completed';

export interface WinbackRecipient {
  id: string;
  campaign_id: string;
  customer_id: string;
  user_id: string;
  status: RecipientStatus;
  sent_at: string | null;
  opened_at: string | null;
  clicked_at: string | null;
  recovered_at: string | null;
  recovery_order_id: string | null;
  recovery_order_value: number | null;
  discount_code_used: string | null;
  created_at: string;
  updated_at: string;
}

export type RecipientStatus = 
  | 'pending'
  | 'sent'
  | 'opened'
  | 'clicked'
  | 'recovered'
  | 'unsubscribed'
  | 'expired';

export interface CreateWinbackCampaignRequest {
  name: string;
  description?: string;
  targetStages?: string[];
  minDaysInactive: number;
  maxDaysInactive?: number;
  minLifetimeValue?: number;
  targetCollections?: string[];
  incentiveType?: IncentiveType;
  incentiveValue?: number;
  discountCode?: string;
  klaviyoFlowId: string;
  sendDelayDays?: number;
  startsAt?: string;
  endsAt?: string;
}
```

- **Step Dependencies**: Step 17.1
- **User Instructions**: Run migration

---

