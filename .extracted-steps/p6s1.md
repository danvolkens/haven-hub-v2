## Step 7.1: Create Quotes Database Schema

- **Task**: Create the database schema for quotes with collection, mood, and status tracking.

- **Files**:

### `supabase/migrations/006_quotes.sql`
```sql
-- ============================================================================
-- Migration: 006_quotes
-- Description: Quotes table with collection, mood, and generation tracking
-- Feature: 7 (Design Engine)
-- ============================================================================

-- ============================================================================
-- Quotes Table
-- ============================================================================
CREATE TABLE quotes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Quote content
  text TEXT NOT NULL,
  attribution TEXT, -- Optional author/source
  
  -- Classification per spec Feature 7
  collection TEXT NOT NULL CHECK (collection IN ('grounding', 'wholeness', 'growth')),
  mood TEXT NOT NULL CHECK (mood IN ('calm', 'warm', 'hopeful', 'reflective', 'empowering')),
  
  -- Tags for temporal content (Feature 41)
  temporal_tags TEXT[] NOT NULL DEFAULT '{}',
  
  -- Status
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'archived', 'generating')),
  
  -- Generation tracking
  assets_generated INTEGER NOT NULL DEFAULT 0,
  last_generated_at TIMESTAMPTZ,
  generation_settings JSONB, -- Stores settings used for last generation
  
  -- Performance tracking
  total_pins INTEGER NOT NULL DEFAULT 0,
  total_impressions INTEGER NOT NULL DEFAULT 0,
  total_saves INTEGER NOT NULL DEFAULT 0,
  total_clicks INTEGER NOT NULL DEFAULT 0,
  best_performing_asset_id UUID,
  
  -- Import tracking
  imported_from TEXT, -- 'csv', 'manual', 'api'
  import_batch_id UUID,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_quotes_user ON quotes(user_id);
CREATE INDEX idx_quotes_collection ON quotes(user_id, collection);
CREATE INDEX idx_quotes_mood ON quotes(user_id, mood);
CREATE INDEX idx_quotes_status ON quotes(user_id, status);
CREATE INDEX idx_quotes_temporal ON quotes USING GIN (temporal_tags);
CREATE INDEX idx_quotes_text_search ON quotes USING GIN (to_tsvector('english', text));

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE quotes ENABLE ROW LEVEL SECURITY;

CREATE POLICY quotes_select ON quotes FOR SELECT USING (user_id = auth.uid());
CREATE POLICY quotes_insert ON quotes FOR INSERT WITH CHECK (user_id = auth.uid());
CREATE POLICY quotes_update ON quotes FOR UPDATE USING (user_id = auth.uid());
CREATE POLICY quotes_delete ON quotes FOR DELETE USING (user_id = auth.uid());

-- ============================================================================
-- Trigger for updated_at
-- ============================================================================
CREATE TRIGGER quotes_updated_at
  BEFORE UPDATE ON quotes
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Assets Table (generated from quotes)
-- ============================================================================
CREATE TABLE assets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  quote_id UUID REFERENCES quotes(id) ON DELETE CASCADE NOT NULL,
  
  -- Asset details
  format TEXT NOT NULL, -- 'pinterest', 'instagram_post', 'instagram_story', 'print_8x10', etc.
  dimensions JSONB NOT NULL, -- { width: number, height: number }
  
  -- File locations
  file_url TEXT NOT NULL,
  file_key TEXT NOT NULL, -- R2 storage key
  thumbnail_url TEXT,
  
  -- Design metadata
  design_config JSONB NOT NULL DEFAULT '{}', -- Full design configuration used
  template_id TEXT, -- If using a template
  
  -- Quality scores per spec
  quality_scores JSONB NOT NULL DEFAULT '{}',
  -- { readability: 0.95, contrast: 0.88, composition: 0.92, overall: 0.91 }
  
  overall_score NUMERIC(4,3) GENERATED ALWAYS AS (
    (quality_scores->>'overall')::NUMERIC
  ) STORED,
  
  -- Flags
  flags TEXT[] NOT NULL DEFAULT '{}',
  flag_reasons JSONB NOT NULL DEFAULT '{}',
  
  -- Status
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN (
    'pending', 'approved', 'rejected', 'published', 'archived'
  )),
  
  -- Performance (aggregated from pins)
  total_pins INTEGER NOT NULL DEFAULT 0,
  total_impressions INTEGER NOT NULL DEFAULT 0,
  total_saves INTEGER NOT NULL DEFAULT 0,
  total_clicks INTEGER NOT NULL DEFAULT 0,
  
  -- Timestamps
  approved_at TIMESTAMPTZ,
  published_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Asset Indexes
-- ============================================================================
CREATE INDEX idx_assets_user ON assets(user_id);
CREATE INDEX idx_assets_quote ON assets(quote_id);
CREATE INDEX idx_assets_format ON assets(user_id, format);
CREATE INDEX idx_assets_status ON assets(user_id, status);
CREATE INDEX idx_assets_score ON assets(user_id, overall_score DESC) WHERE overall_score IS NOT NULL;
CREATE INDEX idx_assets_pending ON assets(user_id, created_at) WHERE status = 'pending';

-- ============================================================================
-- Asset RLS
-- ============================================================================
ALTER TABLE assets ENABLE ROW LEVEL SECURITY;

CREATE POLICY assets_select ON assets FOR SELECT USING (user_id = auth.uid());
CREATE POLICY assets_insert ON assets FOR INSERT WITH CHECK (user_id = auth.uid());
CREATE POLICY assets_update ON assets FOR UPDATE USING (user_id = auth.uid());
CREATE POLICY assets_delete ON assets FOR DELETE USING (user_id = auth.uid());

CREATE TRIGGER assets_updated_at
  BEFORE UPDATE ON assets
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Design Rules Table (user-configurable design settings)
-- ============================================================================
CREATE TABLE design_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Rule identification
  name TEXT NOT NULL,
  description TEXT,
  is_default BOOLEAN NOT NULL DEFAULT false,
  
  -- Collection/mood applicability
  applies_to_collections TEXT[] NOT NULL DEFAULT '{}', -- Empty = all
  applies_to_moods TEXT[] NOT NULL DEFAULT '{}', -- Empty = all
  
  -- Typography settings
  typography JSONB NOT NULL DEFAULT '{
    "font_family": "Cormorant Garamond",
    "font_weight": 400,
    "font_size_base": 48,
    "line_height": 1.4,
    "letter_spacing": 0,
    "text_transform": "none",
    "attribution_font_family": "Inter",
    "attribution_font_size": 14
  }',
  
  -- Color settings (per collection)
  colors JSONB NOT NULL DEFAULT '{
    "grounding": {
      "background": "#F5F3EF",
      "text": "#2D3E50",
      "accent": "#7A9E7E"
    },
    "wholeness": {
      "background": "#FAF9F7",
      "text": "#2D3E50",
      "accent": "#4A9B9B"
    },
    "growth": {
      "background": "#F8F6F3",
      "text": "#2D3E50",
      "accent": "#D4A574"
    }
  }',
  
  -- Layout settings
  layout JSONB NOT NULL DEFAULT '{
    "padding": 60,
    "text_alignment": "center",
    "vertical_alignment": "center",
    "max_width_percent": 80,
    "include_attribution": true,
    "include_logo": false,
    "logo_position": "bottom-right",
    "logo_size": 40
  }',
  
  -- Decorative elements
  decorations JSONB NOT NULL DEFAULT '{
    "border": false,
    "border_width": 1,
    "border_color": "accent",
    "shadow": false,
    "background_pattern": null,
    "corner_style": "square"
  }',
  
  -- Output settings
  output_formats TEXT[] NOT NULL DEFAULT ARRAY['pinterest', 'instagram_post'],
  print_sizes TEXT[] NOT NULL DEFAULT ARRAY['8x10', '11x14'],
  
  -- Quality thresholds
  quality_thresholds JSONB NOT NULL DEFAULT '{
    "min_readability": 0.7,
    "min_contrast": 0.6,
    "min_overall": 0.65,
    "auto_approve_threshold": 0.85
  }',
  
  priority INTEGER NOT NULL DEFAULT 0,
  enabled BOOLEAN NOT NULL DEFAULT true,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_design_rules_user ON design_rules(user_id);
CREATE INDEX idx_design_rules_default ON design_rules(user_id, is_default) WHERE is_default = true;

ALTER TABLE design_rules ENABLE ROW LEVEL SECURITY;

CREATE POLICY design_rules_all ON design_rules FOR ALL USING (user_id = auth.uid());

CREATE TRIGGER design_rules_updated_at
  BEFORE UPDATE ON design_rules
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Get applicable design rules for a quote
-- ============================================================================
CREATE OR REPLACE FUNCTION get_applicable_design_rules(
  p_user_id UUID,
  p_collection TEXT,
  p_mood TEXT
)
RETURNS SETOF design_rules AS $$
BEGIN
  RETURN QUERY
  SELECT * FROM design_rules
  WHERE user_id = p_user_id
    AND enabled = true
    AND (
      array_length(applies_to_collections, 1) IS NULL 
      OR p_collection = ANY(applies_to_collections)
    )
    AND (
      array_length(applies_to_moods, 1) IS NULL 
      OR p_mood = ANY(applies_to_moods)
    )
  ORDER BY 
    CASE WHEN is_default THEN 0 ELSE 1 END,
    priority DESC,
    created_at ASC
  LIMIT 1;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- Function: Create default design rules for new user
-- ============================================================================
CREATE OR REPLACE FUNCTION create_default_design_rules()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO design_rules (user_id, name, description, is_default)
  VALUES (
    NEW.id,
    'Haven & Hold Default',
    'Default design rules matching Haven & Hold brand guidelines',
    true
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Attach to user creation (after user_settings)
CREATE TRIGGER on_auth_user_created_design_rules
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION create_default_design_rules();
```

### `types/quotes.ts`
```typescript
import type { Collection, Mood } from '@/lib/constants';

export interface Quote {
  id: string;
  user_id: string;
  text: string;
  attribution: string | null;
  collection: Collection;
  mood: Mood;
  temporal_tags: string[];
  status: 'active' | 'archived' | 'generating';
  assets_generated: number;
  last_generated_at: string | null;
  generation_settings: GenerationSettings | null;
  total_pins: number;
  total_impressions: number;
  total_saves: number;
  total_clicks: number;
  best_performing_asset_id: string | null;
  imported_from: 'csv' | 'manual' | 'api' | null;
  import_batch_id: string | null;
  created_at: string;
  updated_at: string;
}

export interface GenerationSettings {
  designRuleId: string;
  outputFormats: string[];
  printSizes: string[];
  generateMockups: boolean;
  mockupScenes: string[];
}

export interface Asset {
  id: string;
  user_id: string;
  quote_id: string;
  format: string;
  dimensions: { width: number; height: number };
  file_url: string;
  file_key: string;
  thumbnail_url: string | null;
  design_config: DesignConfig;
  template_id: string | null;
  quality_scores: QualityScores;
  overall_score: number | null;
  flags: string[];
  flag_reasons: Record<string, string>;
  status: 'pending' | 'approved' | 'rejected' | 'published' | 'archived';
  total_pins: number;
  total_impressions: number;
  total_saves: number;
  total_clicks: number;
  approved_at: string | null;
  published_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface QualityScores {
  readability: number;
  contrast: number;
  composition: number;
  overall: number;
}

export interface DesignConfig {
  typography: TypographyConfig;
  colors: ColorConfig;
  layout: LayoutConfig;
  decorations: DecorationConfig;
}

export interface TypographyConfig {
  font_family: string;
  font_weight: number;
  font_size_base: number;
  line_height: number;
  letter_spacing: number;
  text_transform: 'none' | 'uppercase' | 'lowercase' | 'capitalize';
  attribution_font_family: string;
  attribution_font_size: number;
}

export interface ColorConfig {
  background: string;
  text: string;
  accent: string;
}

export interface LayoutConfig {
  padding: number;
  text_alignment: 'left' | 'center' | 'right';
  vertical_alignment: 'top' | 'center' | 'bottom';
  max_width_percent: number;
  include_attribution: boolean;
  include_logo: boolean;
  logo_position: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right';
  logo_size: number;
}

export interface DecorationConfig {
  border: boolean;
  border_width: number;
  border_color: string;
  shadow: boolean;
  background_pattern: string | null;
  corner_style: 'square' | 'rounded' | 'pill';
}

export interface DesignRule {
  id: string;
  user_id: string;
  name: string;
  description: string | null;
  is_default: boolean;
  applies_to_collections: Collection[];
  applies_to_moods: Mood[];
  typography: TypographyConfig;
  colors: Record<Collection, ColorConfig>;
  layout: LayoutConfig;
  decorations: DecorationConfig;
  output_formats: string[];
  print_sizes: string[];
  quality_thresholds: {
    min_readability: number;
    min_contrast: number;
    min_overall: number;
    auto_approve_threshold: number;
  };
  priority: number;
  enabled: boolean;
  created_at: string;
  updated_at: string;
}
```

- **Step Dependencies**: Step 2.1
- **User Instructions**: Run migration

---

