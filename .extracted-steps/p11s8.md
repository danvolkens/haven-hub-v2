## Step 22.1: Create Intelligence Database Schema

- **Task**: Create database schema for AI-generated insights and recommendations.

- **Files**:

### `supabase/migrations/019_intelligence.sql`
```sql
-- ============================================================================
-- Migration: 019_intelligence
-- Description: AI intelligence engine for insights and recommendations
-- Feature: 22 (AI Intelligence)
-- ============================================================================

-- ============================================================================
-- Insights Table
-- ============================================================================
CREATE TABLE insights (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Insight details
  type TEXT NOT NULL CHECK (type IN (
    'performance',      -- Content performance insight
    'trend',            -- Trending topic/content
    'opportunity',      -- Growth opportunity
    'warning',          -- Risk or issue alert
    'recommendation',   -- Action recommendation
    'anomaly'           -- Unusual pattern detected
  )),
  
  category TEXT NOT NULL CHECK (category IN (
    'content', 'pinterest', 'products', 'customers', 'revenue', 'operations'
  )),
  
  -- Content
  title TEXT NOT NULL,
  summary TEXT NOT NULL,
  details JSONB NOT NULL DEFAULT '{}',
  
  -- Priority
  priority TEXT NOT NULL DEFAULT 'medium' CHECK (priority IN (
    'low', 'medium', 'high', 'critical'
  )),
  
  -- Related entities
  related_quotes UUID[] DEFAULT '{}',
  related_assets UUID[] DEFAULT '{}',
  related_pins UUID[] DEFAULT '{}',
  related_products UUID[] DEFAULT '{}',
  
  -- Actions
  suggested_actions JSONB DEFAULT '[]',
  -- [{ action: string, description: string, impact: string }]
  
  -- Status
  status TEXT NOT NULL DEFAULT 'new' CHECK (status IN (
    'new', 'viewed', 'actioned', 'dismissed'
  )),
  actioned_at TIMESTAMPTZ,
  
  -- Validity
  valid_from TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  valid_until TIMESTAMPTZ,
  
  -- AI metadata
  confidence_score NUMERIC(4,3), -- 0-1
  model_version TEXT,
  generation_context JSONB DEFAULT '{}',
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Recommendations Table
-- ============================================================================
CREATE TABLE recommendations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Recommendation type
  type TEXT NOT NULL CHECK (type IN (
    'quote_suggestion',    -- New quote ideas
    'design_variation',    -- Asset design tweaks
    'posting_time',        -- Optimal posting schedule
    'collection_focus',    -- Which collection to prioritize
    'product_idea',        -- New product suggestions
    'campaign_timing',     -- Campaign scheduling
    'customer_segment',    -- Segment to target
    'copy_improvement'     -- Pin copy suggestions
  )),
  
  -- Content
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  rationale TEXT, -- Why this recommendation
  
  -- Details
  data JSONB NOT NULL DEFAULT '{}',
  -- Varies by type:
  -- quote_suggestion: { theme, mood, collection, example_text }
  -- posting_time: { day, hour, expected_engagement }
  -- etc.
  
  -- Expected impact
  expected_impact TEXT,
  impact_score NUMERIC(4,3), -- 0-1
  
  -- Status
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN (
    'pending', 'accepted', 'rejected', 'implemented'
  )),
  
  -- Feedback
  user_feedback TEXT,
  feedback_rating INTEGER CHECK (feedback_rating BETWEEN 1 AND 5),
  
  -- AI metadata
  confidence_score NUMERIC(4,3),
  model_version TEXT,
  
  expires_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- AI Analysis Jobs Table
-- ============================================================================
CREATE TABLE ai_analysis_jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Job type
  type TEXT NOT NULL CHECK (type IN (
    'daily_analysis',
    'weekly_analysis',
    'content_analysis',
    'performance_analysis',
    'trend_detection',
    'anomaly_detection'
  )),
  
  -- Status
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN (
    'pending', 'processing', 'completed', 'failed'
  )),
  
  -- Results
  insights_generated INTEGER NOT NULL DEFAULT 0,
  recommendations_generated INTEGER NOT NULL DEFAULT 0,
  
  -- Timing
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  
  -- Error
  error_message TEXT,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_insights_user ON insights(user_id);
CREATE INDEX idx_insights_type ON insights(user_id, type);
CREATE INDEX idx_insights_status ON insights(user_id, status);
CREATE INDEX idx_insights_priority ON insights(user_id, priority)
  WHERE status = 'new';
CREATE INDEX idx_insights_valid ON insights(user_id, valid_from, valid_until)
  WHERE status IN ('new', 'viewed');

CREATE INDEX idx_recommendations_user ON recommendations(user_id);
CREATE INDEX idx_recommendations_type ON recommendations(user_id, type);
CREATE INDEX idx_recommendations_status ON recommendations(user_id, status)
  WHERE status = 'pending';

CREATE INDEX idx_ai_jobs_user ON ai_analysis_jobs(user_id);
CREATE INDEX idx_ai_jobs_status ON ai_analysis_jobs(user_id, status)
  WHERE status IN ('pending', 'processing');

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE insights ENABLE ROW LEVEL SECURITY;
ALTER TABLE recommendations ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_analysis_jobs ENABLE ROW LEVEL SECURITY;

CREATE POLICY insights_all ON insights FOR ALL USING (user_id = auth.uid());
CREATE POLICY recommendations_all ON recommendations FOR ALL USING (user_id = auth.uid());
CREATE POLICY ai_jobs_all ON ai_analysis_jobs FOR ALL USING (user_id = auth.uid());

CREATE TRIGGER insights_updated_at BEFORE UPDATE ON insights
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER recommendations_updated_at BEFORE UPDATE ON recommendations
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### `types/intelligence.ts`
```typescript
export interface Insight {
  id: string;
  user_id: string;
  type: InsightType;
  category: InsightCategory;
  title: string;
  summary: string;
  details: Record<string, unknown>;
  priority: 'low' | 'medium' | 'high' | 'critical';
  related_quotes: string[];
  related_assets: string[];
  related_pins: string[];
  related_products: string[];
  suggested_actions: SuggestedAction[];
  status: InsightStatus;
  actioned_at: string | null;
  valid_from: string;
  valid_until: string | null;
  confidence_score: number | null;
  model_version: string | null;
  generation_context: Record<string, unknown>;
  created_at: string;
  updated_at: string;
}

export type InsightType = 
  | 'performance' 
  | 'trend' 
  | 'opportunity' 
  | 'warning' 
  | 'recommendation' 
  | 'anomaly';

export type InsightCategory = 
  | 'content' 
  | 'pinterest' 
  | 'products' 
  | 'customers' 
  | 'revenue' 
  | 'operations';

export type InsightStatus = 'new' | 'viewed' | 'actioned' | 'dismissed';

export interface SuggestedAction {
  action: string;
  description: string;
  impact: string;
}

export interface Recommendation {
  id: string;
  user_id: string;
  type: RecommendationType;
  title: string;
  description: string;
  rationale: string | null;
  data: Record<string, unknown>;
  expected_impact: string | null;
  impact_score: number | null;
  status: RecommendationStatus;
  user_feedback: string | null;
  feedback_rating: number | null;
  confidence_score: number | null;
  model_version: string | null;
  expires_at: string | null;
  created_at: string;
  updated_at: string;
}

export type RecommendationType = 
  | 'quote_suggestion'
  | 'design_variation'
  | 'posting_time'
  | 'collection_focus'
  | 'product_idea'
  | 'campaign_timing'
  | 'customer_segment'
  | 'copy_improvement';

export type RecommendationStatus = 'pending' | 'accepted' | 'rejected' | 'implemented';

export interface AIAnalysisJob {
  id: string;
  user_id: string;
  type: AnalysisJobType;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  insights_generated: number;
  recommendations_generated: number;
  started_at: string | null;
  completed_at: string | null;
  error_message: string | null;
  created_at: string;
}

export type AnalysisJobType = 
  | 'daily_analysis'
  | 'weekly_analysis'
  | 'content_analysis'
  | 'performance_analysis'
  | 'trend_detection'
  | 'anomaly_detection';
```

- **Step Dependencies**: Step 21.2
- **User Instructions**: Run migration

---

