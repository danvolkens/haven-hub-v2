## Step 20.1: Create Attribution Database Schema

- **Task**: Create database schema for tracking content attribution and revenue.

- **Files**:

### `supabase/migrations/017_attribution.sql`
```sql
-- ============================================================================
-- Migration: 017_attribution
-- Description: Attribution tracking for content to revenue
-- Feature: 20 (Attribution)
-- ============================================================================

-- ============================================================================
-- Attribution Events Table
-- ============================================================================
CREATE TABLE attribution_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Event type
  event_type TEXT NOT NULL CHECK (event_type IN (
    'impression', 'click', 'save', 'add_to_cart', 'checkout', 'purchase'
  )),
  
  -- Source content
  source_type TEXT NOT NULL CHECK (source_type IN (
    'pin', 'ad', 'email', 'landing_page', 'direct'
  )),
  source_id UUID, -- pin_id, promoted_pin_id, etc.
  
  -- Related content
  quote_id UUID REFERENCES quotes(id) ON DELETE SET NULL,
  asset_id UUID REFERENCES assets(id) ON DELETE SET NULL,
  product_id UUID REFERENCES products(id) ON DELETE SET NULL,
  
  -- Customer
  customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,
  session_id TEXT, -- For anonymous tracking
  
  -- UTM tracking
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  utm_content TEXT,
  utm_term TEXT,
  
  -- Attribution window
  attribution_window TEXT DEFAULT '7d' CHECK (attribution_window IN (
    '1d', '7d', '28d', '90d'
  )),
  
  -- Order details (for purchase events)
  order_id TEXT,
  order_total NUMERIC(10,2),
  
  -- Timestamp
  occurred_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Content Performance Table (aggregated metrics)
-- ============================================================================
CREATE TABLE content_performance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Content reference
  content_type TEXT NOT NULL CHECK (content_type IN (
    'quote', 'asset', 'pin', 'product', 'collection'
  )),
  content_id UUID NOT NULL,
  
  -- Time period
  period_type TEXT NOT NULL CHECK (period_type IN ('day', 'week', 'month')),
  period_start DATE NOT NULL,
  
  -- Impressions & Engagement
  impressions INTEGER NOT NULL DEFAULT 0,
  clicks INTEGER NOT NULL DEFAULT 0,
  saves INTEGER NOT NULL DEFAULT 0,
  
  -- Conversion funnel
  add_to_carts INTEGER NOT NULL DEFAULT 0,
  checkouts INTEGER NOT NULL DEFAULT 0,
  purchases INTEGER NOT NULL DEFAULT 0,
  
  -- Revenue
  revenue NUMERIC(12,2) NOT NULL DEFAULT 0,
  
  -- Calculated metrics
  ctr NUMERIC(6,4), -- click-through rate
  conversion_rate NUMERIC(6,4), -- purchase / clicks
  revenue_per_impression NUMERIC(8,4),
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, content_type, content_id, period_type, period_start)
);

-- ============================================================================
-- Attribution Models Table (for configuring attribution rules)
-- ============================================================================
CREATE TABLE attribution_models (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Model configuration
  name TEXT NOT NULL,
  model_type TEXT NOT NULL CHECK (model_type IN (
    'first_touch',    -- Credit to first touchpoint
    'last_touch',     -- Credit to last touchpoint
    'linear',         -- Equal credit to all touchpoints
    'time_decay',     -- More credit to recent touchpoints
    'position_based'  -- 40% first, 40% last, 20% middle
  )),
  
  -- Attribution window
  window_days INTEGER NOT NULL DEFAULT 7,
  
  -- Active
  is_default BOOLEAN NOT NULL DEFAULT false,
  is_active BOOLEAN NOT NULL DEFAULT true,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Revenue Attribution Table (revenue split by touchpoints)
-- ============================================================================
CREATE TABLE revenue_attribution (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Order reference
  order_id TEXT NOT NULL,
  order_total NUMERIC(10,2) NOT NULL,
  order_date TIMESTAMPTZ NOT NULL,
  customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,
  
  -- Attribution model used
  model_id UUID REFERENCES attribution_models(id) ON DELETE SET NULL,
  
  -- Attributed content
  content_type TEXT NOT NULL,
  content_id UUID NOT NULL,
  
  -- Attribution
  attribution_weight NUMERIC(5,4) NOT NULL, -- 0 to 1
  attributed_revenue NUMERIC(10,2) NOT NULL, -- order_total * weight
  
  -- Source touchpoint
  touchpoint_type TEXT NOT NULL, -- pin, ad, email, etc.
  touchpoint_id UUID,
  touchpoint_at TIMESTAMPTZ NOT NULL,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_attribution_events_user ON attribution_events(user_id);
CREATE INDEX idx_attribution_events_source ON attribution_events(source_type, source_id);
CREATE INDEX idx_attribution_events_quote ON attribution_events(quote_id) WHERE quote_id IS NOT NULL;
CREATE INDEX idx_attribution_events_product ON attribution_events(product_id) WHERE product_id IS NOT NULL;
CREATE INDEX idx_attribution_events_customer ON attribution_events(customer_id) WHERE customer_id IS NOT NULL;
CREATE INDEX idx_attribution_events_date ON attribution_events(user_id, occurred_at);
CREATE INDEX idx_attribution_events_session ON attribution_events(session_id) WHERE session_id IS NOT NULL;

CREATE INDEX idx_content_performance_content ON content_performance(content_type, content_id);
CREATE INDEX idx_content_performance_period ON content_performance(user_id, period_type, period_start);

CREATE INDEX idx_revenue_attribution_order ON revenue_attribution(user_id, order_id);
CREATE INDEX idx_revenue_attribution_content ON revenue_attribution(content_type, content_id);
CREATE INDEX idx_revenue_attribution_date ON revenue_attribution(user_id, order_date);

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE attribution_events ENABLE ROW LEVEL SECURITY;
ALTER TABLE content_performance ENABLE ROW LEVEL SECURITY;
ALTER TABLE attribution_models ENABLE ROW LEVEL SECURITY;
ALTER TABLE revenue_attribution ENABLE ROW LEVEL SECURITY;

CREATE POLICY attribution_events_all ON attribution_events FOR ALL USING (user_id = auth.uid());
CREATE POLICY content_performance_all ON content_performance FOR ALL USING (user_id = auth.uid());
CREATE POLICY attribution_models_all ON attribution_models FOR ALL USING (user_id = auth.uid());
CREATE POLICY revenue_attribution_all ON revenue_attribution FOR ALL USING (user_id = auth.uid());

CREATE TRIGGER content_performance_updated_at BEFORE UPDATE ON content_performance
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER attribution_models_updated_at BEFORE UPDATE ON attribution_models
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Insert default attribution model
-- ============================================================================
-- Will be created per-user on setup

-- ============================================================================
-- Function: Calculate content performance metrics
-- ============================================================================
CREATE OR REPLACE FUNCTION calculate_content_metrics()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.clicks > 0 THEN
    NEW.ctr := NEW.clicks::NUMERIC / NULLIF(NEW.impressions, 0);
  END IF;
  
  IF NEW.clicks > 0 THEN
    NEW.conversion_rate := NEW.purchases::NUMERIC / NEW.clicks;
  END IF;
  
  IF NEW.impressions > 0 THEN
    NEW.revenue_per_impression := NEW.revenue / NEW.impressions;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER content_performance_metrics
  BEFORE INSERT OR UPDATE OF impressions, clicks, purchases, revenue ON content_performance
  FOR EACH ROW EXECUTE FUNCTION calculate_content_metrics();

-- ============================================================================
-- Function: Get top performing content
-- ============================================================================
CREATE OR REPLACE FUNCTION get_top_performing_content(
  p_user_id UUID,
  p_content_type TEXT,
  p_period_type TEXT DEFAULT 'week',
  p_limit INTEGER DEFAULT 10
)
RETURNS TABLE (
  content_id UUID,
  impressions INTEGER,
  clicks INTEGER,
  purchases INTEGER,
  revenue NUMERIC,
  ctr NUMERIC,
  conversion_rate NUMERIC
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    cp.content_id,
    SUM(cp.impressions)::INTEGER,
    SUM(cp.clicks)::INTEGER,
    SUM(cp.purchases)::INTEGER,
    SUM(cp.revenue),
    AVG(cp.ctr),
    AVG(cp.conversion_rate)
  FROM content_performance cp
  WHERE cp.user_id = p_user_id
    AND cp.content_type = p_content_type
    AND cp.period_type = p_period_type
    AND cp.period_start >= CURRENT_DATE - INTERVAL '30 days'
  GROUP BY cp.content_id
  ORDER BY SUM(cp.revenue) DESC
  LIMIT p_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### `types/attribution.ts`
```typescript
export interface AttributionEvent {
  id: string;
  user_id: string;
  event_type: AttributionEventType;
  source_type: AttributionSourceType;
  source_id: string | null;
  quote_id: string | null;
  asset_id: string | null;
  product_id: string | null;
  customer_id: string | null;
  session_id: string | null;
  utm_source: string | null;
  utm_medium: string | null;
  utm_campaign: string | null;
  utm_content: string | null;
  utm_term: string | null;
  attribution_window: '1d' | '7d' | '28d' | '90d';
  order_id: string | null;
  order_total: number | null;
  occurred_at: string;
  created_at: string;
}

export type AttributionEventType = 
  | 'impression' 
  | 'click' 
  | 'save' 
  | 'add_to_cart' 
  | 'checkout' 
  | 'purchase';

export type AttributionSourceType = 
  | 'pin' 
  | 'ad' 
  | 'email' 
  | 'landing_page' 
  | 'direct';

export interface ContentPerformance {
  id: string;
  user_id: string;
  content_type: ContentType;
  content_id: string;
  period_type: 'day' | 'week' | 'month';
  period_start: string;
  impressions: number;
  clicks: number;
  saves: number;
  add_to_carts: number;
  checkouts: number;
  purchases: number;
  revenue: number;
  ctr: number | null;
  conversion_rate: number | null;
  revenue_per_impression: number | null;
  created_at: string;
  updated_at: string;
}

export type ContentType = 'quote' | 'asset' | 'pin' | 'product' | 'collection';

export interface AttributionModel {
  id: string;
  user_id: string;
  name: string;
  model_type: AttributionModelType;
  window_days: number;
  is_default: boolean;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export type AttributionModelType = 
  | 'first_touch' 
  | 'last_touch' 
  | 'linear' 
  | 'time_decay' 
  | 'position_based';

export interface RevenueAttribution {
  id: string;
  user_id: string;
  order_id: string;
  order_total: number;
  order_date: string;
  customer_id: string | null;
  model_id: string | null;
  content_type: string;
  content_id: string;
  attribution_weight: number;
  attributed_revenue: number;
  touchpoint_type: string;
  touchpoint_id: string | null;
  touchpoint_at: string;
  created_at: string;
}

export interface TopPerformingContent {
  content_id: string;
  impressions: number;
  clicks: number;
  purchases: number;
  revenue: number;
  ctr: number;
  conversion_rate: number;
}
```

- **Step Dependencies**: Step 17.1
- **User Instructions**: Run migration

---

