## Step 1.10: Create Dashboard Layout and React Query Setup

- **Task**: Implement the authenticated dashboard layout and configure TanStack Query for data fetching.

- **Files**:

### `lib/query-client.ts`
```typescript
import { QueryClient, type QueryClientConfig } from '@tanstack/react-query';

const queryClientConfig: QueryClientConfig = {
  defaultOptions: {
    queries: {
      staleTime: 60 * 1000, // 1 minute
      gcTime: 5 * 60 * 1000, // 5 minutes (formerly cacheTime)
      retry: (failureCount, error) => {
        // Don't retry on 4xx errors
        if (error instanceof Error && 'status' in error) {
          const status = (error as Error & { status: number }).status;
          if (status >= 400 && status < 500) {
            return false;
          }
        }
        return failureCount < 3;
      },
      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
      refetchOnWindowFocus: true,
      refetchOnReconnect: true,
    },
    mutations: {
      retry: false,
    },
  },
};

// Factory function to create a new QueryClient
export function makeQueryClient() {
  return new QueryClient(queryClientConfig);
}

// Singleton for browser usage
let browserQueryClient: QueryClient | undefined = undefined;

export function getQueryClient() {
  if (typeof window === 'undefined') {
    // Server: always make a new query client
    return makeQueryClient();
  } else {
    // Browser: make a new query client if we don't already have one
    if (!browserQueryClient) {
      browserQueryClient = makeQueryClient();
    }
    return browserQueryClient;
  }
}
```

### `components/providers/query-provider.tsx`
```typescript
'use client';

import { QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { useState, type ReactNode } from 'react';
import { makeQueryClient } from '@/lib/query-client';

export function QueryProvider({ children }: { children: ReactNode }) {
  const [queryClient] = useState(() => makeQueryClient());

  return (
    <QueryClientProvider client={queryClient}>
      {children}
      {process.env.NODE_ENV === 'development' && (
        <ReactQueryDevtools initialIsOpen={false} buttonPosition="bottom-left" />
      )}
    </QueryClientProvider>
  );
}
```

### `components/providers/toast-provider.tsx`
```typescript
'use client';

import { createContext, useContext, useState, useCallback, type ReactNode } from 'react';
import { X, CheckCircle, AlertCircle, AlertTriangle, Info } from 'lucide-react';
import { cn } from '@/lib/utils';

type ToastVariant = 'success' | 'error' | 'warning' | 'info';

interface Toast {
  id: string;
  message: string;
  variant: ToastVariant;
  action?: {
    label: string;
    onClick: () => void;
  };
}

interface ToastContextValue {
  toasts: Toast[];
  toast: (message: string, variant?: ToastVariant, action?: Toast['action']) => void;
  dismiss: (id: string) => void;
}

const ToastContext = createContext<ToastContextValue | null>(null);

const TOAST_DURATION = 5000;
const MAX_TOASTS = 5;

export function ToastProvider({ children }: { children: ReactNode }) {
  const [toasts, setToasts] = useState<Toast[]>([]);

  const dismiss = useCallback((id: string) => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  }, []);

  const toast = useCallback(
    (message: string, variant: ToastVariant = 'info', action?: Toast['action']) => {
      const id = `${Date.now()}-${Math.random().toString(36).slice(2)}`;

      setToasts((prev) => {
        const newToasts = [...prev, { id, message, variant, action }];
        // Limit to MAX_TOASTS
        if (newToasts.length > MAX_TOASTS) {
          return newToasts.slice(-MAX_TOASTS);
        }
        return newToasts;
      });

      // Auto-dismiss after duration
      setTimeout(() => {
        dismiss(id);
      }, TOAST_DURATION);

      return id;
    },
    [dismiss]
  );

  return (
    <ToastContext.Provider value={{ toasts, toast, dismiss }}>
      {children}
      <ToastContainer toasts={toasts} onDismiss={dismiss} />
    </ToastContext.Provider>
  );
}

export function useToast() {
  const context = useContext(ToastContext);
  if (!context) {
    throw new Error('useToast must be used within a ToastProvider');
  }
  return context;
}

const variantConfig = {
  success: {
    icon: CheckCircle,
    bgClass: 'bg-success/10 border-success/20',
    iconClass: 'text-success',
  },
  error: {
    icon: AlertCircle,
    bgClass: 'bg-error/10 border-error/20',
    iconClass: 'text-error',
  },
  warning: {
    icon: AlertTriangle,
    bgClass: 'bg-warning/10 border-warning/20',
    iconClass: 'text-warning',
  },
  info: {
    icon: Info,
    bgClass: 'bg-info/10 border-info/20',
    iconClass: 'text-info',
  },
};

function ToastContainer({
  toasts,
  onDismiss,
}: {
  toasts: Toast[];
  onDismiss: (id: string) => void;
}) {
  if (toasts.length === 0) return null;

  return (
    <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2 w-full max-w-sm">
      {toasts.map((toast) => {
        const config = variantConfig[toast.variant];
        const Icon = config.icon;

        return (
          <div
            key={toast.id}
            className={cn(
              'flex items-start gap-3 rounded-lg border p-4 shadow-elevation-2 bg-surface animate-slide-up',
              config.bgClass
            )}
            role="alert"
          >
            <Icon className={cn('h-5 w-5 shrink-0', config.iconClass)} />
            <div className="flex-1 min-w-0">
              <p className="text-body text-charcoal">{toast.message}</p>
              {toast.action && (
                <button
                  className="mt-1 text-body-sm font-medium text-sage hover:text-sage/80"
                  onClick={() => {
                    toast.action?.onClick();
                    onDismiss(toast.id);
                  }}
                >
                  {toast.action.label}
                </button>
              )}
            </div>
            <button
              className="shrink-0 text-[var(--color-text-tertiary)] hover:text-charcoal"
              onClick={() => onDismiss(toast.id)}
              aria-label="Dismiss"
            >
              <X className="h-4 w-4" />
            </button>
          </div>
        );
      })}
    </div>
  );
}
```

### `components/providers/index.tsx`
```typescript
'use client';

import { type ReactNode } from 'react';
import { QueryProvider } from './query-provider';
import { ToastProvider } from './toast-provider';
import { AuthProvider } from '@/contexts/auth-context';

interface ProvidersProps {
  children: ReactNode;
}

export function Providers({ children }: ProvidersProps) {
  return (
    <QueryProvider>
      <AuthProvider>
        <ToastProvider>{children}</ToastProvider>
      </AuthProvider>
    </QueryProvider>
  );
}
```

### Update `app/layout.tsx`
```typescript
import type { Metadata } from 'next';
import { Inter, JetBrains_Mono } from 'next/font/google';
import { Providers } from '@/components/providers';
import './globals.css';

const inter = Inter({
  subsets: ['latin'],
  variable: '--font-primary',
  display: 'swap',
});

const jetbrainsMono = JetBrains_Mono({
  subsets: ['latin'],
  variable: '--font-mono',
  display: 'swap',
});

export const metadata: Metadata = {
  title: 'Haven Hub - Marketing Operations Platform',
  description: 'Comprehensive marketing operations platform for Haven & Hold',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" className={`${inter.variable} ${jetbrainsMono.variable}`}>
      <body className="bg-canvas text-charcoal font-primary antialiased">
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
```

### `lib/navigation.ts`
```typescript
import {
  LayoutDashboard,
  Inbox,
  Quote,
  Image,
  Pin,
  Megaphone,
  FlaskConical,
  HelpCircle,
  Layers,
  MousePointerClick,
  Users,
  UserPlus,
  Gift,
  Ticket,
  BarChart3,
  Calendar,
  Link as LinkIcon,
  Share2,
  Settings,
  Heart,
  ShoppingBag,
} from 'lucide-react';
import type { LucideIcon } from 'lucide-react';

export interface NavItem {
  name: string;
  href: string;
  icon: LucideIcon;
  badge?: {
    queryKey: string[];
    getValue: (data: unknown) => number;
  };
}

export interface NavSection {
  name: string;
  items: NavItem[];
}

export const navigation: (NavItem | NavSection)[] = [
  {
    name: 'Dashboard',
    href: '/dashboard',
    icon: LayoutDashboard,
  },
  {
    name: 'Approvals',
    href: '/dashboard/approval-queue',
    icon: Inbox,
    badge: {
      queryKey: ['approval-counts'],
      getValue: (data: unknown) => {
        if (data && typeof data === 'object' && 'total' in data) {
          return (data as { total: number }).total;
        }
        return 0;
      },
    },
  },
  {
    name: 'Create',
    items: [
      { name: 'Quotes', href: '/dashboard/quotes', icon: Quote },
      { name: 'Assets', href: '/dashboard/assets', icon: Image },
    ],
  },
  {
    name: 'Pinterest',
    items: [
      { name: 'Manager', href: '/dashboard/pinterest', icon: Pin },
      { name: 'Ads', href: '/dashboard/pinterest/ads', icon: Megaphone },
      { name: 'Tests', href: '/dashboard/pinterest/tests', icon: FlaskConical },
    ],
  },
  {
    name: 'Leads',
    items: [
      { name: 'Quiz', href: '/dashboard/leads/quiz', icon: HelpCircle },
      { name: 'Landing Pages', href: '/dashboard/leads/landing-pages', icon: Layers },
      { name: 'Popups', href: '/dashboard/leads/popups', icon: MousePointerClick },
      { name: 'Abandonment', href: '/dashboard/leads/abandonment', icon: ShoppingBag },
    ],
  },
  {
    name: 'Customers',
    items: [
      { name: 'All', href: '/dashboard/customers', icon: Users },
      { name: 'Referrals', href: '/dashboard/customers/referrals', icon: UserPlus },
      { name: 'Win-Back', href: '/dashboard/customers/win-back', icon: Heart },
      { name: 'Gifts', href: '/dashboard/customers/gifts', icon: Gift },
    ],
  },
  {
    name: 'Campaigns',
    items: [
      { name: 'All', href: '/dashboard/campaigns', icon: Megaphone },
      { name: 'Coupons', href: '/dashboard/campaigns/coupons', icon: Ticket },
      { name: 'Calendar', href: '/dashboard/campaigns/calendar', icon: Calendar },
    ],
  },
  {
    name: 'Analytics',
    items: [
      { name: 'Attribution', href: '/dashboard/analytics/attribution', icon: BarChart3 },
      { name: 'Collections', href: '/dashboard/analytics/collections', icon: Layers },
    ],
  },
  {
    name: 'Content',
    items: [
      { name: 'Link-in-Bio', href: '/dashboard/content/link-in-bio', icon: LinkIcon },
      { name: 'Cross-Platform', href: '/dashboard/content/cross-platform', icon: Share2 },
    ],
  },
  {
    name: 'Settings',
    href: '/dashboard/settings',
    icon: Settings,
  },
];

export function isNavSection(item: NavItem | NavSection): item is NavSection {
  return 'items' in item;
}
```

### `components/layout/sidebar.tsx`
```typescript
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { ChevronLeft, ChevronRight, LogOut } from 'lucide-react';
import { useQuery } from '@tanstack/react-query';
import { cn } from '@/lib/utils';
import { navigation, isNavSection, type NavItem, type NavSection } from '@/lib/navigation';
import { Badge, Button } from '@/components/ui';
import { useAuthContext } from '@/contexts/auth-context';

export function Sidebar() {
  const [collapsed, setCollapsed] = useState(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('sidebar-collapsed') === 'true';
    }
    return false;
  });
  const pathname = usePathname();
  const { user, signOut } = useAuthContext();

  const handleToggle = () => {
    const newState = !collapsed;
    setCollapsed(newState);
    localStorage.setItem('sidebar-collapsed', String(newState));
  };

  return (
    <aside
      className={cn(
        'fixed left-0 top-0 z-40 h-screen border-r bg-surface transition-all duration-300',
        collapsed ? 'w-16' : 'w-64'
      )}
    >
      <div className="flex h-full flex-col">
        {/* Header */}
        <div className="flex h-16 items-center justify-between border-b px-4">
          {!collapsed && (
            <Link href="/dashboard" className="text-h3 font-semibold text-charcoal">
              Haven Hub
            </Link>
          )}
          <Button
            variant="ghost"
            size="icon-sm"
            onClick={handleToggle}
            className={cn(collapsed && 'mx-auto')}
            aria-label={collapsed ? 'Expand sidebar' : 'Collapse sidebar'}
          >
            {collapsed ? (
              <ChevronRight className="h-4 w-4" />
            ) : (
              <ChevronLeft className="h-4 w-4" />
            )}
          </Button>
        </div>

        {/* Navigation */}
        <nav className="flex-1 overflow-y-auto p-2 scrollbar-thin">
          <ul className="space-y-1">
            {navigation.map((item, index) => {
              if (isNavSection(item)) {
                return (
                  <NavSectionComponent
                    key={item.name}
                    section={item}
                    collapsed={collapsed}
                    pathname={pathname}
                  />
                );
              }
              return (
                <NavItemComponent
                  key={item.href}
                  item={item}
                  collapsed={collapsed}
                  pathname={pathname}
                />
              );
            })}
          </ul>
        </nav>

        {/* Footer */}
        <div className="border-t p-2">
          <div
            className={cn(
              'flex items-center gap-3 rounded-md p-2',
              collapsed ? 'justify-center' : ''
            )}
          >
            <div className="flex h-8 w-8 items-center justify-center rounded-full bg-sage text-white text-body-sm font-medium">
              {user?.email?.charAt(0).toUpperCase() || 'U'}
            </div>
            {!collapsed && (
              <div className="flex-1 min-w-0">
                <p className="truncate text-body-sm font-medium">{user?.email}</p>
              </div>
            )}
            {!collapsed && (
              <Button
                variant="ghost"
                size="icon-sm"
                onClick={signOut}
                aria-label="Sign out"
              >
                <LogOut className="h-4 w-4" />
              </Button>
            )}
          </div>
        </div>
      </div>
    </aside>
  );
}

function NavSectionComponent({
  section,
  collapsed,
  pathname,
}: {
  section: NavSection;
  collapsed: boolean;
  pathname: string;
}) {
  const [expanded, setExpanded] = useState(true);

  if (collapsed) {
    return (
      <>
        {section.items.map((item) => (
          <NavItemComponent
            key={item.href}
            item={item}
            collapsed={collapsed}
            pathname={pathname}
          />
        ))}
      </>
    );
  }

  return (
    <li>
      <button
        className="flex w-full items-center justify-between px-3 py-2 text-overline text-[var(--color-text-tertiary)] uppercase tracking-wider"
        onClick={() => setExpanded(!expanded)}
      >
        {section.name}
        <ChevronRight
          className={cn(
            'h-3 w-3 transition-transform',
            expanded && 'rotate-90'
          )}
        />
      </button>
      {expanded && (
        <ul className="mt-1 space-y-1">
          {section.items.map((item) => (
            <NavItemComponent
              key={item.href}
              item={item}
              collapsed={collapsed}
              pathname={pathname}
            />
          ))}
        </ul>
      )}
    </li>
  );
}

function NavItemComponent({
  item,
  collapsed,
  pathname,
}: {
  item: NavItem;
  collapsed: boolean;
  pathname: string;
}) {
  const isActive = pathname === item.href || pathname.startsWith(`${item.href}/`);
  const Icon = item.icon;

  // Fetch badge data if configured
  const { data: badgeData } = useQuery({
    queryKey: item.badge?.queryKey ?? [],
    enabled: !!item.badge,
    refetchInterval: 30000,
  });

  const badgeCount = item.badge?.getValue(badgeData) ?? 0;

  return (
    <li>
      <Link
        href={item.href}
        className={cn(
          'flex items-center gap-3 rounded-md px-3 py-2 text-body transition-colors',
          isActive
            ? 'bg-sage-pale text-sage font-medium'
            : 'text-[var(--color-text-secondary)] hover:bg-elevated hover:text-charcoal',
          collapsed && 'justify-center px-2'
        )}
        title={collapsed ? item.name : undefined}
      >
        <Icon className="h-5 w-5 shrink-0" />
        {!collapsed && (
          <>
            <span className="flex-1">{item.name}</span>
            {badgeCount > 0 && (
              <Badge variant="primary" size="sm">
                {badgeCount}
              </Badge>
            )}
          </>
        )}
        {collapsed && badgeCount > 0 && (
          <span className="absolute right-1 top-1 h-2 w-2 rounded-full bg-sage" />
        )}
      </Link>
    </li>
  );
}
```

### `components/layout/header.tsx`
```typescript
'use client';

import { useState } from 'react';
import { Search, Bell, Menu, Command } from 'lucide-react';
import { Button, Badge } from '@/components/ui';
import { cn } from '@/lib/utils';

interface HeaderProps {
  onMenuClick?: () => void;
}

export function Header({ onMenuClick }: HeaderProps) {
  const [notificationCount] = useState(3); // Will be connected to real data

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b bg-surface px-4 lg:px-6">
      {/* Left side */}
      <div className="flex items-center gap-4">
        {/* Mobile menu button */}
        <Button
          variant="ghost"
          size="icon"
          className="lg:hidden"
          onClick={onMenuClick}
          aria-label="Open menu"
        >
          <Menu className="h-5 w-5" />
        </Button>

        {/* Search trigger */}
        <button
          className="hidden md:flex items-center gap-2 rounded-md border bg-elevated px-3 py-1.5 text-body-sm text-[var(--color-text-tertiary)] hover:border-sage/50 transition-colors"
          onClick={() => {
            // Will open command palette
            const event = new KeyboardEvent('keydown', { key: 'k', metaKey: true });
            document.dispatchEvent(event);
          }}
        >
          <Search className="h-4 w-4" />
          <span>Search...</span>
          <kbd className="ml-4 hidden sm:inline-flex items-center gap-1 rounded border bg-surface px-1.5 text-caption">
            <Command className="h-3 w-3" />K
          </kbd>
        </button>
      </div>

      {/* Right side */}
      <div className="flex items-center gap-2">
        {/* Mode indicator - will be replaced with actual component */}
        <Badge variant="secondary" className="hidden sm:flex">
          Supervised
        </Badge>

        {/* Notifications */}
        <Button variant="ghost" size="icon" className="relative" aria-label="Notifications">
          <Bell className="h-5 w-5" />
          {notificationCount > 0 && (
            <span className="absolute -right-0.5 -top-0.5 flex h-4 w-4 items-center justify-center rounded-full bg-error text-[10px] font-medium text-white">
              {notificationCount > 9 ? '9+' : notificationCount}
            </span>
          )}
        </Button>
      </div>
    </header>
  );
}
```

### `components/layout/page-container.tsx`
```typescript
import type { ReactNode } from 'react';
import { cn } from '@/lib/utils';

interface PageContainerProps {
  title: string;
  description?: string;
  actions?: ReactNode;
  children: ReactNode;
  className?: string;
  fullWidth?: boolean;
}

export function PageContainer({
  title,
  description,
  actions,
  children,
  className,
  fullWidth = false,
}: PageContainerProps) {
  return (
    <div className={cn('flex flex-col', className)}>
      {/* Page header */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
        <div>
          <h1 className="text-h1 text-charcoal">{title}</h1>
          {description && (
            <p className="mt-1 text-body text-[var(--color-text-secondary)]">{description}</p>
          )}
        </div>
        {actions && <div className="flex items-center gap-2">{actions}</div>}
      </div>

      {/* Page content */}
      <div className={cn(!fullWidth && 'max-w-7xl')}>{children}</div>
    </div>
  );
}
```

### `app/(dashboard)/layout.tsx`
```typescript
'use client';

import { useState, type ReactNode } from 'react';
import { Sidebar } from '@/components/layout/sidebar';
import { Header } from '@/components/layout/header';
import { Sheet } from '@/components/ui';
import { cn } from '@/lib/utils';

export default function DashboardLayout({ children }: { children: ReactNode }) {
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  return (
    <div className="min-h-screen bg-canvas">
      {/* Desktop Sidebar */}
      <div className="hidden lg:block">
        <Sidebar />
      </div>

      {/* Mobile Sidebar */}
      <Sheet
        isOpen={mobileMenuOpen}
        onClose={() => setMobileMenuOpen(false)}
        side="left"
        size="sm"
        showCloseButton={false}
      >
        <Sidebar />
      </Sheet>

      {/* Main content area */}
      <div
        className={cn(
          'transition-all duration-300',
          'lg:ml-64' // Will need to be dynamic based on collapsed state
        )}
      >
        <Header onMenuClick={() => setMobileMenuOpen(true)} />
        <main className="p-4 lg:p-6">{children}</main>
      </div>
    </div>
  );
}
```

### `app/(dashboard)/page.tsx`
```typescript
import { PageContainer } from '@/components/layout/page-container';
import { Card, CardHeader, CardContent } from '@/components/ui';

export default function DashboardPage() {
  return (
    <PageContainer
      title="Dashboard"
      description="Welcome to Haven Hub"
    >
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        {/* Placeholder metric cards */}
        <Card>
          <CardContent className="p-6">
            <p className="text-overline text-[var(--color-text-tertiary)] uppercase">
              Pending Approvals
            </p>
            <p className="text-metric mt-2">0</p>
            <p className="text-body-sm text-success mt-1">All caught up!</p>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <p className="text-overline text-[var(--color-text-tertiary)] uppercase">
              Pins Today
            </p>
            <p className="text-metric mt-2">0 / 5</p>
            <p className="text-body-sm text-[var(--color-text-secondary)] mt-1">Daily limit</p>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <p className="text-overline text-[var(--color-text-tertiary)] uppercase">
              Ad Spend This Week
            </p>
            <p className="text-metric mt-2">$0.00</p>
            <p className="text-body-sm text-[var(--color-text-secondary)] mt-1">$100 limit</p>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <p className="text-overline text-[var(--color-text-tertiary)] uppercase">
              Mockup Credits
            </p>
            <p className="text-metric mt-2">3,500</p>
            <p className="text-body-sm text-[var(--color-text-secondary)] mt-1">Annual budget</p>
          </CardContent>
        </Card>
      </div>

      {/* Placeholder content sections */}
      <div className="mt-6 grid gap-6 lg:grid-cols-2">
        <Card>
          <CardHeader title="Approval Queue" />
          <CardContent className="p-6 pt-0">
            <div className="flex flex-col items-center justify-center py-8 text-center">
              <div className="h-12 w-12 rounded-full bg-success/10 flex items-center justify-center mb-3">
                <span className="text-success text-xl">âœ“</span>
              </div>
              <p className="text-body font-medium">All caught up!</p>
              <p className="text-body-sm text-[var(--color-text-secondary)] mt-1">
                No items waiting for review
              </p>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader title="Today's Schedule" />
          <CardContent className="p-6 pt-0">
            <div className="flex flex-col items-center justify-center py-8 text-center">
              <p className="text-body text-[var(--color-text-secondary)]">
                No content scheduled for today
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </PageContainer>
  );
}
```

### `lib/fetcher.ts`
```typescript
import { getSupabaseBrowserClient } from '@/lib/supabase/client';

export class ApiError extends Error {
  status: number;
  data?: unknown;

  constructor(message: string, status: number, data?: unknown) {
    super(message);
    this.name = 'ApiError';
    this.status = status;
    this.data = data;
  }
}

interface FetchOptions extends RequestInit {
  params?: Record<string, string | number | boolean | undefined>;
}

export async function fetcher<T>(
  endpoint: string,
  options: FetchOptions = {}
): Promise<T> {
  const { params, ...fetchOptions } = options;

  // Build URL with query params
  let url = endpoint.startsWith('http') ? endpoint : `/api${endpoint}`;
  if (params) {
    const searchParams = new URLSearchParams();
    Object.entries(params).forEach(([key, value]) => {
      if (value !== undefined) {
        searchParams.append(key, String(value));
      }
    });
    const queryString = searchParams.toString();
    if (queryString) {
      url += `?${queryString}`;
    }
  }

  // Get session for auth header
  const supabase = getSupabaseBrowserClient();
  const { data: { session } } = await supabase.auth.getSession();

  const response = await fetch(url, {
    ...fetchOptions,
    headers: {
      'Content-Type': 'application/json',
      ...(session?.access_token && {
        Authorization: `Bearer ${session.access_token}`,
      }),
      ...fetchOptions.headers,
    },
  });

  if (!response.ok) {
    const errorData = await response.json().catch(() => ({}));
    throw new ApiError(
      errorData.message || errorData.error || `HTTP error ${response.status}`,
      response.status,
      errorData
    );
  }

  // Handle empty responses
  const text = await response.text();
  if (!text) {
    return {} as T;
  }

  return JSON.parse(text);
}

// Convenience methods
export const api = {
  get: <T>(endpoint: string, params?: FetchOptions['params']) =>
    fetcher<T>(endpoint, { method: 'GET', params }),

  post: <T>(endpoint: string, body?: unknown) =>
    fetcher<T>(endpoint, {
      method: 'POST',
      body: body ? JSON.stringify(body) : undefined,
    }),

  patch: <T>(endpoint: string, body?: unknown) =>
    fetcher<T>(endpoint, {
      method: 'PATCH',
      body: body ? JSON.stringify(body) : undefined,
    }),

  put: <T>(endpoint: string, body?: unknown) =>
    fetcher<T>(endpoint, {
      method: 'PUT',
      body: body ? JSON.stringify(body) : undefined,
    }),

  delete: <T>(endpoint: string) => fetcher<T>(endpoint, { method: 'DELETE' }),
};
```

### `components/error-boundary.tsx`
```typescript
'use client';

import { Component, type ReactNode } from 'react';
import { AlertTriangle, RefreshCw } from 'lucide-react';
import { Button, Card } from '@/components/ui';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('Error boundary caught an error:', error, errorInfo);
  }

  handleRetry = () => {
    this.setState({ hasError: false, error: null });
  };

  render() {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <Card className="p-6">
          <div className="flex flex-col items-center text-center">
            <div className="h-12 w-12 rounded-full bg-error/10 flex items-center justify-center mb-4">
              <AlertTriangle className="h-6 w-6 text-error" />
            </div>
            <h3 className="text-h3 mb-2">Something went wrong</h3>
            <p className="text-body text-[var(--color-text-secondary)] mb-4 max-w-md">
              {this.state.error?.message || 'An unexpected error occurred'}
            </p>
            <Button onClick={this.handleRetry} leftIcon={<RefreshCw className="h-4 w-4" />}>
              Try again
            </Button>
          </div>
        </Card>
      );
    }

    return this.props.children;
  }
}
```

- **Step Dependencies**: Step 1.9
- **User Instructions**: None

---

**Phase 1 Complete!**

Now continuing with **Phase 2: Core System Infrastructure** in the same file...

---

# Phase 2: Core System Infrastructure

