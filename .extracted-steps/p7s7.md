## Step 10.3: Create Products API Endpoints

- **Task**: Build the API routes for product CRUD operations and Shopify sync.

- **Files**:

### `app/api/products/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { createServerSupabaseClient } from '@/lib/supabase/server';
import { getUserId } from '@/lib/auth/session';
import { createProduct } from '@/lib/products/product-service';

const querySchema = z.object({
  status: z.string().optional(),
  collection: z.string().optional(),
  search: z.string().optional(),
  limit: z.coerce.number().min(1).max(100).default(20),
  offset: z.coerce.number().min(0).default(0),
});

const createSchema = z.object({
  quoteId: z.string().uuid().optional(),
  assetId: z.string().uuid().optional(),
  title: z.string().min(1).max(200),
  description: z.string().optional(),
  collection: z.enum(['grounding', 'wholeness', 'growth']).optional(),
  tags: z.array(z.string()).optional(),
  variants: z.array(z.object({
    size: z.string(),
    frame_style: z.string().optional(),
    price: z.number().positive(),
    is_digital: z.boolean().optional(),
  })).min(1),
  imageIds: z.array(z.string().uuid()).optional(),
  publishImmediately: z.boolean().optional(),
});

export async function GET(request: NextRequest) {
  try {
    const supabase = createServerSupabaseClient();
    const userId = await getUserId();
    
    const searchParams = Object.fromEntries(request.nextUrl.searchParams);
    const { status, collection, search, limit, offset } = querySchema.parse(searchParams);
    
    let query = supabase
      .from('products')
      .select(`
        *,
        variants:product_variants(*),
        images:product_images(*)
      `, { count: 'exact' })
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1);
    
    if (status) {
      query = query.eq('status', status);
    }
    
    if (collection) {
      query = query.eq('collection', collection);
    }
    
    if (search) {
      query = query.ilike('title', `%${search}%`);
    }
    
    const { data, error, count } = await query;
    
    if (error) {
      return NextResponse.json({ error: error.message }, { status: 500 });
    }
    
    return NextResponse.json({
      products: data,
      total: count,
      limit,
      offset,
    });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: 'Invalid query parameters' }, { status: 400 });
    }
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal error' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const userId = await getUserId();
    const body = await request.json();
    
    const data = createSchema.parse(body);
    const result = await createProduct(userId, data);
    
    if (!result.success) {
      return NextResponse.json({ error: result.error }, { status: 400 });
    }
    
    return NextResponse.json({
      success: true,
      product: result.product,
    });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: 'Invalid request body', details: error.errors }, { status: 400 });
    }
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal error' },
      { status: 500 }
    );
  }
}
```

### `app/api/products/[id]/publish/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getUserId } from '@/lib/auth/session';
import { publishProductToShopify } from '@/lib/products/product-service';

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const userId = await getUserId();
    const result = await publishProductToShopify(userId, params.id);
    
    if (!result.success) {
      return NextResponse.json({ error: result.error }, { status: 400 });
    }
    
    return NextResponse.json({
      success: true,
      shopifyProductId: result.shopifyProductId,
    });
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal error' },
      { status: 500 }
    );
  }
}
```

### `app/api/products/[id]/retire/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { createServerSupabaseClient } from '@/lib/supabase/server';
import { getUserId } from '@/lib/auth/session';

const retireSchema = z.object({
  reason: z.enum(['underperformer', 'manual', 'seasonal']).default('manual'),
});

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const supabase = createServerSupabaseClient();
    const userId = await getUserId();
    const body = await request.json().catch(() => ({}));
    
    const { reason } = retireSchema.parse(body);
    
    // Update local product
    const { data: product, error } = await supabase
      .from('products')
      .update({
        status: 'retired',
        retired_at: new Date().toISOString(),
        retire_reason: reason,
      })
      .eq('id', params.id)
      .eq('user_id', userId)
      .select()
      .single();
    
    if (error) {
      return NextResponse.json({ error: error.message }, { status: 500 });
    }
    
    // TODO: Update Shopify product status to archived
    
    // Log activity
    await supabase.rpc('log_activity', {
      p_user_id: userId,
      p_action_type: 'product_retired',
      p_details: { productId: params.id, reason },
      p_executed: true,
      p_module: 'products',
      p_reference_id: params.id,
      p_reference_table: 'products',
    });
    
    return NextResponse.json({
      success: true,
      product,
    });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: 'Invalid request body' }, { status: 400 });
    }
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal error' },
      { status: 500 }
    );
  }
}
```

- **Step Dependencies**: Step 10.2
- **User Instructions**: None

---

