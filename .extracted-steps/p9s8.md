## Step 15.1: Create Quiz Database Schema

- **Task**: Create database schema for quiz questions, answers, and results.

- **Files**:

### `supabase/migrations/012_quiz.sql`
```sql
-- ============================================================================
-- Migration: 012_quiz
-- Description: Quiz system for collection recommendation
-- Feature: 15 (Quiz System)
-- ============================================================================

-- ============================================================================
-- Quizzes Table
-- ============================================================================
CREATE TABLE quizzes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Quiz details
  title TEXT NOT NULL,
  description TEXT,
  slug TEXT NOT NULL,
  
  -- Landing page association
  landing_page_id UUID REFERENCES landing_pages(id) ON DELETE SET NULL,
  
  -- Configuration
  show_results_immediately BOOLEAN NOT NULL DEFAULT true,
  require_email BOOLEAN NOT NULL DEFAULT true,
  
  -- Scoring
  scoring_method TEXT NOT NULL DEFAULT 'weighted' CHECK (scoring_method IN (
    'weighted',    -- Each answer has weighted scores for each collection
    'categorical', -- Each answer maps to a single collection
    'custom'       -- Custom scoring logic
  )),
  
  -- Status
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'archived')),
  
  -- Analytics
  starts INTEGER NOT NULL DEFAULT 0,
  completions INTEGER NOT NULL DEFAULT 0,
  completion_rate NUMERIC(5,4) GENERATED ALWAYS AS (
    CASE WHEN starts > 0 THEN completions::NUMERIC / starts ELSE 0 END
  ) STORED,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, slug)
);

-- ============================================================================
-- Quiz Questions Table
-- ============================================================================
CREATE TABLE quiz_questions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quiz_id UUID REFERENCES quizzes(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Question content
  question_text TEXT NOT NULL,
  question_type TEXT NOT NULL DEFAULT 'single' CHECK (question_type IN (
    'single',   -- Single choice
    'multiple', -- Multiple choice
    'scale'     -- Scale (1-5, etc.)
  )),
  
  -- Display
  position INTEGER NOT NULL,
  image_url TEXT,
  help_text TEXT,
  
  -- Required
  is_required BOOLEAN NOT NULL DEFAULT true,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Quiz Answers Table
-- ============================================================================
CREATE TABLE quiz_answers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  question_id UUID REFERENCES quiz_questions(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Answer content
  answer_text TEXT NOT NULL,
  position INTEGER NOT NULL,
  image_url TEXT,
  
  -- Scoring (for weighted scoring)
  scores JSONB NOT NULL DEFAULT '{"grounding": 0, "wholeness": 0, "growth": 0}',
  
  -- For categorical scoring
  category TEXT CHECK (category IN ('grounding', 'wholeness', 'growth')),
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Quiz Results Table (outcome definitions)
-- ============================================================================
CREATE TABLE quiz_results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quiz_id UUID REFERENCES quizzes(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Result details
  collection TEXT NOT NULL CHECK (collection IN ('grounding', 'wholeness', 'growth')),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  
  -- Recommendations
  recommended_products TEXT[], -- Product IDs or handles
  recommended_quotes TEXT[],   -- Quote IDs
  
  -- Display
  image_url TEXT,
  cta_text TEXT DEFAULT 'Shop This Collection',
  cta_url TEXT,
  
  -- Klaviyo integration
  klaviyo_segment_id TEXT,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(quiz_id, collection)
);

-- ============================================================================
-- Quiz Responses Table (user submissions)
-- ============================================================================
CREATE TABLE quiz_responses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quiz_id UUID REFERENCES quizzes(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,
  
  -- Response data
  answers JSONB NOT NULL, -- { question_id: answer_id[] }
  
  -- Calculated scores
  scores JSONB NOT NULL DEFAULT '{}', -- { grounding: 0, wholeness: 0, growth: 0 }
  
  -- Result
  result_collection TEXT NOT NULL CHECK (result_collection IN ('grounding', 'wholeness', 'growth')),
  
  -- Tracking
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  time_spent_seconds INTEGER,
  
  -- Client info
  ip_address TEXT,
  user_agent TEXT,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_quizzes_user ON quizzes(user_id);
CREATE INDEX idx_quizzes_slug ON quizzes(user_id, slug);
CREATE INDEX idx_quizzes_landing_page ON quizzes(landing_page_id);

CREATE INDEX idx_questions_quiz ON quiz_questions(quiz_id, position);
CREATE INDEX idx_answers_question ON quiz_answers(question_id, position);
CREATE INDEX idx_results_quiz ON quiz_results(quiz_id);

CREATE INDEX idx_responses_quiz ON quiz_responses(quiz_id);
CREATE INDEX idx_responses_lead ON quiz_responses(lead_id);
CREATE INDEX idx_responses_result ON quiz_responses(quiz_id, result_collection);

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE quizzes ENABLE ROW LEVEL SECURITY;
ALTER TABLE quiz_questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE quiz_answers ENABLE ROW LEVEL SECURITY;
ALTER TABLE quiz_results ENABLE ROW LEVEL SECURITY;
ALTER TABLE quiz_responses ENABLE ROW LEVEL SECURITY;

CREATE POLICY quizzes_all ON quizzes FOR ALL USING (user_id = auth.uid());
CREATE POLICY questions_all ON quiz_questions FOR ALL USING (user_id = auth.uid());
CREATE POLICY answers_all ON quiz_answers FOR ALL USING (user_id = auth.uid());
CREATE POLICY results_all ON quiz_results FOR ALL USING (user_id = auth.uid());
CREATE POLICY responses_all ON quiz_responses FOR ALL USING (user_id = auth.uid());

-- Public read for active quizzes
CREATE POLICY quizzes_public_read ON quizzes FOR SELECT USING (status = 'active');

-- Public insert for responses
CREATE POLICY responses_public_insert ON quiz_responses FOR INSERT WITH CHECK (true);

CREATE TRIGGER quizzes_updated_at BEFORE UPDATE ON quizzes
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER questions_updated_at BEFORE UPDATE ON quiz_questions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER results_updated_at BEFORE UPDATE ON quiz_results
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Calculate quiz result
-- ============================================================================
CREATE OR REPLACE FUNCTION calculate_quiz_result(
  p_quiz_id UUID,
  p_answers JSONB
)
RETURNS TABLE (
  result_collection TEXT,
  scores JSONB
) AS $$
DECLARE
  v_grounding NUMERIC := 0;
  v_wholeness NUMERIC := 0;
  v_growth NUMERIC := 0;
  v_answer RECORD;
  v_question_id TEXT;
  v_answer_ids TEXT[];
BEGIN
  -- Loop through each answer in the response
  FOR v_question_id, v_answer_ids IN 
    SELECT key, array_agg(value) 
    FROM jsonb_each_text(p_answers) 
    GROUP BY key
  LOOP
    -- Get scores for each selected answer
    FOR v_answer IN 
      SELECT * FROM quiz_answers 
      WHERE id = ANY(SELECT unnest(v_answer_ids)::UUID)
    LOOP
      v_grounding := v_grounding + COALESCE((v_answer.scores->>'grounding')::NUMERIC, 0);
      v_wholeness := v_wholeness + COALESCE((v_answer.scores->>'wholeness')::NUMERIC, 0);
      v_growth := v_growth + COALESCE((v_answer.scores->>'growth')::NUMERIC, 0);
    END LOOP;
  END LOOP;
  
  -- Determine winning collection
  IF v_grounding >= v_wholeness AND v_grounding >= v_growth THEN
    result_collection := 'grounding';
  ELSIF v_wholeness >= v_grounding AND v_wholeness >= v_growth THEN
    result_collection := 'wholeness';
  ELSE
    result_collection := 'growth';
  END IF;
  
  scores := jsonb_build_object(
    'grounding', v_grounding,
    'wholeness', v_wholeness,
    'growth', v_growth
  );
  
  RETURN NEXT;
END;
$$ LANGUAGE plpgsql;
```

### `types/quiz.ts`
```typescript
export interface Quiz {
  id: string;
  user_id: string;
  title: string;
  description: string | null;
  slug: string;
  landing_page_id: string | null;
  show_results_immediately: boolean;
  require_email: boolean;
  scoring_method: 'weighted' | 'categorical' | 'custom';
  status: 'draft' | 'active' | 'archived';
  starts: number;
  completions: number;
  completion_rate: number;
  created_at: string;
  updated_at: string;
  questions?: QuizQuestion[];
  results?: QuizResult[];
}

export interface QuizQuestion {
  id: string;
  quiz_id: string;
  user_id: string;
  question_text: string;
  question_type: 'single' | 'multiple' | 'scale';
  position: number;
  image_url: string | null;
  help_text: string | null;
  is_required: boolean;
  created_at: string;
  updated_at: string;
  answers?: QuizAnswer[];
}

export interface QuizAnswer {
  id: string;
  question_id: string;
  user_id: string;
  answer_text: string;
  position: number;
  image_url: string | null;
  scores: CollectionScores;
  category: 'grounding' | 'wholeness' | 'growth' | null;
  created_at: string;
}

export interface CollectionScores {
  grounding: number;
  wholeness: number;
  growth: number;
}

export interface QuizResult {
  id: string;
  quiz_id: string;
  user_id: string;
  collection: 'grounding' | 'wholeness' | 'growth';
  title: string;
  description: string;
  recommended_products: string[] | null;
  recommended_quotes: string[] | null;
  image_url: string | null;
  cta_text: string | null;
  cta_url: string | null;
  klaviyo_segment_id: string | null;
  created_at: string;
  updated_at: string;
}

export interface QuizResponse {
  id: string;
  quiz_id: string;
  user_id: string;
  lead_id: string | null;
  answers: Record<string, string[]>;
  scores: CollectionScores;
  result_collection: 'grounding' | 'wholeness' | 'growth';
  started_at: string;
  completed_at: string | null;
  time_spent_seconds: number | null;
  ip_address: string | null;
  user_agent: string | null;
  created_at: string;
}

export interface SubmitQuizRequest {
  quizId: string;
  answers: Record<string, string[]>;
  email?: string;
  firstName?: string;
}
```

- **Step Dependencies**: Step 14.3
- **User Instructions**: Run migration

---

