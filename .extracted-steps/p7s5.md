## Step 10.1: Create Products Database Schema

- **Task**: Create the database schema for Shopify product management with variant tracking.

- **Files**:

### `supabase/migrations/008_products.sql`
```sql
-- ============================================================================
-- Migration: 008_products
-- Description: Products table for Shopify integration
-- Feature: 10 (Shopify Products)
-- ============================================================================

-- ============================================================================
-- Products Table
-- ============================================================================
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Source references
  quote_id UUID REFERENCES quotes(id) ON DELETE SET NULL,
  asset_id UUID REFERENCES assets(id) ON DELETE SET NULL,
  
  -- Shopify references
  shopify_product_id TEXT,
  shopify_product_gid TEXT, -- GraphQL ID
  shopify_handle TEXT,
  
  -- Product details
  title TEXT NOT NULL,
  description TEXT,
  product_type TEXT DEFAULT 'Print',
  vendor TEXT DEFAULT 'Haven & Hold',
  tags TEXT[] NOT NULL DEFAULT '{}',
  
  -- Classification
  collection TEXT CHECK (collection IN ('grounding', 'wholeness', 'growth')),
  
  -- Status per spec
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN (
    'draft',        -- Not yet published to Shopify
    'pending',      -- Awaiting approval
    'active',       -- Published and available
    'retired',      -- Underperformer, retired
    'archived'      -- Manually archived
  )),
  
  -- Publishing
  published_at TIMESTAMPTZ,
  retired_at TIMESTAMPTZ,
  retire_reason TEXT, -- 'underperformer', 'manual', 'seasonal'
  
  -- Performance tracking
  total_views INTEGER NOT NULL DEFAULT 0,
  total_orders INTEGER NOT NULL DEFAULT 0,
  total_revenue NUMERIC(10,2) NOT NULL DEFAULT 0,
  
  -- Sync status
  last_synced_at TIMESTAMPTZ,
  sync_error TEXT,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Product Variants Table
-- ============================================================================
CREATE TABLE product_variants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID REFERENCES products(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Shopify references
  shopify_variant_id TEXT,
  shopify_variant_gid TEXT,
  
  -- Variant details
  title TEXT NOT NULL, -- e.g., "8Ã—10 / White Frame"
  sku TEXT,
  
  -- Options (per spec print sizes)
  size TEXT NOT NULL, -- '8x10', '11x14', etc.
  frame_style TEXT, -- 'white', 'black', 'natural', 'unframed'
  
  -- Pricing
  price NUMERIC(10,2) NOT NULL,
  compare_at_price NUMERIC(10,2),
  
  -- Inventory
  inventory_quantity INTEGER NOT NULL DEFAULT 0,
  inventory_policy TEXT DEFAULT 'continue', -- 'continue' for POD
  
  -- Digital delivery (Sky Pilot)
  is_digital BOOLEAN NOT NULL DEFAULT false,
  digital_file_url TEXT,
  digital_file_key TEXT,
  sky_pilot_asset_id TEXT,
  
  -- Status
  is_active BOOLEAN NOT NULL DEFAULT true,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Product Images Table
-- ============================================================================
CREATE TABLE product_images (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID REFERENCES products(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Shopify references
  shopify_image_id TEXT,
  
  -- Image details
  position INTEGER NOT NULL DEFAULT 0,
  src TEXT NOT NULL, -- CDN URL
  alt TEXT,
  
  -- Source tracking
  source_type TEXT NOT NULL CHECK (source_type IN ('asset', 'mockup', 'upload')),
  source_id UUID, -- asset_id or mockup_id
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_products_user ON products(user_id);
CREATE INDEX idx_products_collection ON products(user_id, collection);
CREATE INDEX idx_products_status ON products(user_id, status);
CREATE INDEX idx_products_shopify ON products(shopify_product_id) WHERE shopify_product_id IS NOT NULL;
CREATE INDEX idx_products_quote ON products(quote_id) WHERE quote_id IS NOT NULL;

CREATE INDEX idx_variants_product ON product_variants(product_id);
CREATE INDEX idx_variants_size ON product_variants(product_id, size);
CREATE INDEX idx_variants_shopify ON product_variants(shopify_variant_id) WHERE shopify_variant_id IS NOT NULL;

CREATE INDEX idx_product_images_product ON product_images(product_id, position);

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_variants ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_images ENABLE ROW LEVEL SECURITY;

CREATE POLICY products_all ON products FOR ALL USING (user_id = auth.uid());
CREATE POLICY variants_all ON product_variants FOR ALL USING (user_id = auth.uid());
CREATE POLICY images_all ON product_images FOR ALL USING (user_id = auth.uid());

CREATE TRIGGER products_updated_at
  BEFORE UPDATE ON products
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER variants_updated_at
  BEFORE UPDATE ON product_variants
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Default pricing table per spec
-- ============================================================================
CREATE TABLE product_pricing (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- Size
  size TEXT NOT NULL,
  
  -- Pricing
  base_price NUMERIC(10,2) NOT NULL,
  framed_price NUMERIC(10,2),
  digital_price NUMERIC(10,2),
  
  -- Cost (for profit calculation)
  cost NUMERIC(10,2),
  
  -- Active
  is_active BOOLEAN NOT NULL DEFAULT true,
  
  -- System vs user defined
  is_system BOOLEAN NOT NULL DEFAULT false,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Unique per user per size (or global for system)
CREATE UNIQUE INDEX idx_pricing_user_size ON product_pricing(COALESCE(user_id, '00000000-0000-0000-0000-000000000000'::UUID), size);

ALTER TABLE product_pricing ENABLE ROW LEVEL SECURITY;

CREATE POLICY pricing_select ON product_pricing 
  FOR SELECT USING (is_system = true OR user_id = auth.uid());
CREATE POLICY pricing_insert ON product_pricing 
  FOR INSERT WITH CHECK (user_id = auth.uid() AND is_system = false);
CREATE POLICY pricing_update ON product_pricing 
  FOR UPDATE USING (user_id = auth.uid() AND is_system = false);

-- Insert default pricing per spec
INSERT INTO product_pricing (size, base_price, framed_price, digital_price, cost, is_system)
VALUES
  ('8x10', 24.99, 49.99, 9.99, 8.00, true),
  ('11x14', 34.99, 69.99, 12.99, 12.00, true),
  ('16x20', 49.99, 99.99, 14.99, 18.00, true),
  ('12x16', 39.99, 79.99, 12.99, 14.00, true),
  ('18x24', 59.99, 119.99, 16.99, 22.00, true),
  ('12x18', 44.99, 89.99, 14.99, 16.00, true),
  ('16x24', 54.99, 109.99, 16.99, 20.00, true),
  ('24x36', 79.99, 159.99, 19.99, 30.00, true),
  ('A4', 29.99, 59.99, 9.99, 10.00, true),
  ('A3', 44.99, 89.99, 12.99, 15.00, true)
ON CONFLICT DO NOTHING;
```

### `types/products.ts`
```typescript
export interface Product {
  id: string;
  user_id: string;
  quote_id: string | null;
  asset_id: string | null;
  shopify_product_id: string | null;
  shopify_product_gid: string | null;
  shopify_handle: string | null;
  title: string;
  description: string | null;
  product_type: string;
  vendor: string;
  tags: string[];
  collection: 'grounding' | 'wholeness' | 'growth' | null;
  status: ProductStatus;
  published_at: string | null;
  retired_at: string | null;
  retire_reason: string | null;
  total_views: number;
  total_orders: number;
  total_revenue: number;
  last_synced_at: string | null;
  sync_error: string | null;
  created_at: string;
  updated_at: string;
  variants?: ProductVariant[];
  images?: ProductImage[];
}

export type ProductStatus = 'draft' | 'pending' | 'active' | 'retired' | 'archived';

export interface ProductVariant {
  id: string;
  product_id: string;
  user_id: string;
  shopify_variant_id: string | null;
  shopify_variant_gid: string | null;
  title: string;
  sku: string | null;
  size: string;
  frame_style: string | null;
  price: number;
  compare_at_price: number | null;
  inventory_quantity: number;
  inventory_policy: string;
  is_digital: boolean;
  digital_file_url: string | null;
  digital_file_key: string | null;
  sky_pilot_asset_id: string | null;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface ProductImage {
  id: string;
  product_id: string;
  user_id: string;
  shopify_image_id: string | null;
  position: number;
  src: string;
  alt: string | null;
  source_type: 'asset' | 'mockup' | 'upload';
  source_id: string | null;
  created_at: string;
}

export interface ProductPricing {
  id: string;
  user_id: string | null;
  size: string;
  base_price: number;
  framed_price: number | null;
  digital_price: number | null;
  cost: number | null;
  is_active: boolean;
  is_system: boolean;
  created_at: string;
  updated_at: string;
}

export interface CreateProductRequest {
  quoteId?: string;
  assetId?: string;
  title: string;
  description?: string;
  collection?: 'grounding' | 'wholeness' | 'growth';
  tags?: string[];
  variants: Array<{
    size: string;
    frame_style?: string;
    price: number;
    is_digital?: boolean;
  }>;
  imageIds?: string[]; // asset or mockup IDs
  publishImmediately?: boolean;
}
```

- **Step Dependencies**: Step 5.2
- **User Instructions**: Run migration

---

