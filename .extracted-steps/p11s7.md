## Step 21.5: Implement Cross-Platform Winners

- **Task**: Create the system for tracking and adapting cross-platform content wins.

- **Files**:

### `supabase/migrations/018b_cross_platform.sql`
```sql
-- ============================================================================
-- Migration: 018b_cross_platform
-- Description: Cross-platform content tracking and adaptation
-- Feature: 21.5 (Cross-Platform Winners)
-- ============================================================================

-- ============================================================================
-- Cross-Platform Content Table
-- ============================================================================
CREATE TABLE cross_platform_content (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Source info
  platform TEXT NOT NULL CHECK (platform IN ('instagram', 'tiktok', 'youtube', 'twitter', 'other')),
  original_url TEXT NOT NULL,
  content_type TEXT NOT NULL CHECK (content_type IN ('post', 'reel', 'story', 'video', 'tweet')),
  
  -- Content
  title TEXT,
  description TEXT,
  image_url TEXT,
  video_url TEXT,
  
  -- Metrics (updated periodically)
  views INTEGER NOT NULL DEFAULT 0,
  likes INTEGER NOT NULL DEFAULT 0,
  comments INTEGER NOT NULL DEFAULT 0,
  shares INTEGER NOT NULL DEFAULT 0,
  saves INTEGER NOT NULL DEFAULT 0,
  engagement_rate DECIMAL(5, 4), -- As decimal, e.g., 0.0523 = 5.23%
  
  -- Performance score (calculated)
  performance_score INTEGER, -- 0-100
  
  -- Winner status
  is_winner BOOLEAN NOT NULL DEFAULT false,
  winner_detected_at TIMESTAMPTZ,
  
  -- Pinterest adaptation
  adapted_to_pinterest BOOLEAN NOT NULL DEFAULT false,
  pinterest_pin_id UUID REFERENCES pins(id) ON DELETE SET NULL,
  adapted_at TIMESTAMPTZ,
  
  -- Timestamps
  posted_at TIMESTAMPTZ,
  metrics_updated_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_xp_content_user ON cross_platform_content(user_id);
CREATE INDEX idx_xp_content_platform ON cross_platform_content(user_id, platform);
CREATE INDEX idx_xp_content_winners ON cross_platform_content(user_id, is_winner) WHERE is_winner = true;
CREATE INDEX idx_xp_content_not_adapted ON cross_platform_content(user_id, is_winner, adapted_to_pinterest) 
  WHERE is_winner = true AND adapted_to_pinterest = false;

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE cross_platform_content ENABLE ROW LEVEL SECURITY;

CREATE POLICY xp_content_all ON cross_platform_content FOR ALL USING (user_id = auth.uid());

-- ============================================================================
-- Trigger
-- ============================================================================
CREATE TRIGGER xp_content_updated_at BEFORE UPDATE ON cross_platform_content
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Calculate performance score
-- ============================================================================
CREATE OR REPLACE FUNCTION calculate_performance_score(
  p_views INTEGER,
  p_likes INTEGER,
  p_comments INTEGER,
  p_shares INTEGER,
  p_saves INTEGER
) RETURNS INTEGER AS $$
DECLARE
  v_engagement DECIMAL;
  v_score INTEGER;
BEGIN
  IF p_views = 0 THEN RETURN 0; END IF;
  
  -- Weight: saves (3x), shares (2.5x), comments (2x), likes (1x)
  v_engagement := (
    (p_saves * 3.0) + 
    (p_shares * 2.5) + 
    (p_comments * 2.0) + 
    (p_likes * 1.0)
  ) / p_views;
  
  -- Scale to 0-100
  v_score := LEAST(100, GREATEST(0, (v_engagement * 1000)::INTEGER));
  
  RETURN v_score;
END;
$$ LANGUAGE plpgsql;
```

### `types/cross-platform.ts`
```typescript
export type Platform = 'instagram' | 'tiktok' | 'youtube' | 'twitter' | 'other';
export type ContentType = 'post' | 'reel' | 'story' | 'video' | 'tweet';

export interface CrossPlatformContent {
  id: string;
  user_id: string;
  platform: Platform;
  original_url: string;
  content_type: ContentType;
  title?: string;
  description?: string;
  image_url?: string;
  video_url?: string;
  views: number;
  likes: number;
  comments: number;
  shares: number;
  saves: number;
  engagement_rate?: number;
  performance_score?: number;
  is_winner: boolean;
  winner_detected_at?: string;
  adapted_to_pinterest: boolean;
  pinterest_pin_id?: string;
  adapted_at?: string;
  posted_at?: string;
  metrics_updated_at?: string;
  created_at: string;
  updated_at: string;
}
```

### `lib/cross-platform/cross-platform-service.ts`
```typescript
import { createClient } from '@/lib/supabase/server';
import { CrossPlatformContent, Platform, ContentType } from '@/types/cross-platform';

// Winner thresholds by platform
const WINNER_THRESHOLDS: Record<Platform, { engagement_rate: number; min_views: number }> = {
  instagram: { engagement_rate: 0.03, min_views: 1000 },
  tiktok: { engagement_rate: 0.05, min_views: 5000 },
  youtube: { engagement_rate: 0.02, min_views: 1000 },
  twitter: { engagement_rate: 0.02, min_views: 500 },
  other: { engagement_rate: 0.03, min_views: 500 },
};

export async function addContent(
  userId: string,
  content: {
    platform: Platform;
    original_url: string;
    content_type: ContentType;
    title?: string;
    description?: string;
    image_url?: string;
    views: number;
    likes: number;
    comments: number;
    shares: number;
    saves: number;
    posted_at?: string;
  }
): Promise<CrossPlatformContent> {
  const supabase = createClient();

  // Calculate engagement rate
  const engagement_rate = content.views > 0
    ? (content.likes + content.comments + content.shares + content.saves) / content.views
    : 0;

  // Calculate performance score
  const { data: scoreData } = await supabase.rpc('calculate_performance_score', {
    p_views: content.views,
    p_likes: content.likes,
    p_comments: content.comments,
    p_shares: content.shares,
    p_saves: content.saves,
  });

  // Check if winner
  const threshold = WINNER_THRESHOLDS[content.platform];
  const is_winner = 
    content.views >= threshold.min_views && 
    engagement_rate >= threshold.engagement_rate;

  const { data, error } = await supabase
    .from('cross_platform_content')
    .insert({
      user_id: userId,
      ...content,
      engagement_rate,
      performance_score: scoreData,
      is_winner,
      winner_detected_at: is_winner ? new Date().toISOString() : null,
      metrics_updated_at: new Date().toISOString(),
    })
    .select()
    .single();

  if (error) throw new Error(`Failed to add content: ${error.message}`);
  return data;
}

export async function updateMetrics(
  contentId: string,
  metrics: {
    views: number;
    likes: number;
    comments: number;
    shares: number;
    saves: number;
  }
): Promise<CrossPlatformContent> {
  const supabase = createClient();

  // Get current content
  const { data: current } = await supabase
    .from('cross_platform_content')
    .select('*')
    .eq('id', contentId)
    .single();

  if (!current) throw new Error('Content not found');

  // Calculate new engagement rate
  const engagement_rate = metrics.views > 0
    ? (metrics.likes + metrics.comments + metrics.shares + metrics.saves) / metrics.views
    : 0;

  // Calculate performance score
  const { data: scoreData } = await supabase.rpc('calculate_performance_score', {
    p_views: metrics.views,
    p_likes: metrics.likes,
    p_comments: metrics.comments,
    p_shares: metrics.shares,
    p_saves: metrics.saves,
  });

  // Check if now a winner
  const threshold = WINNER_THRESHOLDS[current.platform as Platform];
  const is_winner = 
    metrics.views >= threshold.min_views && 
    engagement_rate >= threshold.engagement_rate;

  const { data, error } = await supabase
    .from('cross_platform_content')
    .update({
      ...metrics,
      engagement_rate,
      performance_score: scoreData,
      is_winner,
      winner_detected_at: is_winner && !current.is_winner 
        ? new Date().toISOString() 
        : current.winner_detected_at,
      metrics_updated_at: new Date().toISOString(),
    })
    .eq('id', contentId)
    .select()
    .single();

  if (error) throw new Error(`Failed to update metrics: ${error.message}`);
  return data;
}

export async function getWinners(userId: string): Promise<CrossPlatformContent[]> {
  const supabase = createClient();

  const { data } = await supabase
    .from('cross_platform_content')
    .select('*')
    .eq('user_id', userId)
    .eq('is_winner', true)
    .order('performance_score', { ascending: false });

  return data || [];
}

export async function getUnadaptedWinners(userId: string): Promise<CrossPlatformContent[]> {
  const supabase = createClient();

  const { data } = await supabase
    .from('cross_platform_content')
    .select('*')
    .eq('user_id', userId)
    .eq('is_winner', true)
    .eq('adapted_to_pinterest', false)
    .order('performance_score', { ascending: false });

  return data || [];
}

export async function markAdapted(
  contentId: string,
  pinterestPinId: string
): Promise<void> {
  const supabase = createClient();

  await supabase
    .from('cross_platform_content')
    .update({
      adapted_to_pinterest: true,
      pinterest_pin_id: pinterestPinId,
      adapted_at: new Date().toISOString(),
    })
    .eq('id', contentId);
}
```

### `app/api/cross-platform/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { addContent, getWinners, getUnadaptedWinners } from '@/lib/cross-platform/cross-platform-service';

export async function GET(request: NextRequest) {
  const supabase = createClient();
  
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const searchParams = request.nextUrl.searchParams;
  const winnersOnly = searchParams.get('winners') === 'true';
  const unadaptedOnly = searchParams.get('unadapted') === 'true';

  if (unadaptedOnly) {
    const content = await getUnadaptedWinners(user.id);
    return NextResponse.json({ content });
  }

  if (winnersOnly) {
    const content = await getWinners(user.id);
    return NextResponse.json({ content });
  }

  const { data: content } = await supabase
    .from('cross_platform_content')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false });

  return NextResponse.json({ content: content || [] });
}

export async function POST(request: NextRequest) {
  const supabase = createClient();
  
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const body = await request.json();

  try {
    const content = await addContent(user.id, body);
    return NextResponse.json({ content }, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to add content' },
      { status: 500 }
    );
  }
}
```

### `app/(dashboard)/dashboard/content/cross-platform/page.tsx`
```tsx
'use client';

import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { PageContainer } from '@/components/layout/page-container';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select } from '@/components/ui/select';
import { Modal } from '@/components/ui/modal';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { CrossPlatformContent, Platform } from '@/types/cross-platform';
import { Plus, Trophy, ArrowRight, Instagram, Youtube, Twitter, ExternalLink } from 'lucide-react';

const PLATFORM_ICONS: Record<Platform, any> = {
  instagram: Instagram,
  tiktok: () => <span className="text-lg">ðŸ“±</span>,
  youtube: Youtube,
  twitter: Twitter,
  other: ExternalLink,
};

export default function CrossPlatformPage() {
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState<'all' | 'winners' | 'unadapted'>('all');
  const [isAddOpen, setIsAddOpen] = useState(false);
  const [newContent, setNewContent] = useState({
    platform: 'instagram' as Platform,
    original_url: '',
    content_type: 'post',
    title: '',
    views: 0,
    likes: 0,
    comments: 0,
    shares: 0,
    saves: 0,
  });

  const { data, isLoading } = useQuery({
    queryKey: ['cross-platform', activeTab],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (activeTab === 'winners') params.set('winners', 'true');
      if (activeTab === 'unadapted') params.set('unadapted', 'true');
      
      const response = await fetch(`/api/cross-platform?${params}`);
      if (!response.ok) throw new Error('Failed to fetch');
      return response.json();
    },
  });

  const addMutation = useMutation({
    mutationFn: async (content: typeof newContent) => {
      const response = await fetch('/api/cross-platform', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(content),
      });
      if (!response.ok) throw new Error('Failed to add');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cross-platform'] });
      setIsAddOpen(false);
      setNewContent({
        platform: 'instagram',
        original_url: '',
        content_type: 'post',
        title: '',
        views: 0,
        likes: 0,
        comments: 0,
        shares: 0,
        saves: 0,
      });
    },
  });

  const content = data?.content || [];

  const winnerCount = content.filter((c: CrossPlatformContent) => c.is_winner).length;
  const unadaptedCount = content.filter(
    (c: CrossPlatformContent) => c.is_winner && !c.adapted_to_pinterest
  ).length;

  return (
    <PageContainer
      title="Cross-Platform Winners"
      description="Track winning content from other platforms and adapt for Pinterest"
      actions={
        <Button onClick={() => setIsAddOpen(true)}>
          <Plus className="h-4 w-4 mr-2" />
          Add Content
        </Button>
      }
    >
      {/* Stats */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        <Card className="p-4">
          <div className="text-sm text-muted-foreground">Total Content</div>
          <div className="text-2xl font-bold">{content.length}</div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-muted-foreground">Winners</div>
          <div className="text-2xl font-bold text-amber-600">{winnerCount}</div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-muted-foreground">Ready to Adapt</div>
          <div className="text-2xl font-bold text-green-600">{unadaptedCount}</div>
        </Card>
      </div>

      <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as any)}>
        <TabsList>
          <TabsTrigger value="all">All Content</TabsTrigger>
          <TabsTrigger value="winners">
            Winners
            {winnerCount > 0 && (
              <Badge variant="secondary" className="ml-2">{winnerCount}</Badge>
            )}
          </TabsTrigger>
          <TabsTrigger value="unadapted">
            Ready to Adapt
            {unadaptedCount > 0 && (
              <Badge variant="success" className="ml-2">{unadaptedCount}</Badge>
            )}
          </TabsTrigger>
        </TabsList>

        <TabsContent value={activeTab} className="mt-4">
          {isLoading ? (
            <div className="text-center py-12">Loading...</div>
          ) : content.length === 0 ? (
            <Card className="p-12 text-center">
              <p className="text-muted-foreground mb-4">
                {activeTab === 'all' 
                  ? 'No cross-platform content tracked yet'
                  : activeTab === 'winners'
                  ? 'No winners detected yet'
                  : 'No unadapted winners'
                }
              </p>
              {activeTab === 'all' && (
                <Button onClick={() => setIsAddOpen(true)}>
                  <Plus className="h-4 w-4 mr-2" />
                  Add Your First Content
                </Button>
              )}
            </Card>
          ) : (
            <div className="space-y-3">
              {content.map((item: CrossPlatformContent) => {
                const PlatformIcon = PLATFORM_ICONS[item.platform];
                return (
                  <Card key={item.id} className="p-4">
                    <div className="flex items-center gap-4">
                      <div className="p-2 bg-gray-100 rounded-lg">
                        <PlatformIcon className="h-5 w-5" />
                      </div>

                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                          <span className="font-medium truncate">
                            {item.title || 'Untitled'}
                          </span>
                          {item.is_winner && (
                            <Trophy className="h-4 w-4 text-amber-500" />
                          )}
                          {item.adapted_to_pinterest && (
                            <Badge variant="success">Adapted</Badge>
                          )}
                        </div>
                        <div className="text-sm text-muted-foreground">
                          {item.views.toLocaleString()} views â€¢ 
                          {((item.engagement_rate || 0) * 100).toFixed(2)}% engagement
                        </div>
                      </div>

                      <div className="text-right">
                        <div className="font-bold text-lg">
                          {item.performance_score || 0}
                        </div>
                        <div className="text-xs text-muted-foreground">score</div>
                      </div>

                      {item.is_winner && !item.adapted_to_pinterest && (
                        <Button size="sm">
                          <ArrowRight className="h-4 w-4 mr-1" />
                          Adapt
                        </Button>
                      )}
                    </div>
                  </Card>
                );
              })}
            </div>
          )}
        </TabsContent>
      </Tabs>

      {/* Add Content Modal */}
      <Modal
        isOpen={isAddOpen}
        onClose={() => setIsAddOpen(false)}
        title="Add Cross-Platform Content"
      >
        <div className="space-y-4">
          <div>
            <Label>Platform</Label>
            <Select
              value={newContent.platform}
              onChange={(v) => setNewContent({ ...newContent, platform: v as Platform })}
              options={[
                { value: 'instagram', label: 'Instagram' },
                { value: 'tiktok', label: 'TikTok' },
                { value: 'youtube', label: 'YouTube' },
                { value: 'twitter', label: 'Twitter/X' },
                { value: 'other', label: 'Other' },
              ]}
            />
          </div>

          <div>
            <Label>Original URL</Label>
            <Input
              value={newContent.original_url}
              onChange={(e) => setNewContent({ ...newContent, original_url: e.target.value })}
              placeholder="https://..."
            />
          </div>

          <div>
            <Label>Title (optional)</Label>
            <Input
              value={newContent.title}
              onChange={(e) => setNewContent({ ...newContent, title: e.target.value })}
            />
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div>
              <Label>Views</Label>
              <Input
                type="number"
                value={newContent.views}
                onChange={(e) => setNewContent({ ...newContent, views: Number(e.target.value) })}
              />
            </div>
            <div>
              <Label>Likes</Label>
              <Input
                type="number"
                value={newContent.likes}
                onChange={(e) => setNewContent({ ...newContent, likes: Number(e.target.value) })}
              />
            </div>
            <div>
              <Label>Comments</Label>
              <Input
                type="number"
                value={newContent.comments}
                onChange={(e) => setNewContent({ ...newContent, comments: Number(e.target.value) })}
              />
            </div>
            <div>
              <Label>Shares</Label>
              <Input
                type="number"
                value={newContent.shares}
                onChange={(e) => setNewContent({ ...newContent, shares: Number(e.target.value) })}
              />
            </div>
          </div>

          <div className="flex justify-end gap-2 pt-4">
            <Button variant="outline" onClick={() => setIsAddOpen(false)}>
              Cancel
            </Button>
            <Button
              onClick={() => addMutation.mutate(newContent)}
              disabled={!newContent.original_url || addMutation.isPending}
            >
              Add Content
            </Button>
          </div>
        </div>
      </Modal>
    </PageContainer>
  );
}
```

- **Step Dependencies**: Step 21.4
- **User Instructions**: Run migration `018b_cross_platform.sql`

---

# Phase 22: AI Intelligence Engine

