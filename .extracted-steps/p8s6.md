## Step 13.1: Create Ads Database Schema

- **Task**: Create database schema for Pinterest ad campaigns, ad groups, and promoted pins.

- **Files**:

### `supabase/migrations/010_pinterest_ads.sql`
```sql
-- ============================================================================
-- Migration: 010_pinterest_ads
-- Description: Pinterest Ads campaigns, ad groups, and promoted pins
-- Feature: 13 (Pinterest Ads)
-- ============================================================================

-- ============================================================================
-- Ad Accounts Table
-- ============================================================================
CREATE TABLE pinterest_ad_accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Pinterest references
  pinterest_ad_account_id TEXT NOT NULL,
  
  -- Account details
  name TEXT NOT NULL,
  currency TEXT NOT NULL DEFAULT 'USD',
  status TEXT NOT NULL DEFAULT 'ACTIVE',
  
  -- Spend tracking
  total_spend NUMERIC(12,2) NOT NULL DEFAULT 0,
  current_week_spend NUMERIC(12,2) NOT NULL DEFAULT 0,
  current_month_spend NUMERIC(12,2) NOT NULL DEFAULT 0,
  
  synced_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, pinterest_ad_account_id)
);

-- ============================================================================
-- Ad Campaigns Table
-- ============================================================================
CREATE TABLE ad_campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  ad_account_id UUID REFERENCES pinterest_ad_accounts(id) ON DELETE CASCADE NOT NULL,
  
  -- Pinterest references
  pinterest_campaign_id TEXT,
  
  -- Campaign details
  name TEXT NOT NULL,
  objective TEXT NOT NULL CHECK (objective IN (
    'AWARENESS', 'CONSIDERATION', 'CONVERSIONS', 'CATALOG_SALES'
  )),
  
  -- Budget
  daily_spend_cap NUMERIC(10,2),
  lifetime_spend_cap NUMERIC(10,2),
  
  -- Status
  status TEXT NOT NULL DEFAULT 'PAUSED' CHECK (status IN (
    'ACTIVE', 'PAUSED', 'ARCHIVED'
  )),
  
  -- Dates
  start_date DATE,
  end_date DATE,
  
  -- Performance
  total_spend NUMERIC(12,2) NOT NULL DEFAULT 0,
  impressions INTEGER NOT NULL DEFAULT 0,
  clicks INTEGER NOT NULL DEFAULT 0,
  conversions INTEGER NOT NULL DEFAULT 0,
  
  -- Haven Hub metadata
  collection TEXT CHECK (collection IN ('grounding', 'wholeness', 'growth')),
  is_seasonal BOOLEAN NOT NULL DEFAULT false,
  seasonal_event TEXT,
  
  synced_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Ad Groups Table
-- ============================================================================
CREATE TABLE ad_groups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  campaign_id UUID REFERENCES ad_campaigns(id) ON DELETE CASCADE NOT NULL,
  
  -- Pinterest references
  pinterest_ad_group_id TEXT,
  
  -- Ad group details
  name TEXT NOT NULL,
  
  -- Targeting
  targeting JSONB NOT NULL DEFAULT '{}',
  -- { interests: [], keywords: [], demographics: {}, locations: [] }
  
  -- Bidding
  bid_strategy TEXT DEFAULT 'AUTOMATIC',
  bid_amount NUMERIC(10,2),
  
  -- Budget
  budget_type TEXT DEFAULT 'DAILY' CHECK (budget_type IN ('DAILY', 'LIFETIME')),
  budget_amount NUMERIC(10,2),
  
  -- Status
  status TEXT NOT NULL DEFAULT 'PAUSED' CHECK (status IN (
    'ACTIVE', 'PAUSED', 'ARCHIVED'
  )),
  
  -- Performance
  total_spend NUMERIC(12,2) NOT NULL DEFAULT 0,
  impressions INTEGER NOT NULL DEFAULT 0,
  clicks INTEGER NOT NULL DEFAULT 0,
  
  synced_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Promoted Pins Table
-- ============================================================================
CREATE TABLE promoted_pins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  ad_group_id UUID REFERENCES ad_groups(id) ON DELETE CASCADE NOT NULL,
  pin_id UUID REFERENCES pins(id) ON DELETE SET NULL,
  
  -- Pinterest references
  pinterest_ad_id TEXT,
  pinterest_pin_id TEXT NOT NULL,
  
  -- Status
  status TEXT NOT NULL DEFAULT 'PAUSED' CHECK (status IN (
    'ACTIVE', 'PAUSED', 'ARCHIVED', 'REJECTED'
  )),
  rejection_reason TEXT,
  
  -- Creative
  destination_url TEXT,
  tracking_params JSONB DEFAULT '{}',
  
  -- Performance
  total_spend NUMERIC(12,2) NOT NULL DEFAULT 0,
  impressions INTEGER NOT NULL DEFAULT 0,
  clicks INTEGER NOT NULL DEFAULT 0,
  ctr NUMERIC(6,4),
  cpc NUMERIC(8,4),
  
  synced_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Ad Spend Budget Table (for guardrail tracking)
-- ============================================================================
CREATE TABLE ad_spend_tracking (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Period
  period_type TEXT NOT NULL CHECK (period_type IN ('daily', 'weekly', 'monthly')),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  
  -- Spend
  amount NUMERIC(12,2) NOT NULL DEFAULT 0,
  
  -- Budget (from guardrails at time of tracking)
  budget_cap NUMERIC(12,2),
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, period_type, period_start)
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_ad_accounts_user ON pinterest_ad_accounts(user_id);
CREATE INDEX idx_campaigns_user ON ad_campaigns(user_id);
CREATE INDEX idx_campaigns_account ON ad_campaigns(ad_account_id);
CREATE INDEX idx_campaigns_status ON ad_campaigns(user_id, status);
CREATE INDEX idx_ad_groups_campaign ON ad_groups(campaign_id);
CREATE INDEX idx_promoted_pins_ad_group ON promoted_pins(ad_group_id);
CREATE INDEX idx_promoted_pins_pin ON promoted_pins(pin_id) WHERE pin_id IS NOT NULL;
CREATE INDEX idx_spend_tracking_user ON ad_spend_tracking(user_id, period_type, period_start);

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE pinterest_ad_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE ad_campaigns ENABLE ROW LEVEL SECURITY;
ALTER TABLE ad_groups ENABLE ROW LEVEL SECURITY;
ALTER TABLE promoted_pins ENABLE ROW LEVEL SECURITY;
ALTER TABLE ad_spend_tracking ENABLE ROW LEVEL SECURITY;

CREATE POLICY ad_accounts_all ON pinterest_ad_accounts FOR ALL USING (user_id = auth.uid());
CREATE POLICY campaigns_all ON ad_campaigns FOR ALL USING (user_id = auth.uid());
CREATE POLICY ad_groups_all ON ad_groups FOR ALL USING (user_id = auth.uid());
CREATE POLICY promoted_pins_all ON promoted_pins FOR ALL USING (user_id = auth.uid());
CREATE POLICY spend_tracking_all ON ad_spend_tracking FOR ALL USING (user_id = auth.uid());

-- Triggers
CREATE TRIGGER campaigns_updated_at BEFORE UPDATE ON ad_campaigns
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER ad_groups_updated_at BEFORE UPDATE ON ad_groups
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER promoted_pins_updated_at BEFORE UPDATE ON promoted_pins
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Check ad spend against guardrails
-- ============================================================================
CREATE OR REPLACE FUNCTION check_ad_spend_budget(
  p_user_id UUID,
  p_amount NUMERIC
)
RETURNS TABLE (
  allowed BOOLEAN,
  weekly_remaining NUMERIC,
  monthly_remaining NUMERIC,
  message TEXT
) AS $$
DECLARE
  v_weekly_cap NUMERIC;
  v_monthly_cap NUMERIC;
  v_weekly_spent NUMERIC;
  v_monthly_spent NUMERIC;
  v_week_start DATE;
  v_month_start DATE;
BEGIN
  -- Get guardrails
  SELECT 
    (guardrails->>'weekly_ad_spend_cap')::NUMERIC,
    (guardrails->>'monthly_ad_spend_cap')::NUMERIC
  INTO v_weekly_cap, v_monthly_cap
  FROM user_settings
  WHERE user_id = p_user_id;
  
  v_weekly_cap := COALESCE(v_weekly_cap, 100);
  
  -- Calculate period starts
  v_week_start := date_trunc('week', CURRENT_DATE)::DATE;
  v_month_start := date_trunc('month', CURRENT_DATE)::DATE;
  
  -- Get current spend
  SELECT COALESCE(SUM(amount), 0) INTO v_weekly_spent
  FROM ad_spend_tracking
  WHERE user_id = p_user_id
    AND period_type = 'weekly'
    AND period_start = v_week_start;
  
  IF v_monthly_cap IS NOT NULL THEN
    SELECT COALESCE(SUM(amount), 0) INTO v_monthly_spent
    FROM ad_spend_tracking
    WHERE user_id = p_user_id
      AND period_type = 'monthly'
      AND period_start = v_month_start;
  ELSE
    v_monthly_spent := 0;
  END IF;
  
  -- Check if allowed
  IF v_weekly_spent + p_amount > v_weekly_cap THEN
    RETURN QUERY SELECT 
      false,
      v_weekly_cap - v_weekly_spent,
      CASE WHEN v_monthly_cap IS NOT NULL THEN v_monthly_cap - v_monthly_spent ELSE NULL END,
      'Weekly ad spend cap exceeded';
    RETURN;
  END IF;
  
  IF v_monthly_cap IS NOT NULL AND v_monthly_spent + p_amount > v_monthly_cap THEN
    RETURN QUERY SELECT 
      false,
      v_weekly_cap - v_weekly_spent,
      v_monthly_cap - v_monthly_spent,
      'Monthly ad spend cap exceeded';
    RETURN;
  END IF;
  
  RETURN QUERY SELECT 
    true,
    v_weekly_cap - v_weekly_spent - p_amount,
    CASE WHEN v_monthly_cap IS NOT NULL THEN v_monthly_cap - v_monthly_spent - p_amount ELSE NULL END,
    'Budget available';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### `types/ads.ts`
```typescript
export interface PinterestAdAccount {
  id: string;
  user_id: string;
  pinterest_ad_account_id: string;
  name: string;
  currency: string;
  status: string;
  total_spend: number;
  current_week_spend: number;
  current_month_spend: number;
  synced_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface AdCampaign {
  id: string;
  user_id: string;
  ad_account_id: string;
  pinterest_campaign_id: string | null;
  name: string;
  objective: CampaignObjective;
  daily_spend_cap: number | null;
  lifetime_spend_cap: number | null;
  status: CampaignStatus;
  start_date: string | null;
  end_date: string | null;
  total_spend: number;
  impressions: number;
  clicks: number;
  conversions: number;
  collection: 'grounding' | 'wholeness' | 'growth' | null;
  is_seasonal: boolean;
  seasonal_event: string | null;
  synced_at: string | null;
  created_at: string;
  updated_at: string;
  ad_groups?: AdGroup[];
}

export type CampaignObjective = 'AWARENESS' | 'CONSIDERATION' | 'CONVERSIONS' | 'CATALOG_SALES';
export type CampaignStatus = 'ACTIVE' | 'PAUSED' | 'ARCHIVED';

export interface AdGroup {
  id: string;
  user_id: string;
  campaign_id: string;
  pinterest_ad_group_id: string | null;
  name: string;
  targeting: AdTargeting;
  bid_strategy: string;
  bid_amount: number | null;
  budget_type: 'DAILY' | 'LIFETIME';
  budget_amount: number | null;
  status: CampaignStatus;
  total_spend: number;
  impressions: number;
  clicks: number;
  synced_at: string | null;
  created_at: string;
  updated_at: string;
  promoted_pins?: PromotedPin[];
}

export interface AdTargeting {
  interests?: string[];
  keywords?: string[];
  demographics?: {
    genders?: string[];
    age_ranges?: string[];
  };
  locations?: string[];
}

export interface PromotedPin {
  id: string;
  user_id: string;
  ad_group_id: string;
  pin_id: string | null;
  pinterest_ad_id: string | null;
  pinterest_pin_id: string;
  status: 'ACTIVE' | 'PAUSED' | 'ARCHIVED' | 'REJECTED';
  rejection_reason: string | null;
  destination_url: string | null;
  tracking_params: Record<string, string>;
  total_spend: number;
  impressions: number;
  clicks: number;
  ctr: number | null;
  cpc: number | null;
  synced_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface CreateCampaignRequest {
  adAccountId: string;
  name: string;
  objective: CampaignObjective;
  dailySpendCap?: number;
  lifetimeSpendCap?: number;
  startDate?: string;
  endDate?: string;
  collection?: 'grounding' | 'wholeness' | 'growth';
  isSeasonal?: boolean;
  seasonalEvent?: string;
}

export interface AdSpendCheck {
  allowed: boolean;
  weekly_remaining: number | null;
  monthly_remaining: number | null;
  message: string;
}
```

- **Step Dependencies**: Step 12.2
- **User Instructions**: Run migration

---

