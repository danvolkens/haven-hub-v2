## Step 19.5: Create Coupon Manager

- **Task**: Create the comprehensive coupon/discount code management system.

- **Files**:

### `supabase/migrations/016b_coupons.sql`
```sql
-- ============================================================================
-- Migration: 016b_coupons
-- Description: Coupon and discount code management
-- Feature: 18.8 (Coupon Manager)
-- ============================================================================

-- ============================================================================
-- Coupons Table
-- ============================================================================
CREATE TABLE coupons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Code
  code TEXT NOT NULL,
  
  -- Discount Type
  discount_type TEXT NOT NULL CHECK (discount_type IN (
    'percentage',       -- X% off
    'fixed_amount',     -- $X off
    'free_shipping',    -- Free shipping
    'buy_x_get_y'       -- Buy X get Y
  )),
  
  -- Discount Value
  discount_value DECIMAL(10, 2), -- Percentage or fixed amount
  buy_quantity INTEGER,          -- For buy_x_get_y
  get_quantity INTEGER,          -- For buy_x_get_y
  
  -- Usage Limits
  usage_limit INTEGER,           -- Total uses allowed (null = unlimited)
  per_customer_limit INTEGER DEFAULT 1, -- Uses per customer
  usage_count INTEGER NOT NULL DEFAULT 0,
  
  -- Requirements
  minimum_purchase DECIMAL(10, 2),
  minimum_quantity INTEGER,
  
  -- Restrictions
  collection_ids TEXT[],         -- Limit to specific collections
  product_ids TEXT[],            -- Limit to specific products
  exclude_sale_items BOOLEAN NOT NULL DEFAULT false,
  first_time_only BOOLEAN NOT NULL DEFAULT false,
  
  -- Date Range
  starts_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ,
  
  -- Shopify Sync
  shopify_discount_id TEXT,
  shopify_synced_at TIMESTAMPTZ,
  
  -- Status
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN (
    'draft', 'active', 'paused', 'expired', 'depleted'
  )),
  
  -- Tracking
  total_discount_amount DECIMAL(10, 2) NOT NULL DEFAULT 0,
  total_orders INTEGER NOT NULL DEFAULT 0,
  
  -- Metadata
  description TEXT,
  internal_notes TEXT,
  
  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, code)
);

-- ============================================================================
-- Coupon Uses Table (for tracking per-customer usage)
-- ============================================================================
CREATE TABLE coupon_uses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  coupon_id UUID REFERENCES coupons(id) ON DELETE CASCADE NOT NULL,
  customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,
  customer_email TEXT NOT NULL,
  
  order_id TEXT,
  shopify_order_id TEXT,
  
  discount_amount DECIMAL(10, 2) NOT NULL,
  order_total DECIMAL(10, 2),
  
  used_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_coupons_user ON coupons(user_id);
CREATE INDEX idx_coupons_code ON coupons(user_id, code);
CREATE INDEX idx_coupons_status ON coupons(user_id, status);
CREATE INDEX idx_coupons_active ON coupons(user_id, starts_at, expires_at) 
  WHERE status = 'active';

CREATE INDEX idx_coupon_uses_coupon ON coupon_uses(coupon_id);
CREATE INDEX idx_coupon_uses_customer ON coupon_uses(customer_email);

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE coupons ENABLE ROW LEVEL SECURITY;
ALTER TABLE coupon_uses ENABLE ROW LEVEL SECURITY;

CREATE POLICY coupons_all ON coupons FOR ALL USING (user_id = auth.uid());

CREATE POLICY coupon_uses_all ON coupon_uses FOR ALL 
  USING (coupon_id IN (SELECT id FROM coupons WHERE user_id = auth.uid()));

-- ============================================================================
-- Trigger
-- ============================================================================
CREATE TRIGGER coupons_updated_at BEFORE UPDATE ON coupons
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Record coupon use
-- ============================================================================
CREATE OR REPLACE FUNCTION record_coupon_use(
  p_coupon_code TEXT,
  p_user_id UUID,
  p_customer_email TEXT,
  p_customer_id UUID,
  p_order_id TEXT,
  p_shopify_order_id TEXT,
  p_discount_amount DECIMAL,
  p_order_total DECIMAL
) RETURNS BOOLEAN AS $$
DECLARE
  v_coupon coupons;
  v_customer_uses INTEGER;
BEGIN
  -- Get and lock coupon
  SELECT * INTO v_coupon FROM coupons 
  WHERE user_id = p_user_id AND code = p_coupon_code
  FOR UPDATE;
  
  IF NOT FOUND THEN RETURN false; END IF;
  IF v_coupon.status != 'active' THEN RETURN false; END IF;
  
  -- Check usage limit
  IF v_coupon.usage_limit IS NOT NULL AND v_coupon.usage_count >= v_coupon.usage_limit THEN
    RETURN false;
  END IF;
  
  -- Check per-customer limit
  SELECT COUNT(*) INTO v_customer_uses FROM coupon_uses 
  WHERE coupon_id = v_coupon.id AND customer_email = p_customer_email;
  
  IF v_coupon.per_customer_limit IS NOT NULL AND v_customer_uses >= v_coupon.per_customer_limit THEN
    RETURN false;
  END IF;
  
  -- Record use
  INSERT INTO coupon_uses (
    coupon_id, customer_id, customer_email, order_id, shopify_order_id,
    discount_amount, order_total
  ) VALUES (
    v_coupon.id, p_customer_id, p_customer_email, p_order_id, p_shopify_order_id,
    p_discount_amount, p_order_total
  );
  
  -- Update coupon stats
  UPDATE coupons SET
    usage_count = usage_count + 1,
    total_discount_amount = total_discount_amount + p_discount_amount,
    total_orders = total_orders + 1,
    status = CASE 
      WHEN usage_limit IS NOT NULL AND usage_count + 1 >= usage_limit THEN 'depleted'
      ELSE status
    END
  WHERE id = v_coupon.id;
  
  RETURN true;
END;
$$ LANGUAGE plpgsql;
```

### `types/coupons.ts`
```typescript
export type CouponDiscountType = 
  | 'percentage' 
  | 'fixed_amount' 
  | 'free_shipping' 
  | 'buy_x_get_y';

export type CouponStatus = 'draft' | 'active' | 'paused' | 'expired' | 'depleted';

export interface Coupon {
  id: string;
  user_id: string;
  code: string;
  discount_type: CouponDiscountType;
  discount_value?: number;
  buy_quantity?: number;
  get_quantity?: number;
  usage_limit?: number;
  per_customer_limit?: number;
  usage_count: number;
  minimum_purchase?: number;
  minimum_quantity?: number;
  collection_ids?: string[];
  product_ids?: string[];
  exclude_sale_items: boolean;
  first_time_only: boolean;
  starts_at: string;
  expires_at?: string;
  shopify_discount_id?: string;
  shopify_synced_at?: string;
  status: CouponStatus;
  total_discount_amount: number;
  total_orders: number;
  description?: string;
  internal_notes?: string;
  created_at: string;
  updated_at: string;
}

export interface CouponUse {
  id: string;
  coupon_id: string;
  customer_id?: string;
  customer_email: string;
  order_id?: string;
  shopify_order_id?: string;
  discount_amount: number;
  order_total?: number;
  used_at: string;
}

export interface CreateCouponInput {
  code: string;
  discount_type: CouponDiscountType;
  discount_value?: number;
  buy_quantity?: number;
  get_quantity?: number;
  usage_limit?: number;
  per_customer_limit?: number;
  minimum_purchase?: number;
  minimum_quantity?: number;
  collection_ids?: string[];
  product_ids?: string[];
  exclude_sale_items?: boolean;
  first_time_only?: boolean;
  starts_at?: string;
  expires_at?: string;
  description?: string;
  internal_notes?: string;
}
```

### `lib/coupons/coupon-service.ts`
```typescript
import { createClient } from '@/lib/supabase/server';
import { Coupon, CreateCouponInput } from '@/types/coupons';

export async function createCoupon(
  userId: string,
  input: CreateCouponInput
): Promise<Coupon> {
  const supabase = createClient();

  const { data: coupon, error } = await supabase
    .from('coupons')
    .insert({
      user_id: userId,
      code: input.code.toUpperCase(),
      discount_type: input.discount_type,
      discount_value: input.discount_value,
      buy_quantity: input.buy_quantity,
      get_quantity: input.get_quantity,
      usage_limit: input.usage_limit,
      per_customer_limit: input.per_customer_limit ?? 1,
      minimum_purchase: input.minimum_purchase,
      minimum_quantity: input.minimum_quantity,
      collection_ids: input.collection_ids,
      product_ids: input.product_ids,
      exclude_sale_items: input.exclude_sale_items ?? false,
      first_time_only: input.first_time_only ?? false,
      starts_at: input.starts_at || new Date().toISOString(),
      expires_at: input.expires_at,
      description: input.description,
      internal_notes: input.internal_notes,
      status: 'active',
    })
    .select()
    .single();

  if (error) throw new Error(`Failed to create coupon: ${error.message}`);

  return coupon;
}

export async function updateCoupon(
  userId: string,
  couponId: string,
  updates: Partial<CreateCouponInput & { status: string }>
): Promise<Coupon> {
  const supabase = createClient();

  if (updates.code) {
    updates.code = updates.code.toUpperCase();
  }

  const { data: coupon, error } = await supabase
    .from('coupons')
    .update(updates)
    .eq('id', couponId)
    .eq('user_id', userId)
    .select()
    .single();

  if (error) throw new Error(`Failed to update coupon: ${error.message}`);

  return coupon;
}

export async function getCouponStats(userId: string): Promise<{
  totalCoupons: number;
  activeCoupons: number;
  totalUsage: number;
  totalDiscountGiven: number;
}> {
  const supabase = createClient();

  const { data: coupons } = await supabase
    .from('coupons')
    .select('status, usage_count, total_discount_amount')
    .eq('user_id', userId);

  return {
    totalCoupons: coupons?.length || 0,
    activeCoupons: coupons?.filter(c => c.status === 'active').length || 0,
    totalUsage: coupons?.reduce((sum, c) => sum + c.usage_count, 0) || 0,
    totalDiscountGiven: coupons?.reduce((sum, c) => sum + Number(c.total_discount_amount), 0) || 0,
  };
}

export async function validateCoupon(
  userId: string,
  code: string,
  customerEmail: string,
  cartTotal: number
): Promise<{ valid: boolean; reason?: string; coupon?: Coupon }> {
  const supabase = createClient();

  const { data: coupon } = await supabase
    .from('coupons')
    .select('*')
    .eq('user_id', userId)
    .eq('code', code.toUpperCase())
    .single();

  if (!coupon) {
    return { valid: false, reason: 'Invalid coupon code' };
  }

  if (coupon.status !== 'active') {
    return { valid: false, reason: 'Coupon is not active' };
  }

  const now = new Date();
  if (coupon.starts_at && new Date(coupon.starts_at) > now) {
    return { valid: false, reason: 'Coupon is not yet active' };
  }

  if (coupon.expires_at && new Date(coupon.expires_at) < now) {
    return { valid: false, reason: 'Coupon has expired' };
  }

  if (coupon.usage_limit && coupon.usage_count >= coupon.usage_limit) {
    return { valid: false, reason: 'Coupon usage limit reached' };
  }

  if (coupon.minimum_purchase && cartTotal < coupon.minimum_purchase) {
    return { 
      valid: false, 
      reason: `Minimum purchase of $${coupon.minimum_purchase} required` 
    };
  }

  // Check per-customer usage
  if (coupon.per_customer_limit) {
    const { count } = await supabase
      .from('coupon_uses')
      .select('*', { count: 'exact', head: true })
      .eq('coupon_id', coupon.id)
      .eq('customer_email', customerEmail);

    if (count && count >= coupon.per_customer_limit) {
      return { valid: false, reason: 'You have already used this coupon' };
    }
  }

  return { valid: true, coupon };
}
```

### `app/api/coupons/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { createCoupon, getCouponStats } from '@/lib/coupons/coupon-service';

// GET /api/coupons - List coupons
export async function GET(request: NextRequest) {
  const supabase = createClient();
  
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const searchParams = request.nextUrl.searchParams;
  const status = searchParams.get('status');
  const includeStats = searchParams.get('stats') === 'true';

  let query = supabase
    .from('coupons')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false });

  if (status) {
    query = query.eq('status', status);
  }

  const { data: coupons, error } = await query;

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  const response: any = { coupons };

  if (includeStats) {
    response.stats = await getCouponStats(user.id);
  }

  return NextResponse.json(response);
}

// POST /api/coupons - Create coupon
export async function POST(request: NextRequest) {
  const supabase = createClient();
  
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const body = await request.json();

  try {
    const coupon = await createCoupon(user.id, body);
    return NextResponse.json({ coupon }, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to create coupon' },
      { status: 500 }
    );
  }
}
```

### `app/(dashboard)/dashboard/campaigns/coupons/page.tsx`
```tsx
'use client';

import { useState } from 'react';
import { PageContainer } from '@/components/layout/page-container';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select } from '@/components/ui/select';
import { Modal } from '@/components/ui/modal';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Coupon, CouponStatus, CouponDiscountType } from '@/types/coupons';
import { Plus, Edit2, Trash2, Copy, Tag, Percent, DollarSign, Truck } from 'lucide-react';

const STATUS_BADGES: Record<CouponStatus, { variant: string; label: string }> = {
  draft: { variant: 'default', label: 'Draft' },
  active: { variant: 'success', label: 'Active' },
  paused: { variant: 'warning', label: 'Paused' },
  expired: { variant: 'secondary', label: 'Expired' },
  depleted: { variant: 'secondary', label: 'Depleted' },
};

const DISCOUNT_ICONS: Record<CouponDiscountType, any> = {
  percentage: Percent,
  fixed_amount: DollarSign,
  free_shipping: Truck,
  buy_x_get_y: Tag,
};

export default function CouponsPage() {
  const queryClient = useQueryClient();
  const [isCreateOpen, setIsCreateOpen] = useState(false);
  const [newCoupon, setNewCoupon] = useState({
    code: '',
    discount_type: 'percentage' as CouponDiscountType,
    discount_value: 10,
    usage_limit: undefined as number | undefined,
    expires_at: '',
    description: '',
  });

  const { data, isLoading } = useQuery({
    queryKey: ['coupons'],
    queryFn: async () => {
      const response = await fetch('/api/coupons?stats=true');
      if (!response.ok) throw new Error('Failed to fetch coupons');
      return response.json();
    },
  });

  const createMutation = useMutation({
    mutationFn: async (coupon: typeof newCoupon) => {
      const response = await fetch('/api/coupons', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(coupon),
      });
      if (!response.ok) throw new Error('Failed to create coupon');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['coupons'] });
      setIsCreateOpen(false);
      setNewCoupon({
        code: '',
        discount_type: 'percentage',
        discount_value: 10,
        usage_limit: undefined,
        expires_at: '',
        description: '',
      });
    },
  });

  const deleteMutation = useMutation({
    mutationFn: async (id: string) => {
      const response = await fetch(`/api/coupons/${id}`, { method: 'DELETE' });
      if (!response.ok) throw new Error('Failed to delete coupon');
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['coupons'] });
    },
  });

  const coupons = data?.coupons || [];
  const stats = data?.stats;

  const formatDiscount = (coupon: Coupon): string => {
    switch (coupon.discount_type) {
      case 'percentage':
        return `${coupon.discount_value}% off`;
      case 'fixed_amount':
        return `$${coupon.discount_value} off`;
      case 'free_shipping':
        return 'Free shipping';
      case 'buy_x_get_y':
        return `Buy ${coupon.buy_quantity} get ${coupon.get_quantity}`;
      default:
        return '';
    }
  };

  const copyCode = (code: string) => {
    navigator.clipboard.writeText(code);
  };

  return (
    <PageContainer
      title="Coupons"
      description="Manage discount codes and promotions"
      actions={
        <Button onClick={() => setIsCreateOpen(true)}>
          <Plus className="h-4 w-4 mr-2" />
          Create Coupon
        </Button>
      }
    >
      {/* Stats */}
      {stats && (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          <Card className="p-4">
            <div className="text-sm text-muted-foreground">Total Coupons</div>
            <div className="text-2xl font-bold">{stats.totalCoupons}</div>
          </Card>
          <Card className="p-4">
            <div className="text-sm text-muted-foreground">Active</div>
            <div className="text-2xl font-bold">{stats.activeCoupons}</div>
          </Card>
          <Card className="p-4">
            <div className="text-sm text-muted-foreground">Total Uses</div>
            <div className="text-2xl font-bold">{stats.totalUsage}</div>
          </Card>
          <Card className="p-4">
            <div className="text-sm text-muted-foreground">Discount Given</div>
            <div className="text-2xl font-bold">
              ${stats.totalDiscountGiven.toLocaleString()}
            </div>
          </Card>
        </div>
      )}

      {/* Coupons List */}
      {isLoading ? (
        <div className="text-center py-12 text-muted-foreground">Loading...</div>
      ) : coupons.length === 0 ? (
        <Card className="p-12 text-center">
          <p className="text-muted-foreground mb-4">No coupons yet</p>
          <Button onClick={() => setIsCreateOpen(true)}>
            <Plus className="h-4 w-4 mr-2" />
            Create Your First Coupon
          </Button>
        </Card>
      ) : (
        <div className="space-y-3">
          {coupons.map((coupon: Coupon) => {
            const Icon = DISCOUNT_ICONS[coupon.discount_type];
            return (
              <Card key={coupon.id} className="p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="p-2 bg-sage-100 rounded-lg">
                      <Icon className="h-5 w-5 text-sage-600" />
                    </div>
                    <div>
                      <div className="flex items-center gap-2">
                        <code className="font-mono font-bold text-lg">{coupon.code}</code>
                        <button
                          onClick={() => copyCode(coupon.code)}
                          className="p-1 hover:bg-gray-100 rounded"
                        >
                          <Copy className="h-4 w-4 text-muted-foreground" />
                        </button>
                        <Badge variant={STATUS_BADGES[coupon.status].variant as any}>
                          {STATUS_BADGES[coupon.status].label}
                        </Badge>
                      </div>
                      <div className="text-sm text-muted-foreground">
                        {formatDiscount(coupon)}
                        {coupon.expires_at && (
                          <> • Expires {new Date(coupon.expires_at).toLocaleDateString()}</>
                        )}
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center gap-6">
                    <div className="text-right">
                      <div className="font-semibold">{coupon.usage_count}</div>
                      <div className="text-xs text-muted-foreground">
                        {coupon.usage_limit ? `of ${coupon.usage_limit}` : 'uses'}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="font-semibold">
                        ${Number(coupon.total_discount_amount).toLocaleString()}
                      </div>
                      <div className="text-xs text-muted-foreground">discounted</div>
                    </div>
                    <div className="flex gap-1">
                      <Button variant="ghost" size="sm">
                        <Edit2 className="h-4 w-4" />
                      </Button>
                      <Button 
                        variant="ghost" 
                        size="sm"
                        onClick={() => {
                          if (confirm('Delete this coupon?')) {
                            deleteMutation.mutate(coupon.id);
                          }
                        }}
                      >
                        <Trash2 className="h-4 w-4 text-red-500" />
                      </Button>
                    </div>
                  </div>
                </div>
              </Card>
            );
          })}
        </div>
      )}

      {/* Create Modal */}
      <Modal
        isOpen={isCreateOpen}
        onClose={() => setIsCreateOpen(false)}
        title="Create Coupon"
      >
        <div className="space-y-4">
          <div>
            <Label>Coupon Code</Label>
            <Input
              value={newCoupon.code}
              onChange={(e) => setNewCoupon({ ...newCoupon, code: e.target.value.toUpperCase() })}
              placeholder="SUMMER20"
            />
          </div>

          <div>
            <Label>Discount Type</Label>
            <Select
              value={newCoupon.discount_type}
              onChange={(value) => setNewCoupon({ ...newCoupon, discount_type: value as CouponDiscountType })}
              options={[
                { value: 'percentage', label: 'Percentage Off' },
                { value: 'fixed_amount', label: 'Fixed Amount Off' },
                { value: 'free_shipping', label: 'Free Shipping' },
              ]}
            />
          </div>

          {newCoupon.discount_type !== 'free_shipping' && (
            <div>
              <Label>
                {newCoupon.discount_type === 'percentage' ? 'Percentage' : 'Amount'}
              </Label>
              <Input
                type="number"
                value={newCoupon.discount_value}
                onChange={(e) => setNewCoupon({ ...newCoupon, discount_value: Number(e.target.value) })}
              />
            </div>
          )}

          <div>
            <Label>Usage Limit (optional)</Label>
            <Input
              type="number"
              value={newCoupon.usage_limit || ''}
              onChange={(e) => setNewCoupon({ 
                ...newCoupon, 
                usage_limit: e.target.value ? Number(e.target.value) : undefined 
              })}
              placeholder="Unlimited"
            />
          </div>

          <div>
            <Label>Expires (optional)</Label>
            <Input
              type="date"
              value={newCoupon.expires_at}
              onChange={(e) => setNewCoupon({ ...newCoupon, expires_at: e.target.value })}
            />
          </div>

          <div className="flex justify-end gap-2 pt-4">
            <Button variant="outline" onClick={() => setIsCreateOpen(false)}>
              Cancel
            </Button>
            <Button 
              onClick={() => createMutation.mutate(newCoupon)}
              disabled={!newCoupon.code || createMutation.isPending}
            >
              {createMutation.isPending ? 'Creating...' : 'Create Coupon'}
            </Button>
          </div>
        </div>
      </Modal>
    </PageContainer>
  );
}
```

- **Step Dependencies**: Step 19.4
- **User Instructions**: Run migrations `016a_gifts.sql` and `016b_coupons.sql`

---

**Part 10 Summary**

This part covers:

**Phase 17 (Customer Journey):**
- Unified customers table with stage tracking
- Touchpoints table for all customer interactions
- Stage transitions with trigger tracking
- Customer segments with dynamic membership
- Collection affinity calculation
- Journey service for recording touchpoints
- Stage progression logic (visitor → lead → customer → repeat → VIP)
- At-risk and churn detection
- Journey analytics API and funnel visualization

**Phase 18 (Win-Back Campaigns):**
- Win-back campaigns with targeting criteria
- Recipients table with status tracking
- Incentive configuration (discounts, free shipping, etc.)
- Klaviyo flow integration
- Recovery tracking with revenue attribution
- Eligibility function based on inactivity and LTV
- Win-back processing service

**Phase 19 (Loyalty Program):**
- Loyalty tiers with configurable benefits
- Customer loyalty records with points balance
- Points transactions with expiration
- Rewards catalog with redemption tracking
- Points multipliers based on tier
- Referral program with code generation
- Tier upgrade automation
- Loyalty dashboard analytics
- **Referral Program UI** with stats and leaderboard
- **Gifting System** with scheduled delivery and claim pages
- **Coupon Manager** with usage tracking and validation

---

**Remaining phases to cover:**
- **Part 11:** Phase 20-23 (Attribution, Campaigns, Intelligence, Daily Digest, Polish)
