## Step 19.1: Create Loyalty Database Schema

- **Task**: Create database schema for loyalty points, tiers, and rewards.

- **Files**:

### `supabase/migrations/016_loyalty.sql`
```sql
-- ============================================================================
-- Migration: 016_loyalty
-- Description: Loyalty program with points, tiers, and rewards
-- Feature: 19 (Loyalty Program)
-- ============================================================================

-- ============================================================================
-- Loyalty Tiers Table
-- ============================================================================
CREATE TABLE loyalty_tiers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Tier details
  name TEXT NOT NULL,
  slug TEXT NOT NULL,
  description TEXT,
  
  -- Thresholds
  min_points INTEGER NOT NULL DEFAULT 0,
  min_lifetime_value NUMERIC(10,2),
  min_orders INTEGER,
  
  -- Benefits
  points_multiplier NUMERIC(3,2) NOT NULL DEFAULT 1.0, -- e.g., 1.5x points
  discount_percentage NUMERIC(5,2), -- Automatic discount
  free_shipping BOOLEAN NOT NULL DEFAULT false,
  early_access_days INTEGER DEFAULT 0, -- Early access to new products
  exclusive_products BOOLEAN NOT NULL DEFAULT false,
  
  -- Display
  badge_color TEXT,
  badge_icon TEXT,
  
  -- Order (for tier progression)
  tier_order INTEGER NOT NULL DEFAULT 0,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, slug)
);

-- ============================================================================
-- Customer Loyalty Table
-- ============================================================================
CREATE TABLE customer_loyalty (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE NOT NULL,
  
  -- Points
  points_balance INTEGER NOT NULL DEFAULT 0,
  points_earned_lifetime INTEGER NOT NULL DEFAULT 0,
  points_redeemed_lifetime INTEGER NOT NULL DEFAULT 0,
  
  -- Current tier
  tier_id UUID REFERENCES loyalty_tiers(id) ON DELETE SET NULL,
  tier_achieved_at TIMESTAMPTZ,
  
  -- Progress to next tier
  points_to_next_tier INTEGER,
  next_tier_id UUID REFERENCES loyalty_tiers(id) ON DELETE SET NULL,
  
  -- Referral tracking
  referral_code TEXT UNIQUE,
  referrals_count INTEGER NOT NULL DEFAULT 0,
  referral_points_earned INTEGER NOT NULL DEFAULT 0,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(customer_id)
);

-- ============================================================================
-- Points Transactions Table
-- ============================================================================
CREATE TABLE points_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  customer_loyalty_id UUID REFERENCES customer_loyalty(id) ON DELETE CASCADE NOT NULL,
  
  -- Transaction details
  type TEXT NOT NULL CHECK (type IN (
    'earn_purchase',      -- Points from purchase
    'earn_referral',      -- Points from referral
    'earn_review',        -- Points from review
    'earn_birthday',      -- Birthday bonus
    'earn_signup',        -- Signup bonus
    'earn_bonus',         -- Manual bonus
    'redeem_discount',    -- Redeemed for discount
    'redeem_product',     -- Redeemed for product
    'expire',             -- Points expired
    'adjustment'          -- Manual adjustment
  )),
  
  -- Amount
  points INTEGER NOT NULL, -- Positive for earn, negative for redeem
  
  -- Balance tracking
  balance_before INTEGER NOT NULL,
  balance_after INTEGER NOT NULL,
  
  -- Reference
  reference_id TEXT,
  reference_type TEXT, -- 'order', 'review', 'referral', etc.
  
  -- Details
  description TEXT,
  metadata JSONB DEFAULT '{}',
  
  -- Expiration (for earned points)
  expires_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Loyalty Rewards Table (redeemable rewards)
-- ============================================================================
CREATE TABLE loyalty_rewards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Reward details
  name TEXT NOT NULL,
  description TEXT,
  
  -- Cost
  points_cost INTEGER NOT NULL,
  
  -- Reward type
  reward_type TEXT NOT NULL CHECK (reward_type IN (
    'percentage_discount',
    'fixed_discount',
    'free_shipping',
    'free_product',
    'exclusive_access'
  )),
  
  -- Reward value
  reward_value NUMERIC(10,2), -- Discount amount or product value
  reward_product_id TEXT, -- For free product rewards
  
  -- Eligibility
  min_tier_id UUID REFERENCES loyalty_tiers(id) ON DELETE SET NULL,
  min_orders INTEGER,
  
  -- Limits
  redemption_limit INTEGER, -- Per customer
  total_available INTEGER, -- Total inventory
  total_redeemed INTEGER NOT NULL DEFAULT 0,
  
  -- Status
  is_active BOOLEAN NOT NULL DEFAULT true,
  starts_at TIMESTAMPTZ,
  ends_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Reward Redemptions Table
-- ============================================================================
CREATE TABLE reward_redemptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  customer_loyalty_id UUID REFERENCES customer_loyalty(id) ON DELETE CASCADE NOT NULL,
  reward_id UUID REFERENCES loyalty_rewards(id) ON DELETE SET NULL NOT NULL,
  points_transaction_id UUID REFERENCES points_transactions(id) ON DELETE SET NULL,
  
  -- Redemption details
  points_spent INTEGER NOT NULL,
  
  -- Generated code (if applicable)
  discount_code TEXT,
  
  -- Usage tracking
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN (
    'pending',   -- Code generated but not used
    'used',      -- Applied to order
    'expired',   -- Code expired
    'refunded'   -- Points refunded
  )),
  
  used_at TIMESTAMPTZ,
  used_order_id TEXT,
  
  expires_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_loyalty_tiers_user ON loyalty_tiers(user_id, tier_order);
CREATE INDEX idx_customer_loyalty_user ON customer_loyalty(user_id);
CREATE INDEX idx_customer_loyalty_customer ON customer_loyalty(customer_id);
CREATE INDEX idx_customer_loyalty_tier ON customer_loyalty(tier_id);
CREATE INDEX idx_customer_loyalty_referral ON customer_loyalty(referral_code);

CREATE INDEX idx_points_transactions_loyalty ON points_transactions(customer_loyalty_id);
CREATE INDEX idx_points_transactions_type ON points_transactions(user_id, type);
CREATE INDEX idx_points_transactions_created ON points_transactions(user_id, created_at DESC);

CREATE INDEX idx_loyalty_rewards_user ON loyalty_rewards(user_id);
CREATE INDEX idx_loyalty_rewards_active ON loyalty_rewards(user_id, is_active, starts_at, ends_at);

CREATE INDEX idx_redemptions_loyalty ON reward_redemptions(customer_loyalty_id);
CREATE INDEX idx_redemptions_status ON reward_redemptions(user_id, status);

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE loyalty_tiers ENABLE ROW LEVEL SECURITY;
ALTER TABLE customer_loyalty ENABLE ROW LEVEL SECURITY;
ALTER TABLE points_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE loyalty_rewards ENABLE ROW LEVEL SECURITY;
ALTER TABLE reward_redemptions ENABLE ROW LEVEL SECURITY;

CREATE POLICY tiers_all ON loyalty_tiers FOR ALL USING (user_id = auth.uid());
CREATE POLICY loyalty_all ON customer_loyalty FOR ALL USING (user_id = auth.uid());
CREATE POLICY transactions_all ON points_transactions FOR ALL USING (user_id = auth.uid());
CREATE POLICY rewards_all ON loyalty_rewards FOR ALL USING (user_id = auth.uid());
CREATE POLICY redemptions_all ON reward_redemptions FOR ALL USING (user_id = auth.uid());

CREATE TRIGGER tiers_updated_at BEFORE UPDATE ON loyalty_tiers
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER loyalty_updated_at BEFORE UPDATE ON customer_loyalty
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER rewards_updated_at BEFORE UPDATE ON loyalty_rewards
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER redemptions_updated_at BEFORE UPDATE ON reward_redemptions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Function: Award points
-- ============================================================================
CREATE OR REPLACE FUNCTION award_points(
  p_customer_id UUID,
  p_type TEXT,
  p_points INTEGER,
  p_reference_id TEXT DEFAULT NULL,
  p_reference_type TEXT DEFAULT NULL,
  p_description TEXT DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  v_loyalty RECORD;
  v_multiplier NUMERIC;
  v_final_points INTEGER;
  v_transaction_id UUID;
BEGIN
  -- Get customer loyalty record
  SELECT cl.*, lt.points_multiplier INTO v_loyalty
  FROM customer_loyalty cl
  LEFT JOIN loyalty_tiers lt ON cl.tier_id = lt.id
  WHERE cl.customer_id = p_customer_id;
  
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Customer loyalty record not found';
  END IF;
  
  -- Apply multiplier for purchase points
  v_multiplier := COALESCE(v_loyalty.points_multiplier, 1.0);
  v_final_points := CASE 
    WHEN p_type = 'earn_purchase' THEN ROUND(p_points * v_multiplier)
    ELSE p_points
  END;
  
  -- Create transaction
  INSERT INTO points_transactions (
    user_id,
    customer_loyalty_id,
    type,
    points,
    balance_before,
    balance_after,
    reference_id,
    reference_type,
    description,
    expires_at
  ) VALUES (
    v_loyalty.user_id,
    v_loyalty.id,
    p_type,
    v_final_points,
    v_loyalty.points_balance,
    v_loyalty.points_balance + v_final_points,
    p_reference_id,
    p_reference_type,
    p_description,
    CASE WHEN p_type LIKE 'earn_%' THEN NOW() + INTERVAL '1 year' ELSE NULL END
  )
  RETURNING id INTO v_transaction_id;
  
  -- Update balance
  UPDATE customer_loyalty SET
    points_balance = points_balance + v_final_points,
    points_earned_lifetime = points_earned_lifetime + GREATEST(v_final_points, 0),
    updated_at = NOW()
  WHERE id = v_loyalty.id;
  
  -- Check tier upgrade
  PERFORM check_tier_upgrade(p_customer_id);
  
  RETURN v_transaction_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- Function: Check tier upgrade
-- ============================================================================
CREATE OR REPLACE FUNCTION check_tier_upgrade(p_customer_id UUID)
RETURNS UUID AS $$
DECLARE
  v_loyalty RECORD;
  v_customer RECORD;
  v_new_tier RECORD;
BEGIN
  -- Get customer and loyalty info
  SELECT * INTO v_customer FROM customers WHERE id = p_customer_id;
  SELECT * INTO v_loyalty FROM customer_loyalty WHERE customer_id = p_customer_id;
  
  -- Find highest eligible tier
  SELECT * INTO v_new_tier
  FROM loyalty_tiers
  WHERE user_id = v_loyalty.user_id
    AND min_points <= v_loyalty.points_earned_lifetime
    AND (min_lifetime_value IS NULL OR min_lifetime_value <= v_customer.lifetime_value)
    AND (min_orders IS NULL OR min_orders <= v_customer.total_orders)
  ORDER BY tier_order DESC
  LIMIT 1;
  
  -- Update if different tier
  IF v_new_tier.id IS NOT NULL AND v_new_tier.id != v_loyalty.tier_id THEN
    UPDATE customer_loyalty SET
      tier_id = v_new_tier.id,
      tier_achieved_at = NOW(),
      updated_at = NOW()
    WHERE id = v_loyalty.id;
    
    RETURN v_new_tier.id;
  END IF;
  
  RETURN v_loyalty.tier_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- Insert default loyalty tiers
-- ============================================================================
-- Note: These will be created per user when they set up loyalty
```

### `types/loyalty.ts`
```typescript
export interface LoyaltyTier {
  id: string;
  user_id: string;
  name: string;
  slug: string;
  description: string | null;
  min_points: number;
  min_lifetime_value: number | null;
  min_orders: number | null;
  points_multiplier: number;
  discount_percentage: number | null;
  free_shipping: boolean;
  early_access_days: number;
  exclusive_products: boolean;
  badge_color: string | null;
  badge_icon: string | null;
  tier_order: number;
  created_at: string;
  updated_at: string;
}

export interface CustomerLoyalty {
  id: string;
  user_id: string;
  customer_id: string;
  points_balance: number;
  points_earned_lifetime: number;
  points_redeemed_lifetime: number;
  tier_id: string | null;
  tier_achieved_at: string | null;
  points_to_next_tier: number | null;
  next_tier_id: string | null;
  referral_code: string | null;
  referrals_count: number;
  referral_points_earned: number;
  created_at: string;
  updated_at: string;
  tier?: LoyaltyTier;
}

export interface PointsTransaction {
  id: string;
  user_id: string;
  customer_loyalty_id: string;
  type: TransactionType;
  points: number;
  balance_before: number;
  balance_after: number;
  reference_id: string | null;
  reference_type: string | null;
  description: string | null;
  metadata: Record<string, unknown>;
  expires_at: string | null;
  created_at: string;
}

export type TransactionType = 
  | 'earn_purchase'
  | 'earn_referral'
  | 'earn_review'
  | 'earn_birthday'
  | 'earn_signup'
  | 'earn_bonus'
  | 'redeem_discount'
  | 'redeem_product'
  | 'expire'
  | 'adjustment';

export interface LoyaltyReward {
  id: string;
  user_id: string;
  name: string;
  description: string | null;
  points_cost: number;
  reward_type: RewardType;
  reward_value: number | null;
  reward_product_id: string | null;
  min_tier_id: string | null;
  min_orders: number | null;
  redemption_limit: number | null;
  total_available: number | null;
  total_redeemed: number;
  is_active: boolean;
  starts_at: string | null;
  ends_at: string | null;
  created_at: string;
  updated_at: string;
}

export type RewardType = 
  | 'percentage_discount'
  | 'fixed_discount'
  | 'free_shipping'
  | 'free_product'
  | 'exclusive_access';

export interface RewardRedemption {
  id: string;
  user_id: string;
  customer_loyalty_id: string;
  reward_id: string;
  points_transaction_id: string | null;
  points_spent: number;
  discount_code: string | null;
  status: 'pending' | 'used' | 'expired' | 'refunded';
  used_at: string | null;
  used_order_id: string | null;
  expires_at: string | null;
  created_at: string;
  updated_at: string;
}
```

- **Step Dependencies**: Step 17.1
- **User Instructions**: Run migration

---

