## Step 13.3: Create Ads API Endpoints

- **Task**: Build API routes for ad campaign management.

- **Files**:

### `app/api/ads/campaigns/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { createServerSupabaseClient } from '@/lib/supabase/server';
import { getUserId } from '@/lib/auth/session';
import { createCampaign } from '@/lib/pinterest/ads-service';

const createSchema = z.object({
  adAccountId: z.string().uuid(),
  name: z.string().min(1).max(100),
  objective: z.enum(['AWARENESS', 'CONSIDERATION', 'CONVERSIONS', 'CATALOG_SALES']),
  dailySpendCap: z.number().positive().optional(),
  lifetimeSpendCap: z.number().positive().optional(),
  startDate: z.string().optional(),
  endDate: z.string().optional(),
  collection: z.enum(['grounding', 'wholeness', 'growth']).optional(),
  isSeasonal: z.boolean().optional(),
  seasonalEvent: z.string().optional(),
});

export async function GET(request: NextRequest) {
  try {
    const supabase = createServerSupabaseClient();
    const userId = await getUserId();
    
    const searchParams = request.nextUrl.searchParams;
    const status = searchParams.get('status');
    
    let query = supabase
      .from('ad_campaigns')
      .select(`
        *,
        ad_groups (
          id,
          name,
          status,
          total_spend,
          impressions,
          clicks
        )
      `)
      .eq('user_id', userId)
      .order('created_at', { ascending: false });
    
    if (status) {
      query = query.eq('status', status);
    }
    
    const { data, error } = await query;
    
    if (error) {
      return NextResponse.json({ error: error.message }, { status: 500 });
    }
    
    return NextResponse.json({ campaigns: data });
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal error' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const userId = await getUserId();
    const body = await request.json();
    
    const data = createSchema.parse(body);
    const result = await createCampaign(userId, data);
    
    if (!result.success) {
      return NextResponse.json({ error: result.error }, { status: 400 });
    }
    
    return NextResponse.json({
      success: true,
      campaign: result.campaign,
    });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: 'Invalid request body', details: error.errors }, { status: 400 });
    }
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal error' },
      { status: 500 }
    );
  }
}
```

### `app/api/ads/campaigns/[id]/status/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { getUserId } from '@/lib/auth/session';
import { updateCampaignStatus } from '@/lib/pinterest/ads-service';

const statusSchema = z.object({
  status: z.enum(['ACTIVE', 'PAUSED']),
});

export async function PATCH(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const userId = await getUserId();
    const body = await request.json();
    
    const { status } = statusSchema.parse(body);
    const result = await updateCampaignStatus(userId, params.id, status);
    
    if (!result.success) {
      return NextResponse.json({ error: result.error }, { status: 400 });
    }
    
    return NextResponse.json({
      success: true,
      campaign: result.campaign,
    });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: 'Invalid request body' }, { status: 400 });
    }
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal error' },
      { status: 500 }
    );
  }
}
```

### `app/api/ads/budget/route.ts`
```typescript
import { NextResponse } from 'next/server';
import { getUserId } from '@/lib/auth/session';
import { checkAdSpendBudget, syncAdSpend } from '@/lib/pinterest/ads-service';

export async function GET() {
  try {
    const userId = await getUserId();
    const budgetStatus = await checkAdSpendBudget(userId, 0);
    
    return NextResponse.json(budgetStatus);
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal error' },
      { status: 500 }
    );
  }
}

export async function POST() {
  try {
    const userId = await getUserId();
    const result = await syncAdSpend(userId);
    
    if (!result.success) {
      return NextResponse.json({ error: result.error }, { status: 500 });
    }
    
    return NextResponse.json({ success: true });
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Internal error' },
      { status: 500 }
    );
  }
}
```

- **Step Dependencies**: Step 13.2
- **User Instructions**: None

---

**Part 8 Summary**

This part covers:

**Phase 11 (Pinterest Core):**
- Complete Pinterest database schema (boards, pins, schedules, copy templates)
- Pin schedule slots with optimal posting times
- Copy template system with variable substitution for A/B testing
- Pin publishing service with rate limiting
- Schedule management with guardrail-aware slot allocation
- Pins API endpoints (CRUD, publish, schedule)
- Boards API with collection assignment

**Phase 12 (Pinterest Analytics):**
- Analytics sync service fetching Pinterest metrics
- Performance tier calculation (top, good, average, underperformer)
- Copy template performance aggregation
- Analytics dashboard with overview metrics
- Top pins table with engagement tracking
- Performance trend identification

**Phase 13 (Pinterest Ads):**
- Complete ads database schema (accounts, campaigns, ad groups, promoted pins)
- Ad spend tracking table for guardrail enforcement
- Budget check function respecting weekly/monthly caps
- Campaign creation service with Pinterest API integration
- Campaign status management with budget validation
- Ad spend sync and warning system
- Ads API endpoints (campaigns CRUD, status, budget)

---

**Remaining phases to cover:**
- **Part 9:** Phase 14-16 (Lead Capture, Quiz, Abandonment)
- **Part 10:** Phase 17-19 (Customer Journey, Win-Back, Loyalty)
- **Part 11:** Phase 20-23 (Attribution, Campaigns, Intelligence, Daily Digest)
