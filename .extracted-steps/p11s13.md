## Step 24.3: Implement Rate Limiting & Security

- **Task**: Add rate limiting, security headers, and input validation.

- **Files**:

### `lib/rate-limit.ts`
```typescript
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

// Create rate limiter instances
const redis = Redis.fromEnv();

// General API rate limit: 100 requests per 10 seconds
export const apiRateLimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(100, '10 s'),
  analytics: true,
  prefix: 'ratelimit:api',
});

// Auth rate limit: 5 attempts per minute
export const authRateLimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(5, '1 m'),
  analytics: true,
  prefix: 'ratelimit:auth',
});

// Webhook rate limit: 1000 per minute
export const webhookRateLimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(1000, '1 m'),
  analytics: true,
  prefix: 'ratelimit:webhook',
});

// Public form submissions: 10 per minute per IP
export const formRateLimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(10, '1 m'),
  analytics: true,
  prefix: 'ratelimit:form',
});

export async function checkRateLimit(
  limiter: Ratelimit,
  identifier: string
): Promise<{ success: boolean; limit: number; remaining: number; reset: number }> {
  const result = await limiter.limit(identifier);
  
  return {
    success: result.success,
    limit: result.limit,
    remaining: result.remaining,
    reset: result.reset,
  };
}
```

### `middleware.ts`
```typescript
import { NextResponse, type NextRequest } from 'next/server';
import { createClient } from '@/lib/supabase/middleware';

export async function middleware(request: NextRequest) {
  const response = NextResponse.next();

  // Security headers
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  response.headers.set('X-XSS-Protection', '1; mode=block');
  response.headers.set(
    'Permissions-Policy',
    'camera=(), microphone=(), geolocation=()'
  );

  // CSP for production
  if (process.env.NODE_ENV === 'production') {
    response.headers.set(
      'Content-Security-Policy',
      [
        "default-src 'self'",
        "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net",
        "style-src 'self' 'unsafe-inline'",
        "img-src 'self' data: https: blob:",
        "font-src 'self' data:",
        "connect-src 'self' https://*.supabase.co https://api.klaviyo.com https://api.pinterest.com",
        "frame-ancestors 'none'",
      ].join('; ')
    );
  }

  // Protected routes
  if (request.nextUrl.pathname.startsWith('/dashboard')) {
    const { supabase, response: supabaseResponse } = createClient(request);
    
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      const redirectUrl = new URL('/login', request.url);
      redirectUrl.searchParams.set('redirect', request.nextUrl.pathname);
      return NextResponse.redirect(redirectUrl);
    }

    return supabaseResponse;
  }

  // API rate limiting headers
  if (request.nextUrl.pathname.startsWith('/api/')) {
    // Rate limit info would be added by the API route itself
    response.headers.set('X-RateLimit-Policy', 'sliding-window');
  }

  return response;
}

export const config = {
  matcher: [
    '/dashboard/:path*',
    '/api/:path*',
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
};
```

### `lib/validation/schemas.ts`
```typescript
import { z } from 'zod';

// Common schemas
export const emailSchema = z.string().email('Invalid email address');

export const urlSchema = z.string().url('Invalid URL');

export const uuidSchema = z.string().uuid('Invalid ID format');

// API input schemas
export const paginationSchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  limit: z.coerce.number().int().positive().max(100).default(20),
});

export const dateRangeSchema = z.object({
  startDate: z.string().datetime().optional(),
  endDate: z.string().datetime().optional(),
}).refine(
  (data) => {
    if (data.startDate && data.endDate) {
      return new Date(data.startDate) <= new Date(data.endDate);
    }
    return true;
  },
  { message: 'Start date must be before end date' }
);

// Lead schemas
export const createLeadSchema = z.object({
  email: emailSchema,
  firstName: z.string().max(100).optional(),
  lastName: z.string().max(100).optional(),
  source: z.string().max(50).optional(),
  utmSource: z.string().max(100).optional(),
  utmMedium: z.string().max(100).optional(),
  utmCampaign: z.string().max(100).optional(),
});

// Pin schemas
export const createPinSchema = z.object({
  title: z.string().min(1).max(100),
  description: z.string().max(500).optional(),
  link: urlSchema,
  boardId: uuidSchema,
  imageUrl: urlSchema.optional(),
  scheduledAt: z.string().datetime().optional(),
});

// Coupon schemas
export const createCouponSchema = z.object({
  code: z.string().min(3).max(20).regex(/^[A-Z0-9]+$/, 'Code must be alphanumeric'),
  discountType: z.enum(['percentage', 'fixed_amount', 'free_shipping', 'buy_x_get_y']),
  discountValue: z.number().positive().optional(),
  usageLimit: z.number().int().positive().optional(),
  perCustomerLimit: z.number().int().positive().default(1),
  minimumPurchase: z.number().positive().optional(),
  startsAt: z.string().datetime().optional(),
  expiresAt: z.string().datetime().optional(),
});

// Popup schemas
export const createPopupSchema = z.object({
  name: z.string().min(1).max(100),
  triggerType: z.enum(['exit_intent', 'scroll_depth', 'time_on_page', 'page_views', 'click', 'manual']),
  triggerConfig: z.record(z.any()).optional(),
  content: z.object({
    type: z.enum(['email_capture', 'announcement', 'discount', 'quiz_cta']),
    headline: z.string().max(100).optional(),
    body: z.string().max(500).optional(),
    ctaText: z.string().max(50).optional(),
    ctaLink: urlSchema.optional(),
  }),
  position: z.enum(['center', 'top', 'bottom', 'top_left', 'top_right', 'bottom_left', 'bottom_right']).default('center'),
});

// Validate helper
export function validateInput<T>(schema: z.Schema<T>, data: unknown): { success: true; data: T } | { success: false; errors: string[] } {
  const result = schema.safeParse(data);
  
  if (result.success) {
    return { success: true, data: result.data };
  }
  
  return {
    success: false,
    errors: result.error.errors.map(e => `${e.path.join('.')}: ${e.message}`),
  };
}
```

- **Step Dependencies**: Step 24.2
- **User Instructions**: 
  - Install: `npm install @upstash/ratelimit @upstash/redis zod`
  - Set environment variables: `UPSTASH_REDIS_REST_URL`, `UPSTASH_REDIS_REST_TOKEN`

---

