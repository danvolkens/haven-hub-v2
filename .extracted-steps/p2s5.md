## Step 2.2: Create Core Database Schema - Activity Log

- **Task**: Create the activity_log table for tracking all automated actions and mode changes per Feature 1 audit requirements.

- **Files**:

### `supabase/migrations/002_activity_log.sql`
```sql
-- ============================================================================
-- Migration: 002_activity_log
-- Description: Activity log for audit trail of all automated actions
-- Feature: 1 (Operator Mode System - Audit Trail)
-- ============================================================================

-- ============================================================================
-- Activity Log Table
-- ============================================================================
CREATE TABLE activity_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Action classification
  action_type TEXT NOT NULL,
  module TEXT,
  
  -- Action details (varies by action_type)
  details JSONB NOT NULL DEFAULT '{}',
  
  -- Whether action was actually executed or just logged
  -- In Supervised mode, actions are logged but executed = false until approved
  executed BOOLEAN NOT NULL DEFAULT false,
  
  -- What operator mode was active when this action occurred
  operator_mode TEXT NOT NULL CHECK (operator_mode IN ('supervised', 'assisted', 'autopilot')),
  
  -- For configuration changes, track old/new values
  previous_value JSONB,
  new_value JSONB,
  
  -- Reference to related entities (optional)
  reference_id UUID,
  reference_table TEXT,
  
  -- Timestamp (append-only, no updated_at needed)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes for efficient querying
-- ============================================================================

-- Primary query pattern: user's recent activity
CREATE INDEX idx_activity_log_user_created 
  ON activity_log(user_id, created_at DESC);

-- Filter by action type
CREATE INDEX idx_activity_log_action_type
  ON activity_log(user_id, action_type, created_at DESC);

-- Filter by module
CREATE INDEX idx_activity_log_module
  ON activity_log(user_id, module, created_at DESC)
  WHERE module IS NOT NULL;

-- Filter by execution status
CREATE INDEX idx_activity_log_executed
  ON activity_log(user_id, executed, created_at DESC);

-- Find by reference
CREATE INDEX idx_activity_log_reference
  ON activity_log(reference_id, reference_table)
  WHERE reference_id IS NOT NULL;

-- Time-based partitioning hint (for future optimization)
CREATE INDEX idx_activity_log_created_at
  ON activity_log(created_at DESC);

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE activity_log ENABLE ROW LEVEL SECURITY;

-- Users can only view their own activity
CREATE POLICY activity_log_select ON activity_log
  FOR SELECT USING (user_id = auth.uid());

-- Users can insert their own activity (service role can insert for any user)
CREATE POLICY activity_log_insert ON activity_log
  FOR INSERT WITH CHECK (user_id = auth.uid());

-- No update policy - audit log is append-only
-- No delete policy - audit log is immutable

-- ============================================================================
-- Valid action types (for reference, not enforced in DB for flexibility)
-- ============================================================================
COMMENT ON COLUMN activity_log.action_type IS '
Valid action types:
- mode_change: Operator mode changed
- guardrail_update: Guardrail setting changed
- asset_generated: Design engine created asset
- asset_approved: Asset approved from queue
- asset_rejected: Asset rejected from queue
- pin_scheduled: Pin added to schedule
- pin_published: Pin published to Pinterest
- pin_failed: Pin publish failed
- mockup_generated: Mockup created via Dynamic Mockups
- mockup_credits_reserved: Mockup credits reserved
- product_created: Shopify product created
- product_published: Shopify product published
- product_retired: Underperformer retired
- ad_campaign_created: Pinterest ad created
- ad_campaign_paused: Pinterest ad paused
- ad_budget_warning: Ad spend approaching limit
- winner_variation_created: Winner refresh generated variation
- sequence_triggered: Klaviyo sequence triggered
- alert_created: Performance alert created
- alert_sent: Alert notification sent
- integration_connected: Integration OAuth completed
- integration_disconnected: Integration disconnected
- export_created: Data export generated
- retry_queued: Failed operation queued for retry
- retry_resolved: Retried operation succeeded
- retry_failed: Retried operation permanently failed
';

-- ============================================================================
-- Helper function to log activity
-- ============================================================================
CREATE OR REPLACE FUNCTION log_activity(
  p_user_id UUID,
  p_action_type TEXT,
  p_details JSONB DEFAULT '{}',
  p_executed BOOLEAN DEFAULT false,
  p_module TEXT DEFAULT NULL,
  p_previous_value JSONB DEFAULT NULL,
  p_new_value JSONB DEFAULT NULL,
  p_reference_id UUID DEFAULT NULL,
  p_reference_table TEXT DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  v_mode TEXT;
  v_log_id UUID;
BEGIN
  -- Get current operator mode
  SELECT global_mode INTO v_mode
  FROM user_settings
  WHERE user_id = p_user_id;
  
  -- Default to supervised if settings don't exist yet
  v_mode := COALESCE(v_mode, 'supervised');
  
  -- Insert log entry
  INSERT INTO activity_log (
    user_id,
    action_type,
    module,
    details,
    executed,
    operator_mode,
    previous_value,
    new_value,
    reference_id,
    reference_table
  ) VALUES (
    p_user_id,
    p_action_type,
    p_module,
    p_details,
    p_executed,
    v_mode,
    p_previous_value,
    p_new_value,
    p_reference_id,
    p_reference_table
  )
  RETURNING id INTO v_log_id;
  
  RETURN v_log_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### `types/activity.ts`
```typescript
// Action type definitions for type-safe activity logging

export type ActionType =
  // Mode & Settings
  | 'mode_change'
  | 'guardrail_update'
  // Design Engine
  | 'asset_generated'
  | 'asset_approved'
  | 'asset_rejected'
  // Pinterest
  | 'pin_scheduled'
  | 'pin_published'
  | 'pin_failed'
  // Mockups
  | 'mockup_generated'
  | 'mockup_credits_reserved'
  // Products
  | 'product_created'
  | 'product_published'
  | 'product_retired'
  // Ads
  | 'ad_campaign_created'
  | 'ad_campaign_paused'
  | 'ad_budget_warning'
  // Analytics
  | 'winner_variation_created'
  // Customer Journey
  | 'sequence_triggered'
  // Alerts
  | 'alert_created'
  | 'alert_sent'
  // Integrations
  | 'integration_connected'
  | 'integration_disconnected'
  // Export
  | 'export_created'
  // Retry
  | 'retry_queued'
  | 'retry_resolved'
  | 'retry_failed';

export type Module =
  | 'pinterest'
  | 'design_engine'
  | 'mockups'
  | 'ads'
  | 'products'
  | 'ugc'
  | 'quiz'
  | 'leads'
  | 'customers'
  | 'campaigns'
  | 'settings';

// Type-safe detail structures for each action type
export interface ModeChangeDetails {
  from: string;
  to: string;
  gracePeriodUsed: boolean;
  pendingOperationsCount?: number;
}

export interface GuardrailUpdateDetails {
  guardrailKey: string;
  from: number | null;
  to: number | null;
}

export interface AssetGeneratedDetails {
  quoteId: string;
  assetCount: number;
  formats: string[];
  qualityScores: Record<string, number>;
  autoApproved: boolean;
}

export interface AssetApprovedDetails {
  assetId: string;
  quoteId: string;
  format: string;
}

export interface PinScheduledDetails {
  pinId: string;
  boardId: string;
  boardName: string;
  scheduledTime: string;
  copyVariantUsed?: string;
}

export interface PinPublishedDetails {
  pinId: string;
  pinterestPinId: string;
  boardId: string;
}

export interface PinFailedDetails {
  pinId: string;
  error: string;
  retryQueued: boolean;
}

export interface MockupGeneratedDetails {
  mockupId: string;
  quoteId: string;
  scene: string;
  creditsUsed: number;
}

export interface ProductCreatedDetails {
  productId: string;
  shopifyProductId: string;
  quoteId: string;
  collection: string;
  status: 'draft' | 'active';
}

export interface SequenceTriggeredDetails {
  sequenceType: 'quiz_completion' | 'cart_abandonment' | 'post_purchase' | 'win_back' | 'lead_nurturing';
  customerId?: string;
  email: string;
  klaviyoFlowId: string;
}

export interface AlertCreatedDetails {
  alertType: string;
  threshold: string;
  currentValue: number;
  entityId?: string;
  entityType?: string;
}

export interface ActivityLog {
  id: string;
  user_id: string;
  action_type: ActionType;
  module: Module | null;
  details: Record<string, unknown>;
  executed: boolean;
  operator_mode: string;
  previous_value: Record<string, unknown> | null;
  new_value: Record<string, unknown> | null;
  reference_id: string | null;
  reference_table: string | null;
  created_at: string;
}
```

- **Step Dependencies**: Step 2.1
- **User Instructions**: Run `npx supabase db push` or apply migration via SQL Editor

---

