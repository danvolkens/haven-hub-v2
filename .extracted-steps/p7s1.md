## Step 9.1: Create Mockups Database Schema

- **Task**: Create the database schema for mockup tracking, credits, and scene configurations.

- **Files**:

### `supabase/migrations/007_mockups.sql`
```sql
-- ============================================================================
-- Migration: 007_mockups
-- Description: Mockups table and credit tracking
-- Feature: 9 (Dynamic Mockups Integration)
-- ============================================================================

-- ============================================================================
-- Mockups Table
-- ============================================================================
CREATE TABLE mockups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  asset_id UUID REFERENCES assets(id) ON DELETE CASCADE NOT NULL,
  quote_id UUID REFERENCES quotes(id) ON DELETE SET NULL,
  
  -- Scene configuration
  scene TEXT NOT NULL,
  scene_config JSONB NOT NULL DEFAULT '{}',
  -- { template_id, placement, size, rotation, etc. }
  
  -- Generated files
  file_url TEXT NOT NULL,
  file_key TEXT NOT NULL,
  thumbnail_url TEXT,
  
  -- Dynamic Mockups API response
  dm_render_id TEXT, -- Dynamic Mockups render ID
  dm_metadata JSONB DEFAULT '{}',
  
  -- Credits
  credits_used INTEGER NOT NULL DEFAULT 1,
  
  -- Quality/Status
  quality_score NUMERIC(4,3),
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN (
    'pending', 'generating', 'completed', 'failed', 'approved', 'rejected'
  )),
  error_message TEXT,
  
  -- Performance (when used in pins)
  total_pins INTEGER NOT NULL DEFAULT 0,
  total_impressions INTEGER NOT NULL DEFAULT 0,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================
CREATE INDEX idx_mockups_user ON mockups(user_id);
CREATE INDEX idx_mockups_asset ON mockups(asset_id);
CREATE INDEX idx_mockups_quote ON mockups(quote_id) WHERE quote_id IS NOT NULL;
CREATE INDEX idx_mockups_scene ON mockups(user_id, scene);
CREATE INDEX idx_mockups_status ON mockups(user_id, status);
CREATE INDEX idx_mockups_pending ON mockups(user_id, created_at) WHERE status = 'pending';

-- ============================================================================
-- Row Level Security
-- ============================================================================
ALTER TABLE mockups ENABLE ROW LEVEL SECURITY;

CREATE POLICY mockups_select ON mockups FOR SELECT USING (user_id = auth.uid());
CREATE POLICY mockups_insert ON mockups FOR INSERT WITH CHECK (user_id = auth.uid());
CREATE POLICY mockups_update ON mockups FOR UPDATE USING (user_id = auth.uid());
CREATE POLICY mockups_delete ON mockups FOR DELETE USING (user_id = auth.uid());

CREATE TRIGGER mockups_updated_at
  BEFORE UPDATE ON mockups
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- Mockup Credit Usage Table (for tracking and reporting)
-- ============================================================================
CREATE TABLE mockup_credit_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  mockup_id UUID REFERENCES mockups(id) ON DELETE SET NULL,
  
  -- Usage details
  credits INTEGER NOT NULL,
  operation TEXT NOT NULL, -- 'generation', 'regeneration', 'refund'
  
  -- Balance tracking
  balance_before INTEGER NOT NULL,
  balance_after INTEGER NOT NULL,
  
  -- Annual budget tracking
  year INTEGER NOT NULL DEFAULT EXTRACT(YEAR FROM NOW()),
  month INTEGER NOT NULL DEFAULT EXTRACT(MONTH FROM NOW()),
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_credit_usage_user ON mockup_credit_usage(user_id);
CREATE INDEX idx_credit_usage_year ON mockup_credit_usage(user_id, year);
CREATE INDEX idx_credit_usage_month ON mockup_credit_usage(user_id, year, month);

ALTER TABLE mockup_credit_usage ENABLE ROW LEVEL SECURITY;

CREATE POLICY credit_usage_select ON mockup_credit_usage 
  FOR SELECT USING (user_id = auth.uid());
CREATE POLICY credit_usage_insert ON mockup_credit_usage 
  FOR INSERT WITH CHECK (user_id = auth.uid());

-- ============================================================================
-- Scene Templates Table
-- ============================================================================
CREATE TABLE mockup_scene_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- Scene identification
  scene_key TEXT NOT NULL, -- 'bedroom', 'therapy_office', etc.
  name TEXT NOT NULL,
  description TEXT,
  
  -- Dynamic Mockups template reference
  dm_template_id TEXT NOT NULL,
  dm_template_url TEXT,
  
  -- Configuration
  config JSONB NOT NULL DEFAULT '{}',
  -- { smart_object_name, default_size, default_position, etc. }
  
  -- Preview image
  preview_url TEXT,
  
  -- Availability
  is_active BOOLEAN NOT NULL DEFAULT true,
  is_system BOOLEAN NOT NULL DEFAULT false, -- true for built-in scenes
  
  -- Collections this scene works well with
  recommended_collections TEXT[] DEFAULT '{}',
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- System scenes are global, user scenes are per-user
CREATE UNIQUE INDEX idx_scene_templates_key 
  ON mockup_scene_templates(scene_key) 
  WHERE user_id IS NULL AND is_system = true;

CREATE INDEX idx_scene_templates_user 
  ON mockup_scene_templates(user_id) 
  WHERE user_id IS NOT NULL;

ALTER TABLE mockup_scene_templates ENABLE ROW LEVEL SECURITY;

-- Users can see system templates and their own
CREATE POLICY scene_templates_select ON mockup_scene_templates 
  FOR SELECT USING (is_system = true OR user_id = auth.uid());

CREATE POLICY scene_templates_insert ON mockup_scene_templates 
  FOR INSERT WITH CHECK (user_id = auth.uid() AND is_system = false);

CREATE POLICY scene_templates_update ON mockup_scene_templates 
  FOR UPDATE USING (user_id = auth.uid() AND is_system = false);

CREATE POLICY scene_templates_delete ON mockup_scene_templates 
  FOR DELETE USING (user_id = auth.uid() AND is_system = false);

-- ============================================================================
-- Function: Get credit usage for period
-- ============================================================================
CREATE OR REPLACE FUNCTION get_credit_usage(
  p_user_id UUID,
  p_year INTEGER DEFAULT EXTRACT(YEAR FROM NOW()),
  p_month INTEGER DEFAULT NULL
)
RETURNS TABLE (
  total_used INTEGER,
  monthly_used INTEGER,
  annual_budget INTEGER,
  monthly_soft_limit INTEGER,
  remaining_annual INTEGER,
  remaining_monthly INTEGER
) AS $$
DECLARE
  v_annual_budget INTEGER;
  v_monthly_limit INTEGER;
  v_total_used INTEGER;
  v_monthly_used INTEGER;
BEGIN
  -- Get guardrails
  SELECT 
    (guardrails->>'annual_mockup_budget')::INTEGER,
    (guardrails->>'monthly_mockup_soft_limit')::INTEGER
  INTO v_annual_budget, v_monthly_limit
  FROM user_settings
  WHERE user_id = p_user_id;
  
  -- Default values
  v_annual_budget := COALESCE(v_annual_budget, 3500);
  v_monthly_limit := COALESCE(v_monthly_limit, 292);
  
  -- Get annual usage
  SELECT COALESCE(SUM(credits), 0)
  INTO v_total_used
  FROM mockup_credit_usage
  WHERE user_id = p_user_id
    AND year = p_year
    AND operation = 'generation';
  
  -- Get monthly usage
  SELECT COALESCE(SUM(credits), 0)
  INTO v_monthly_used
  FROM mockup_credit_usage
  WHERE user_id = p_user_id
    AND year = p_year
    AND month = COALESCE(p_month, EXTRACT(MONTH FROM NOW()))
    AND operation = 'generation';
  
  RETURN QUERY SELECT
    v_total_used,
    v_monthly_used,
    v_annual_budget,
    v_monthly_limit,
    GREATEST(v_annual_budget - v_total_used, 0),
    GREATEST(v_monthly_limit - v_monthly_used, 0);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- Function: Reserve credits before generation
-- ============================================================================
CREATE OR REPLACE FUNCTION reserve_mockup_credits(
  p_user_id UUID,
  p_credits INTEGER
)
RETURNS TABLE (
  success BOOLEAN,
  remaining INTEGER,
  message TEXT
) AS $$
DECLARE
  v_annual_budget INTEGER;
  v_used INTEGER;
  v_remaining INTEGER;
BEGIN
  -- Get budget and usage
  SELECT 
    (guardrails->>'annual_mockup_budget')::INTEGER
  INTO v_annual_budget
  FROM user_settings
  WHERE user_id = p_user_id;
  
  v_annual_budget := COALESCE(v_annual_budget, 3500);
  
  SELECT COALESCE(SUM(credits), 0)
  INTO v_used
  FROM mockup_credit_usage
  WHERE user_id = p_user_id
    AND year = EXTRACT(YEAR FROM NOW())
    AND operation = 'generation';
  
  v_remaining := v_annual_budget - v_used;
  
  IF v_remaining < p_credits THEN
    RETURN QUERY SELECT 
      false, 
      v_remaining,
      'Insufficient credits. ' || v_remaining || ' remaining.';
    RETURN;
  END IF;
  
  RETURN QUERY SELECT 
    true, 
    v_remaining - p_credits,
    'Credits reserved successfully.';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- Insert system scene templates
-- ============================================================================
INSERT INTO mockup_scene_templates (scene_key, name, description, dm_template_id, is_system, recommended_collections, config)
VALUES
  ('bedroom', 'Bedroom', 'Cozy bedroom setting with natural light', 'dm_bedroom_001', true, ARRAY['grounding', 'wholeness'], 
   '{"smart_object": "artwork_frame", "default_size": {"width": 800, "height": 1000}}'),
  ('therapy_office', 'Therapy Office', 'Professional office with warm tones', 'dm_therapy_001', true, ARRAY['wholeness', 'growth'],
   '{"smart_object": "wall_art", "default_size": {"width": 600, "height": 800}}'),
  ('living_room', 'Living Room', 'Modern living space with natural elements', 'dm_living_001', true, ARRAY['grounding', 'growth'],
   '{"smart_object": "frame_display", "default_size": {"width": 900, "height": 1200}}'),
  ('reading_nook', 'Reading Nook', 'Intimate corner with soft lighting', 'dm_reading_001', true, ARRAY['grounding', 'wholeness'],
   '{"smart_object": "small_frame", "default_size": {"width": 500, "height": 700}}'),
  ('home_office', 'Home Office', 'Productive workspace with inspiring decor', 'dm_office_001', true, ARRAY['growth'],
   '{"smart_object": "desk_frame", "default_size": {"width": 600, "height": 800}}')
ON CONFLICT DO NOTHING;
```

### `types/mockups.ts`
```typescript
export interface Mockup {
  id: string;
  user_id: string;
  asset_id: string;
  quote_id: string | null;
  scene: string;
  scene_config: SceneConfig;
  file_url: string;
  file_key: string;
  thumbnail_url: string | null;
  dm_render_id: string | null;
  dm_metadata: Record<string, unknown>;
  credits_used: number;
  quality_score: number | null;
  status: MockupStatus;
  error_message: string | null;
  total_pins: number;
  total_impressions: number;
  created_at: string;
  updated_at: string;
}

export type MockupStatus = 
  | 'pending' 
  | 'generating' 
  | 'completed' 
  | 'failed' 
  | 'approved' 
  | 'rejected';

export interface SceneConfig {
  smart_object?: string;
  default_size?: { width: number; height: number };
  position?: { x: number; y: number };
  rotation?: number;
  scale?: number;
}

export interface MockupSceneTemplate {
  id: string;
  user_id: string | null;
  scene_key: string;
  name: string;
  description: string | null;
  dm_template_id: string;
  dm_template_url: string | null;
  config: SceneConfig;
  preview_url: string | null;
  is_active: boolean;
  is_system: boolean;
  recommended_collections: string[];
  created_at: string;
  updated_at: string;
}

export interface CreditUsage {
  total_used: number;
  monthly_used: number;
  annual_budget: number;
  monthly_soft_limit: number;
  remaining_annual: number;
  remaining_monthly: number;
}

export interface MockupGenerationRequest {
  assetIds: string[];
  scenes: string[];
  skipApproval?: boolean;
}

export interface MockupGenerationResult {
  mockupId: string;
  assetId: string;
  scene: string;
  status: 'success' | 'failed';
  url?: string;
  error?: string;
  creditsUsed: number;
}
```

- **Step Dependencies**: Step 7.1
- **User Instructions**: Run migration

---

